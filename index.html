<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KTV æ­Œæˆ° V61 - å®Œæ•´ä¿®æ­£ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-database-compat.js"></script>
    <style>
        :root { 
            --ur-clr: #ffff00; --ssr-clr: #ff00ff; --sr-clr: #00d2ff; --r-clr: #ffffff;
            --accent: #e91e63; --bg-dark: #0a0a0c; 
            --male-clr: #4fc3f7; --female-clr: #ff8a80; --group-clr: #aed581;
        }
        body { 
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; 
            background: radial-gradient(circle at top, #1a1a2e, var(--bg-dark)); 
            color: white; margin: 0; text-align: center; min-height: 100vh; padding-bottom: 80px;
        }
        .header { 
            background: rgba(10, 10, 12, 0.95); backdrop-filter: blur(10px);
            padding: 10px 20px; border-bottom: 1px solid rgba(233, 30, 99, 0.3);
            position: sticky; top: 0; z-index: 100;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .opp-list { display: flex; gap: 10px; overflow-x: auto; padding: 5px 0; font-size: 11px; border-top: 1px solid #222; margin-top: 5px; }
        .opp-item { background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 20px; white-space: nowrap; cursor: pointer; }
        .score { font-size: 28px; font-weight: 900; color: gold; text-shadow: 0 0 10px rgba(255,215,0,0.4); }
        
        .page { display: none; padding: 20px 15px; animation: fadeIn 0.3s ease-in; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes glowAnim { 
            0% { box-shadow: 0 0 5px #ffd700; transform: scale(1); } 
            50% { box-shadow: 0 0 25px #ffd700, 0 0 15px #ff9800; transform: scale(1.02); } 
            100% { box-shadow: 0 0 5px #ffd700; transform: scale(1); } 
        }

        .card-box { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 15px; margin-bottom: 20px; position: relative; }
        
        .scout-section { margin-bottom: 15px; background: rgba(0,0,0,0.4); border-radius: 12px; overflow: hidden; }
        .scout-header { padding: 8px; font-size: 14px; font-weight: bold; text-align: left; padding-left: 15px; }
        .scout-content { padding: 10px; display: flex; flex-wrap: wrap; gap: 8px; min-height: 40px; }
        
        button { padding: 12px 20px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; font-size: 15px; transition: 0.2s; color: white; }
        .btn-main { background: linear-gradient(45deg, #e91e63, #ff4081); width: 100%; margin: 8px 0; box-shadow: 0 4px 15px rgba(233,30,99,0.3); }
        .btn-sec { background: #333; width: 100%; margin: 5px 0; border: 1px solid #555; }
        .btn-challenge { background: linear-gradient(45deg, #f44336, #ff9800); width: 100%; height: 70px; font-size: 20px; margin: 15px 0; }
        .btn-counter { background: linear-gradient(45deg, #673ab7, #9c27b0); border: 1px solid gold; box-shadow: 0 0 15px rgba(255,215,0,0.3); width: 100%; margin-bottom: 5px;}
        .btn-disabled { background: #444 !important; color: #888 !important; cursor: not-allowed !important; box-shadow: none !important; border: 1px solid #555 !important; }
        
        /* V61: æ˜äº®çš„ç™¼å…‰æŒ‰éˆ• */
        .btn-glow {
            background: linear-gradient(45deg, #ffd700, #ffeb3b) !important;
            color: #000 !important;
            animation: glowAnim 1.5s infinite;
            border: 2px solid #fff !important;
            text-shadow: none !important;
            font-weight: 900;
        }

        .singer-tag { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 13px; background: rgba(255,255,255,0.1); border: 1px solid transparent; }
        
        .res-card { padding: 10px 5px; border-radius: 10px; border: 2px solid #444; background: #111; font-weight: bold; text-align: center; font-size: 12px; position: relative; cursor: pointer; min-height: 80px; display:flex; flex-direction:column; justify-content:center; align-items:center;}
        .UR { border-color: var(--ur-clr); color: var(--ur-clr); box-shadow: 0 0 10px rgba(255,255,0,0.2); }
        .SSR { border-color: var(--ssr-clr); color: var(--ssr-clr); }
        .SR { border-color: var(--sr-clr); color: var(--sr-clr); }
        .R { border-color: var(--r-clr); color: var(--r-clr); }

        /* Modal */
        #modal, #alert-modal, #spy-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; justify-content: center; align-items: center; z-index: 200; padding: 20px; }
        .modal-content { background: #161618; padding: 25px; border-radius: 20px; width: 95%; max-width: 400px; border: 1px solid #333; text-align: left; position: relative; max-height: 80vh; overflow-y: auto;}
        
        .toast { position: fixed; top: 15%; left: 50%; transform: translateX(-50%); background: rgba(20,20,20,0.95); border: 1px solid var(--accent); color: white; padding: 15px 25px; border-radius: 30px; z-index: 300; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.8); display:none; max-width: 90%; white-space: pre-wrap; font-weight: bold;}
        
        .entry-row { display: flex; gap: 5px; margin-bottom: 8px; justify-content: center; }
        .singer-in { width: 60%; background: #222; border: 1px solid #444; padding: 10px; border-radius: 8px; color: white; }
        .type-in { width: 30%; background: #222; border: 1px solid #444; border-radius: 8px; color: white; }
        
        .spy-data-box { background: #000; border: 1px solid #333; padding: 10px; margin-top: 10px; border-radius: 8px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 13px; color: #0f0; }
    </style>
</head>
<body>

<div id="toast" class="toast">
    <div id="toast-msg"></div>
</div>

<div class="header" id="ui-header" style="display:none;">
    <div class="header-top">
        <div><div id="display-name" style="color:var(--accent); font-weight:bold;"></div><div class="score" id="display-score">0</div></div>
        <div style="text-align: right;"><span style="font-size:10px; color:#555;">ROOM</span><br><b id="display-room"></b></div>
    </div>
    <div class="opp-list" id="opp-list-box"></div>
</div>

<div id="page-login" class="page active">
    <h1 style="font-size: 36px; color:var(--accent);">KTV æ­Œæˆ° V61</h1>
    <p style="color: #888; margin-bottom: 30px;">å®Œæ•´ä¿®æ­£ â€¢ äº’å‹•å¼·åŒ–ç‰ˆ</p>
    <input type="text" id="inName" placeholder="æš±ç¨±" style="width:80%; padding:15px; background:#111; border:1px solid #333; border-radius:10px; color:white; margin-bottom:10px;">
    <input type="text" id="inRoom" placeholder="æˆ¿è™Ÿ" style="width:80%; padding:15px; background:#111; border:1px solid #333; border-radius:10px; color:white; margin-bottom:20px;">
    <button class="btn-main" onclick="initGame()">é€²å…¥åŒ…å»‚</button>
</div>

<div id="page-home" class="page">
    <div class="card-box">
        <div style="display:flex; justify-content:space-between; font-size:14px; margin-bottom:10px;">
            <span>ğŸŒŸ ä¸åŒæ­Œæ‰‹æˆå°±</span>
            <span id="scout-count-text" style="color:gold;">0 / 10</span>
        </div>
        
        <div class="scout-section" style="border-left: 4px solid var(--male-clr);">
            <div class="scout-header" style="color:var(--male-clr); background:rgba(33, 150, 243, 0.1);">ğŸ‘¨â€ğŸ¤ ç”·æ­Œæ‰‹</div>
            <div id="list-male" class="scout-content"></div>
        </div>

        <div class="scout-section" style="border-left: 4px solid var(--female-clr);">
            <div class="scout-header" style="color:var(--female-clr); background:rgba(244, 67, 54, 0.1);">ğŸ‘©â€ğŸ¤ å¥³æ­Œæ‰‹</div>
            <div id="list-female" class="scout-content"></div>
        </div>

        <div class="scout-section" style="border-left: 4px solid var(--group-clr);">
            <div class="scout-header" style="color:var(--group-clr); background:rgba(76, 175, 80, 0.1);">ğŸ¤ åœ˜é«”</div>
            <div id="list-group" class="scout-content"></div>
        </div>

        <button id="scout-draw-btn" class="btn-main" style="background:#222; color:#555; margin-top:10px;" onclick="scoutDrawReward()" disabled>é ˜å–çå‹µ (10ä½ä¸åŒæ­Œæ‰‹)</button>
    </div>

    <button class="btn-challenge" onclick="prepareAndStartTask()">ğŸ¤ æŠ½å–æŒ‘æˆ°ä»»å‹™</button>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <button class="btn-sec" onclick="openCollection()">æˆ‘çš„å¡å†Š</button>
        <button class="btn-sec" onclick="location.reload()">åˆ‡æ›æˆ¿é–“</button>
        <button class="btn-sec" onclick="testGetAllCards()" style="grid-column: span 2; border-color: gold; color: gold;">[æ¸¬è©¦] ç²å¾—æ‰€æœ‰å¡ç‰‡</button>
    </div>
</div>

<div id="page-challenge" class="page">
    <div class="card-box" style="border-color: #ff9800;">
        <h3 style="margin:0 0 10px 0; color:#ff9800;">ç›®å‰æŒ‘æˆ°</h3>
        <div id="task-text" style="font-size:18px; color:#ddd; margin-bottom:10px;"></div>
        <div id="extra-box" style="font-size:24px; color:gold; font-weight:bold; margin-bottom:10px;"></div>
        <div id="task-reward" style="font-size:12px; color:#aaa;"></div>
    </div>
    
    <button class="btn-sec" style="background: #3f51b5; border:none;" onclick="openCollection(true)">ğŸƒ ä½¿ç”¨å¡ç‰‡ (åŠ å€/é‡æŠ½)</button>
    <button class="btn-main" style="background: #4caf50; margin-top:20px;" onclick="showPage('page-singer-entry')">âœ… æˆ‘å”±å®Œäº†ï¼</button>
    <button class="btn-sec" onclick="showPage('page-home')">è¿”å›é¦–é  (æ”¾æ£„)</button>
</div>

<div id="page-singer-entry" class="page">
    <h3>è¼¸å…¥æ¼”å”±è³‡è¨Š</h3>
    <div id="singer-inputs-container"></div>
    <button onclick="addInput()" class="btn-sec" style="font-size:12px;">ï¼‹ åˆå”±/å¤šä½æ­Œæ‰‹</button>
    
    <div style="margin-top:20px;">
        <p style="font-size:12px; color:#aaa;">é»æ“Šæ­·å²ç´€éŒ„å¿«é€Ÿè¼¸å…¥ï¼š</p>
        <div id="history-tags-container" style="display:flex; flex-wrap:wrap; gap:5px; max-height:100px; overflow-y:auto; justify-content:center;"></div>
    </div>

    <button class="btn-main" style="margin-top:30px;" onclick="saveSingersAndDraw()">ç¢ºèªä¸¦é ˜å¡</button>
    <button class="btn-sec" onclick="showPage('page-challenge')">è¿”å›</button>
</div>

<div id="page-machine" class="page">
    <h2 style="color:gold;">ç²å¾—å¡ç‰‡ï¼</h2>
    <div id="draw-result-list" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;"></div>
    <button class="btn-main" style="margin-top:20px;" onclick="showPage('page-home')">ç¢ºèª</button>
</div>

<div id="page-collection" class="page">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>æˆ‘çš„å¡å†Š</h2>
        <span id="card-count" style="font-size:12px; color:#aaa;"></span>
    </div>
    <div id="goblin-merge-area" style="display:none; margin-bottom:10px;">
        <button class="btn-main" style="background:#4caf50;" onclick="mergeGoblin()">ğŸŸ¢ åˆæˆå“¥å¸ƒæ— (5æ›1)</button>
    </div>
    <div id="coll-list" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding-bottom:30px;"></div>
    <button class="btn-main" style="background: #222;" onclick="backFromCollection()">è¿”å›</button>
</div>

<div id="modal" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between;">
            <h2 id="m-rarity" style="margin:0;"></h2>
            <span id="m-id" style="color:#666;"></span>
        </div>
        <h3 id="m-name" style="margin:10px 0; color:white;"></h3>
        <p id="m-desc" style="color:#aaa; white-space: pre-wrap; line-height:1.5; font-size:14px;"></p>
        
        <div id="target-select-area" style="display:none; margin:15px 0;">
            <p style="color:var(--accent); font-size:14px; margin-bottom:5px;">é¸æ“‡ç›®æ¨™ï¼š</p>
            <select id="target-dropdown" style="width:100%; padding:12px; border-radius:8px; background:#222; color:white; border:1px solid #444;"></select>
        </div>

        <div style="display:grid; gap:10px;">
            <button id="use-btn" class="btn-main">ç™¼å‹•æŠ€èƒ½</button>
            <button class="btn-sec" onclick="closeModal()">é—œé–‰</button>
        </div>
    </div>
</div>

<div id="alert-modal">
    <div class="modal-content">
        <h3 id="alert-title" style="color:gold;">æç¤º</h3>
        <p id="alert-msg" style="line-height:1.5; margin-bottom:20px;"></p>
        <div id="alert-actions" style="display:grid; gap:10px;"></div>
    </div>
</div>

<div id="spy-modal">
    <div class="modal-content">
        <h3 style="color:#00d2ff;">ğŸ•µï¸ åµæŸ¥å ±å‘Š</h3>
        <div id="spy-content" class="spy-data-box"></div>
        <button class="btn-main" style="margin-top:15px;" onclick="document.getElementById('spy-modal').style.display='none'">é—œé–‰</button>
    </div>
</div>

<script>
// ==================== è³‡æ–™åº« ====================
const ZHUYIN = ["ã„…ã„š","ã„…ã„›","ã„…ã„","ã„…ã„Ÿ","ã„…ã„ ","ã„…ã„¢","ã„…ã„£","ã„…ã„¤","ã„…ã„¥","ã„‰ã„š","ã„‰ã„œ","ã„‰ã„","ã„‰ã„Ÿ","ã„‰ã„ ","ã„‰ã„¡","ã„‰ã„¢","ã„‰ã„£","ã„‰ã„¤","ã„‰ã„¥","ã„ã„š","ã„ã„œ","ã„ã„","ã„ã„Ÿ","ã„ã„ ","ã„ã„¡","ã„ã„¢","ã„ã„£","ã„ã„¤","ã„ã„¥","ã„“ã„š","ã„“ã„œ","ã„“ã„","ã„“ã„ ","ã„“ã„¡","ã„“ã„¢","ã„“ã„£","ã„“ã„¤","ã„“ã„¥","ã„“","ã„—ã„š","ã„—ã„œ","ã„—ã„","ã„—ã„Ÿ","ã„—ã„ ","ã„—ã„¡","ã„—ã„¢","ã„—ã„£","ã„—ã„¤","ã„—ã„¥","ã„—","ã„š","ã„›","ã„œ","ã„","ã„","ã„Ÿ","ã„ ","ã„¡","ã„¢","ã„£","ã„¤","ã„¥","ã„¦","ã„…ã„§","ã„…ã„§ã„","ã„…ã„§ã„ ","ã„…ã„§ã„¢","ã„…ã„§ã„£","ã„…ã„§ã„¥","ã„‰ã„§","ã„‰ã„§ã„","ã„‰ã„§ã„ ","ã„‰ã„§ã„¡","ã„‰ã„§ã„¢","ã„‰ã„§ã„¥","ã„ã„§","ã„ã„§ã„š","ã„ã„§ã„","ã„ã„§ã„ ","ã„ã„§ã„¡","ã„ã„§ã„¢","ã„ã„§ã„£","ã„ã„§ã„¤","ã„ã„§ã„¥","ã„§","ã„§ã„š","ã„§ã„›","ã„§ã„","ã„§ã„","ã„§ã„ ","ã„§ã„¡","ã„§ã„¢","ã„§ã„£","ã„§ã„¤","ã„§ã„¥","ã„…ã„¨","ã„†ã„¨","ã„‡ã„¨","ã„ˆã„¨","ã„‰ã„¨","ã„‰ã„¨ã„›","ã„‰ã„¨ã„Ÿ","ã„‰ã„¨ã„¢","ã„‰ã„¨ã„£","ã„‰ã„¨ã„¥","ã„ã„¨","ã„ã„¨ã„š","ã„ã„¨ã„›","ã„ã„¨ã„","ã„ã„¨ã„Ÿ","ã„ã„¨ã„¢","ã„ã„¨ã„£","ã„ã„¨ã„¤","ã„“ã„¨","ã„“ã„¨ã„š","ã„“ã„¨ã„›","ã„“ã„¨ã„","ã„“ã„¨ã„Ÿ","ã„“ã„¨ã„¢","ã„“ã„¨ã„£","ã„“ã„¨ã„¤","ã„—ã„¨","ã„—ã„¨ã„›","ã„—ã„¨ã„Ÿ","ã„—ã„¨ã„¢","ã„—ã„¨ã„£","ã„¨","ã„¨ã„š","ã„¨ã„›","ã„¨ã„","ã„¨ã„Ÿ","ã„¨ã„¢","ã„¨ã„£","ã„¨ã„¤","ã„¨ã„¥","ã„‹ã„©","ã„‹ã„©ã„","ã„Œã„©","ã„Œã„©ã„","ã„ã„©","ã„ã„©ã„","ã„ã„©ã„¢","ã„ã„©ã„£","ã„ã„©ã„¥","ã„©","ã„©ã„","ã„©ã„¢","ã„©ã„£","ã„©ã„¥"];

const LYRICS_DB = [
    {s:"ä¸ƒé‡Œé¦™",l:"çª—å¤–çš„éº»é›€ åœ¨é›»ç·šæ¡¿ä¸Šå¤šå˜´"},{s:"è½åª½åª½çš„è©±",l:"å°æœ‹å‹ä½ æ˜¯å¦æœ‰å¾ˆå¤šå•è™Ÿ"},{s:"å‘Šç™½æ°£çƒ",l:"è¦ªæ„›çš„ æ„›ä¸Šä½  å¾é‚£å¤©èµ· ç”œèœœå¾—å¾ˆè¼•æ˜“"},{s:"å°å¹¸é‹",l:"é‡è¦‹å¦³æ˜¯æœ€ç¾éº—çš„æ„å¤–"},{s:"åå¹´",l:"å¦‚æœé‚£å…©å€‹å­—æ²’æœ‰é¡«æŠ– æˆ‘ä¸æœƒç™¼ç¾æˆ‘é›£å—"},{s:"æƒ…éå¾—å·²",l:"é›£ä»¥å¿˜è¨˜åˆæ¬¡è¦‹ä½  ä¸€é›™è¿·äººçš„çœ¼ç›"},{s:"æ³¡æ²«",l:"é™½å…‰ä¸‹çš„å½©è™¹ æ˜¯è‰²å½©ç¹½ç´›çš„"},{s:"é«”é¢",l:"åˆ†æ‰‹æ‡‰è©²ä¿æŒé¢¨åº¦ èª°éƒ½ä¸è¦èªªæŠ±æ­‰"},{s:"èªªè¬Š",l:"æˆ‘æ²’æœ‰é¨™äºº æˆ‘ä½•å¿…é¨™äºº"},{s:"å€’å¸¶",l:"çµ‚æ–¼çœ‹é–‹æ„›å›ä¸ä¾† è€Œä½ ç¸½æ˜¯å¤ªæ™šæ˜ç™½"},{s:"çŠç‘šæµ·",l:"æµ·é³¥è·Ÿé­šç›¸æ„› åªæ˜¯ä¸€å ´æ„å¤–"},{s:"ç°¡å–®æ„›",l:"æˆ‘æƒ³å¸¶ä½ é¨å–®è»Š æˆ‘æƒ³å’Œä½ çœ‹æ£’çƒ"},{s:"æ¸©æŸ”",l:"ç„¶å¾Œå‘¢ ä»–å€‘èªªä½ çš„å¿ƒ ä¼¼ä¹ç—Šç™’äº†"},{s:"å€”å¼·",l:"æˆ‘å’Œæˆ‘æœ€å¾Œçš„åŸ·è‘— æ¡ç·Šé›™æ‰‹çµ•å°ä¸æ”¾"},{s:"æˆ‘ä¸é¡˜è®“ä½ ä¸€å€‹äºº",l:"ä½ èªªé å¦‚æœæˆ‘ä¸åœ¨èº«é‚Š ä¹Ÿè¦åŠªåŠ›ç”Ÿæ´»"},{s:"ä¿®ç…‰æ„›æƒ…",l:"é€™æ„Ÿæƒ…çš„å¿ƒé…¸ å­¸æœƒæ”¾é€ç·´ç¿’"},{s:"é‚£äº›å¹´",l:"åˆå›åˆ°æœ€åˆçš„èµ·é» å‘†å‘†åœ°ç«™åœ¨é¡å­å‰"},{s:"ç´…è±†",l:"æœ‰æ™‚å€™ æœ‰æ™‚å€™ æˆ‘æœƒç›¸ä¿¡ä¸€åˆ‡æœ‰ç›¡é ­"},{s:"å®¶å¾Œ",l:"æœ‰ä¸€æ—¥å’±è‹¥è€ æ‰¾ç„¡äººæ¹Šå™´å¨"},{s:"å¦‚æœå¯ä»¥",l:"æˆ‘æƒ³å’Œä½ å›åˆ°é‚£å¤©ç›¸é‡ å‡å¦‚å‘½é‹é‡å¯«"},{s:"å¸¶æˆ‘èµ°",l:"åˆ°é™é çš„ä»¥å¾Œ ä»€éº¼éƒ½ä¸ç”¨å¸¶"},{s:"ä»¥å¾Œåˆ¥åšæœ‹å‹",l:"é›–ç„¶ä¸èƒ½ç‰½æ‰‹ é‚„æ˜¯å¯ä»¥å•å€™"},{s:"æ˜æ˜å°±",l:"ä»–æ¯”è¼ƒæº«æŸ” ä¹Ÿæ¯”è¼ƒç”¨å¿ƒåœ°æ‡‚ä½ "},{s:"å¦³æ˜¯æˆ‘çš„èŠ±æœµ",l:"å°±ç®—å¦³å‘µè­·æˆ‘ å°±ç®—å¦³æŠ˜ç£¨æˆ‘ å–”ï½"},{s:"ä½ æ˜¯æˆ‘çš„çœ¼",l:"å¸¶æˆ‘é ˜ç•¥å››å­£çš„è¼ªæ›¿ å¸¶æˆ‘ç©¿è¶Šæ“æ“ çš„äººæ½®"},{s:"èƒŒå›",l:"ç·Šç·Šç›¸ä¾çš„å¿ƒå¦‚ä½• Say goodbye"},{s:"æµªå­å›é ­",l:"è¸ä¸€æ”¯ä¸€æ”¯ä¸€æ”¯åœ°é» é…’ä¸€æ¯ä¸€æ¯ä¸€æ¯åœ°ä¹¾"},{s:"é†œå…«æ€ª",l:"èƒ½ä¸èƒ½åˆ¥æŠŠç‡ˆæ‰“é–‹ åƒæ˜¯åœ¨æ¼”ä¸€é½£æ„å¤–"},{s:"æ¼”å“¡",l:"ç°¡å–®é» èªªè©±çš„æ–¹å¼ç°¡å–®é»"},{s:"è¿½å…‰è€…",l:"æˆ‘å¯ä»¥è·Ÿåœ¨ä½ èº«å¾Œ åƒå½±å­è¿½è‘—å¤¢éŠ"},{s:"åˆ»åœ¨æˆ‘å¿ƒåº•çš„åå­—",l:"ä½ å¿˜è¨˜äº†å§“åçš„è«‹åˆ¥åœ¨æ„ å°±åƒæˆ‘æ¶ˆå¤±åœ¨ä½ çš„ä¸–ç•Œ"},{s:"é€™ä¸–ç•Œé‚£éº¼å¤šäºº",l:"å¤šå¹¸é‹ æˆ‘æœ‰å€‹æˆ‘å€‘"},{s:"æ„›ä½ ",l:"å¦‚æœä½ çªç„¶æ‰“äº†å€‹å™´åš é‚£ä¸€å®šæ˜¯æˆ‘åœ¨æƒ³ä½ "},{s:"ç§å¥”åˆ°æœˆçƒ",l:"ä¸€äºŒä¸‰ ç‰½è‘—æ‰‹ å››äº”å…­ æŠ¬èµ·é ­"},{s:"çªç„¶å¥½æƒ³ä½ ",l:"ä½ æœƒåœ¨å“ªè£¡ éå¾—å¿«æ¨‚æˆ–å§”å±ˆ"},{s:"ä½ æ˜¯ç­”æ¡ˆ",l:"ä¸ç”¨å°‹æ‰¾ å› ç‚ºä½ å°±æ˜¯"},{s:"æŒªå¨çš„æ£®æ—",l:"è®“æˆ‘å°‡å¦³å¿ƒå…’æ‘˜ä¸‹ è©¦è‘—å°‡å®ƒæ…¢æ…¢èåŒ–"},{s:"æ„›æ‹¼æ‰æœƒè´",l:"ä¸‰åˆ†å¤©æ³¨å®š ä¸ƒåˆ†é æ‰“æ‹¼"},{s:"æˆ‘çš„æ­Œè²è£¡",l:"ä½ å­˜åœ¨ æˆ‘æ·±æ·±çš„è…¦æµ·è£¡"},{s:"æƒ³è¦‹ä½ æƒ³è¦‹ä½ æƒ³è¦‹ä½ ",l:"æœªä¾†éå» æˆ‘åªæƒ³æ‰¾å¦³"},{s:"é­šä»”",l:"èŠ±åœ¨é¢¨ä¸­ æ–ä¾†æ–å» æ–ä¾†æ–å»"},{s:"æŠ«æ˜Ÿæˆ´æœˆçš„æƒ³ä½ ",l:"æˆ‘æœƒå¥®ä¸é¡§èº«çš„å‰é€² å¥”å‘é‚£ä¸çŸ¥åçš„é æ–¹"},{s:"åœ¨é‚£åº§ç‡ˆå¡”",l:"æŒ‡å¼•è‘— è¿·å¤±èˆªç·šçš„å°èˆ¹"},{s:"æ¨¡ç‰¹",l:"ç©¿è‘—å‰›åŠè†çš„è—è£™å­"},{s:"æç™½",l:"è¦æ˜¯èƒ½é‡ä¾† æˆ‘è¦é¸å¦ä¸€å€‹äººç”Ÿ"},{s:"ç‹å¦ƒ",l:"æ–æ™ƒçš„ç´…é…’æ¯ å˜´å”‡åƒæŸ“è‘—é®®è¡€"},{s:"å¹³å‡¡ä¹‹è·¯",l:"æˆ‘æ›¾ç¶“è·¨éå±±å’Œå¤§æµ· ä¹Ÿç©¿éäººå±±äººæµ·"},{s:"æ¶ˆæ„",l:"ä¸€æ¯æ•¬è‡ªç”± ä¸€æ¯æ•¬æ­»äº¡"},{s:"åƒå¹´ä¹‹æˆ€",l:"èª°åœ¨æµ·é‚Š æ‚„æ‚„å®ˆå€™"},{s:"ä½ æ˜¯æˆ‘çš„è€å©†",l:"å¾ä»Šä»¥å¾Œ åŸ·å­ä¹‹æ‰‹ å“ªæ€•è·¯å†é›£èµ°"},{s:"æ±Ÿå—",l:"åœˆåœˆåœ“åœ“åœˆåœˆ å¤©å¤©å¹´å¹´å¤©å¤©çš„æˆ‘"},{s:"é—œéµè©",l:"å¥½å¥½æ„›è‡ªå·± å°±åƒæ˜¯é‡åˆ°äº†å¥‡è¹Ÿ"},{s:"æ¶¼æ¶¼",l:"å¤œè‰² ç‚ºä½ æ€å¿µæˆæ²³"},{s:"å‰›å¥½é‡è¦‹ä½ ",l:"ç•™ä¸‹è¶³è·¡æ‰ç¾éº— æˆ‘å€‘åœ¨æœ€å¥½çš„æ™‚å…‰"},{s:"æ…¢æ…¢å–œæ­¡ä½ ",l:"æ…¢æ…¢çš„å›æ†¶ æ…¢æ…¢çš„é™ªä½ è€å»"},{s:"å¹´å°‘æœ‰ç‚º",l:"å‡å¦‚æˆ‘ä¸è‡ªå‘ æ‡‚å¾—ä»€éº¼æ˜¯çè²´"},{s:"å…‰å¹´ä¹‹å¤–",l:"æˆ‘æ²’æƒ³åˆ° ç‚ºäº†ä½  æˆ‘èƒ½ç˜‹ç‹‚åˆ°"},{s:"é‡ç‹¼Disco",l:"å¿ƒè£¡çš„èŠ± æˆ‘æƒ³è¦å¸¶ä½ å›å®¶"},{s:"ä½ è¦è·³èˆå—",l:"ä½ ä½ ä½  æº–å‚™å¥½äº†å— æ¯ç•¶æµªæ½®ä¾†è‡¨çš„æ™‚å€™"},{s:"è½æµ·",l:"çœ‹ æµ·å“­çš„è²éŸ³"},{s:"æ´‹è”¥",l:"å¦‚æœä½ é¡˜æ„ä¸€å±¤ä¸€å±¤ä¸€å±¤åœ°å‰é–‹æˆ‘çš„å¿ƒ"},{s:"é‡è¦‹",l:"æˆ‘é‡è¦‹èª° æœƒæœ‰æ€æ¨£çš„å°ç™½"},{s:"æˆå…¨",l:"çµ¦äº†ä½ çš„ç€Ÿç‘èˆ‡å†’éšª ä¹Ÿè¦è¬è¬ä½ çš„å¤§æ–¹"},{s:"å¾Œä¾†",l:"æˆ‘ç¸½ç®—å­¸æœƒäº†å¦‚ä½•å»æ„›"},{s:"å‹‡æ°£",l:"æ„›çœŸçš„éœ€è¦å¾ˆå¤§æ±ºå¿ƒ ä¾†é¢å°æµè¨€èœšèª"},{s:"å–®èº«æƒ…æ­Œ",l:"æŠ“ä¸ä½æ„›æƒ…çš„æˆ‘ ç¸½æ˜¯çœ¼çœçœçœ‹å®ƒæºœèµ°"},{s:"å¯æƒœä¸æ˜¯ä½ ",l:"é™ªæˆ‘åˆ°æœ€å¾Œ æ›¾ä¸€èµ·èµ°éçš„è·¯å£"},{s:"æˆ‘æ‡·å¿µçš„",l:"æˆ‘æ‡·å¿µçš„æ˜¯ç„¡è©±ä¸èªª æˆ‘æ‡·å¿µçš„æ˜¯ä¸€èµ·ç™¼å¤¢"},{s:"éš±å½¢çš„ç¿…è†€",l:"æˆ‘çµ‚æ–¼ç¿±ç¿” ç”¨å¿ƒå‡æœ›ä¸å®³æ€•"},{s:"å¤©é»‘é»‘",l:"æ¬²è½é›¨ é˜®é˜¿å…¬ä»”è¦é‹¤é ­"},{s:"åƒé‡Œä¹‹å¤–",l:"æˆ‘é€ä½ é›¢é–‹ ä½ ç„¡è²é»‘ç™½"},{s:"é’èŠ±ç“·",l:"å¤©é’è‰²ç­‰ç…™é›¨ è€Œæˆ‘åœ¨ç­‰ä½ "},{s:"èŠèŠ±å°",l:"æ®˜ æ»¿åœ°å‚· ä½ çš„ç¬‘å®¹å·²æ³›é»ƒ"},{s:"é›™æˆªæ£",l:"å¿«ä½¿ç”¨ å“¼å“¼å“ˆå…®"},{s:"ç‰›ä»”å¾ˆå¿™",l:"ä¸ç”¨éº»ç…©äº† ä¸ç”¨éº»ç…©äº† å—šå“ˆ"},{s:"è’²å…¬è‹±çš„ç´„å®š",l:"å°å­¸ç±¬ç¬†æ—çš„ é‚£ç•«é¢å¾ˆç¾"},{s:"æœ¬è‰ç¶±ç›®",l:"å¦‚æœè¯é™€å†ä¸– å´‡æ´‹éƒ½è¢«é†«æ²»"},{s:"æ˜æ˜å°±",l:"ç³–æœç½è£¡è·Œè½çš„ç´éµ æ—‹å¾‹åœ¨ç™¼ç‡’"},{s:"ç®—ä»€éº¼ç”·äºº",l:"å¦³çœ¼çœçœçœ‹å¥¹èµ° å¦³å»ä¸€å¥è©±éƒ½ä¸èªª"},{s:"ç­‰ä½ ä¸‹èª²",l:"ä½ ä½çš„å··å­è£¡ æˆ‘ç§Ÿäº†ä¸€é–“å…¬å¯“"},{s:"ä¸è©²",l:"é›ªåœ°è£¡ç›¸æ„› ä»–å€‘èªªé›¶ä¸‹å·²çµæ™¶çš„èª“è¨€"},{s:"æ“±æ·º",l:"æˆ‘åªèƒ½ æ°¸é æœè‘—é æ–¹æœ›è‘—ä½ çš„èƒŒå½±"},{s:"æ¥“",l:"ç·©ç·©é£„è½çš„è‘‰åƒæ€å¿µ"},{s:"é–‹ä¸äº†å£",l:"å°±æ˜¯èªªä¸å‡ºä¾† è®“ä»–çŸ¥é“"},{s:"è»Œè·¡",l:"æˆ‘æœƒæ“¦å»æˆ‘ä¸å°å¿ƒæ»´ä¸‹çš„æ·šæ°´"},{s:"æ–·äº†çš„å¼¦",l:"å†æ€éº¼é€£ æˆ‘çš„æ„Ÿè¦º"},{s:"ä¸èƒ½èªªçš„ç§˜å¯†",l:"å†·å’–å•¡é›¢é–‹äº†æ¯å¢Š"},{s:"å½©è™¹",l:"çœ‹ä¸è¦‹å¦³çš„ç¬‘æˆ‘æ€éº¼ç¡å¾—è‘—"},{s:"èªªå¥½çš„å¹¸ç¦å‘¢",l:"ä½ çš„å›è©±å‡Œäº‚è‘— æ­Œè©ä¹Ÿå¯«å¾—ä¸æ¸…æ¥š"},{s:"å®‰éœ",l:"åªå‰©ä¸‹é‹¼ç´é™ªæˆ‘å½ˆäº†ä¸€å¤©"},{s:"é¾æ²é¢¨",l:"æ„›æƒ…ä¾†å¾—å¤ªå¿« é›¢ä¸é–‹ æš´é¢¨åœˆ"},{s:"ç°¡å–®æ„›",l:"æˆ‘æƒ³å¤§è²å®£ä½ˆ å°ä½ ä¾ä¾ä¸æ¨"},{s:"åŠå³¶éµç›’",l:"èµ°å»Šç‡ˆé—œä¸Š æ›¸åŒ…æ”¾"},{s:"å¯æ„›å¥³äºº",l:"æ¼‚äº®çš„è®“æˆ‘é¢ç´…çš„ æº«æŸ”çš„"},{s:"æ˜Ÿæ™´",l:"æ‰‹ç‰½æ‰‹ä¸€æ­¥å…©æ­¥ä¸‰æ­¥å››æ­¥æœ›è‘—å¤©"},{s:"æ™´å¤©",l:"æ•…äº‹çš„å°é»ƒèŠ± å¾å‡ºç”Ÿé‚£å¹´å°±é£„è‘—"},{s:"ç¨»é¦™",l:"é‚„è¨˜å¾—ä½ èªªå®¶æ˜¯å”¯ä¸€çš„åŸå ¡"},{s:"æ±é¢¨ç ´",l:"èª°åœ¨ç”¨çµç¶å½ˆå¥ä¸€æ›²"},{s:"å¤œæ›²",l:"ç‚ºä½ å½ˆå¥è•­é‚¦çš„ é€™æ„Ÿè¦ºå¾ˆå­¤ç¨"},{s:"ä¸€è·¯å‘åŒ—",l:"å¾Œè¦–é¡è£¡çš„ä¸–ç•Œ è¶Šä¾†è¶Šé "},{s:"æˆ‘ä¸é…",l:"é€™æ„Ÿè¦ºå·²ç¶“ä¸å° æˆ‘åŠªåŠ›æŒ½å›"},{s:"é«®å¦‚é›ª",l:"å¦³æ·’ç¾äº†é›¢åˆ¥ æƒ¹ç´…å¡µæ€¨"},{s:"è½è¦‹ä¸‹é›¨çš„è²éŸ³",l:"è€Œæˆ‘ç™¼ç¾å¦³å§‹çµ‚åœ¨é‚£"},{s:"æ„›åœ¨è¥¿å…ƒå‰",l:"ç¥­å¸ç¥æ®¿å¾æˆ°å¼“ç®­"},{s:"å±‹é ‚",l:"åœ¨ä¸Šé¢å”±è‘—ä½ çš„æ­Œ"},{s:"çŠç‘šæµ·",l:"ç¬‘å®¹åœ¨ç­‰å¾… æ·šæ°´åœ¨è¡¨ç™½"},{s:"æ·˜æ±°",l:"åªèƒ½èªªæˆ‘è¼¸äº† ä¹Ÿè¨±æ˜¯ä½ ä¸éœ€è¦äº†"},{s:"æ„›æˆ‘åˆ¥èµ°",l:"å¦‚æœå¦³èªªå¦³ä¸æ„›æˆ‘ å¦³å°±çœŸçš„ä¸æ„›æˆ‘"},{s:"å°é¢çš„å¥³å­©çœ‹éä¾†",l:"å¯‚å¯ç”·å­©æƒ…æ‡· å…¶å¯¦æˆ‘ä¹Ÿå¾ˆå¯æ„›"},{s:"å»åˆ¥",l:"æˆ‘å’Œä½  åœ¨ç„¡äººçš„è¡—"},{s:"ä¸€åƒå€‹å‚·å¿ƒçš„ç†ç”±",l:"æœ€å¾Œåœ¨åˆ¥äººçš„æ•…äº‹è£¡ æˆ‘è¢«éºå¿˜"},{s:"æœˆäº®ä»£è¡¨æˆ‘çš„å¿ƒ",l:"å¦³å•æˆ‘æ„›å¦³æœ‰å¤šæ·± æˆ‘æ„›å¦³æœ‰å¹¾åˆ†"},{s:"ç”œèœœèœœ",l:"ä½ ç¬‘å¾—å¤šå¥½çœ‹ å¥½åƒèŠ±å…’é–‹åœ¨æ˜¥é¢¨è£¡"},{s:"å°æƒ…æ­Œ",l:"é€™æ˜¯ä¸€é¦–ç°¡å–®çš„ æˆ‘åªæƒ³èªªæ„›å¦³"},{s:"ç„¡èˆ‡å€«æ¯”çš„ç¾éº—",l:"å¦³çŸ¥é“ç•¶å¦³éœ€è¦å€‹å¤å¤© æˆ‘æœƒæ‹¼äº†å‘½åŠªåŠ›"},{s:"å†è¦‹",l:"æˆ‘æ€•æˆ‘æ²’æœ‰æ©Ÿæœƒ è·Ÿä½ èªªä¸€è²"},{s:"æ€å¿µæ˜¯ä¸€ç¨®ç—…",l:"ç•¶ä½ åœ¨ç©¿å±±è¶Šå¶ºçš„å¦ä¸€é‚Š"},{s:"æ—…è¡Œçš„æ„ç¾©",l:"ä½ é›¢é–‹æˆ‘ å°±æ˜¯æœ€å¾Œçš„ç­”æ¡ˆ"},{s:"å¥½ä¹…ä¸è¦‹",l:"ä½ æœƒä¸æœƒçªç„¶çš„å‡ºç¾ åœ¨è¡—è§’çš„å’–å•¡åº—"},{s:"ç´…ç«ç‘°",l:"å¾—ä¸åˆ°çš„æ°¸é åœ¨é¨·å‹•"},{s:"æµ®èª‡",l:"é‚£å¹´åå…« æ¯æ ¡èˆæœƒ"},{s:"Kæ­Œä¹‹ç‹",l:"æˆ‘ä»¥ç‚ºè¦æ˜¯å”±å¾—ç”¨å¿ƒè‰¯è‹¦ å¦³å°±æœƒæ„Ÿå‹•"},{s:"åå¹´",l:"åå¹´ä¹‹å‰ æˆ‘ä¸èªè­˜ä½ "},{s:"æ„›æ˜¯æ‡·ç–‘",l:"é€™æ„Ÿè¦ºæ˜¯å¦’å¿Œ ä¹Ÿæ˜¯ä¸ç›¸ä¿¡"},{s:"æ„›æƒ…è½‰ç§»",l:"å¾˜å¾Šéå¤šå°‘æ«¥çª— ä½éå¤šå°‘æ—…é¤¨"},{s:"å­¤å‹‡è€…",l:"æ„›ä½ å­¤èº«èµ°æš—å·· æ„›ä½ å‘å¾®çš„æ¨¡æ¨£"},{s:"é‚£å¥³å­©å°æˆ‘èªª",l:"èªªæˆ‘ä¿è­·å¥¹çš„å¤¢ èªªæˆ‘åƒå€‹è‹±é›„"},{s:"å¹´å°‘æœ‰ç‚º",l:"å‡å¦‚æˆ‘ä¸è‡ªå‘ æˆ‘æœƒä¸æœƒæ›´å¿«æ¨‚"},{s:"é«”é¢",l:"é›¢é–‹æ‡‰è©²ç‘è„« èª°éƒ½ä¸è¦å›é ­"},{s:"æ¶ˆæ„",l:"å¯¬æ•æˆ‘çš„åŸ·è‘— å“ªæ€•éé«”é±—å‚·"},{s:"å¹³å‡¡ä¹‹è·¯",l:"ç›´åˆ°çœ‹è¦‹å¹³å‡¡æ‰æ˜¯å”¯ä¸€çš„ç­”æ¡ˆ"},{s:"å¤œç©ºä¸­æœ€äº®çš„æ˜Ÿ",l:"èƒ½å¦è½æ¸… é‚£ä»°æœ›çš„äºº å¿ƒåº•çš„å­¤ç¨"},{s:"ç•¶ä½ ",l:"å¦³çœ¼ç›ç‡è‘—ç¬‘ å¦³èªªä¸–ç•Œå¤šç¾å¥½"},{s:"æ„›å¦³",l:"è©±èªªå¤šä¸€é» æƒ³æˆ‘å¤šä¸€é»"},{s:"å¿ƒç‰†",l:"å¦³æœ‰ä¸€æ•´é¢ç‰† çš„å¿ƒäº‹"},{s:"éºå¤±çš„ç¾å¥½",l:"æˆ‘å§‹çµ‚å¸¶è‘—å¾®ç¬‘ é›¢å¦³é å»"},{s:"æ­è‹¥æ‹‰",l:"æ„›æ˜¯ä¸€é“å…‰ å¦‚æ­¤ç¾å¦™"},{s:"éš±å½¢çš„ç¿…è†€",l:"å¸¶æˆ‘é£› çµ¦æˆ‘å¸Œæœ›"},{s:"æ·‹é›¨ä¸€ç›´èµ°",l:"ä¸å‡†æ„å¿—æ¶ˆæ²‰ åªè¦ç›¸ä¿¡å°±æœ‰å¯èƒ½"},{s:"å€’å¸¶",l:"ä½ çš„æ‰€æœ‰ç†ç”± å…¨éƒ¨éƒ½æ˜¯è—‰å£"},{s:"çœ‹æˆ‘72è®Š",l:"ç¾éº—æ¥µé™ æ„›æ¼‚äº®æ²’æœ‰çµ‚é»"},{s:"å¸ƒæ‹‰æ ¼å»£å ´",l:"æˆ‘å°±ç«™åœ¨é‚£è£¡ ç•«é¢å¤ªç¾"},{s:"èªªæ„›ä½ ",l:"æˆ‘çš„ä¸–ç•Œ è®Šå¾—å¥‡å¦™æ›´é›£ä»¥è¨€å–»"},{s:"æ—¥ä¸è½",l:"å¤©ç©ºçš„éœ§ä¾†å¾—æ¼«ä¸ç¶“å¿ƒ ç¥ˆç¦±è‘—é‚£ä¸€ç§’"},{s:"èˆå­ƒ",l:"æ—‹è½‰ è·³èº æˆ‘é–‰è‘—çœ¼"},{s:"è¨˜äº‹æœ¬",l:"ç¿»é–‹éš¨èº«æ”œå¸¶çš„ å¯«è‘—å¦³çš„åå­—"},{s:"è«æ–¯ç§‘éƒŠå¤–çš„æ™šä¸Š",l:"æ·±å¤œèŠ±åœ’è£¡ éœæ‚„æ‚„"},{s:"æˆ‘çš„æ­Œè²è£¡",l:"åœ¨é‚£æ·±å¤œçš„å¤¢è£¡ åœ¨é‚£ç„¡è²çš„è¡—é“"},{s:"å‰›å¥½é‡è¦‹ä½ ",l:"æˆ‘å€‘èªªå¥½ä¸åˆ†é›¢ è¦ä¸€ç›´åœ¨ä¸€èµ·"},{s:"æ²™æ¼ é§±é§",l:"æˆ‘è¦è·¨ä¸Šé€™ç¥ç¥•çš„åé¨ å¥”å‘é æ–¹"},{s:"èŠ’ç¨®",l:"ä¸€æƒ³åˆ°ä½ æˆ‘å°± å—šå—šå—š"},{s:"æˆ‘çš„å¥½å…„å¼Ÿ",l:"åœ¨ä½ è¼ç…Œçš„æ™‚åˆ»"},{s:"å¾Œä¾†",l:"æœ‰äº›äºº ä¸€æ—¦éŒ¯éå°±ä¸å†"},{s:"ç‚ºä½ æˆ‘å—å†·é¢¨å¹",l:"å¯‚å¯æ™‚å€™ æµçœ¼æ·š"},{s:"é ˜æ‚Ÿ",l:"æˆ‘ä»¥ç‚ºæˆ‘æœƒå ±å¾© æˆ‘ä»¥ç‚ºæˆ‘æœƒå“­"},{s:"å‘³é“",l:"æƒ³å¿µä½ ç™½è‰²çš„è¥ªå­ å’Œä½ èº«ä¸Šçš„æ·¡æ·¡é¦™æ°´"},{s:"å¾æœ",l:"çµ‚æ–¼æ‰¾åˆ°è—‰å£ è®“è‡ªå·±å¾¹åº•æ­»å¿ƒ"},{s:"å»£å³¶ä¹‹æˆ€",l:"ä½ æ—©å°±è©²æ‹’çµ•æˆ‘ ä¸è©²æ”¾ä»»æˆ‘çš„è¿½æ±‚"},{s:"ä»Šå¤©å¦³è¦å«çµ¦æˆ‘",l:"æ˜¥æš–çš„èŠ±é–‹ å¸¶èµ°å†¬å¤©çš„æ„Ÿå‚·"},{s:"å°é…’çª©",l:"é•·ç«æ¯› æ˜¯ä½ æœ€ç¾çš„è¨˜è™Ÿ"},{s:"ä¿®ç…‰æ„›æƒ…",l:"åˆ¥è¬›æƒ³å¿µ æˆ‘æ²’èªªè¬Š"},{s:"å¯æƒœæ²’å¦‚æœ",l:"å…¨éƒ½æ€ªæˆ‘ ä¸è©²èªªå¾—é‚£éº¼å¤š"},{s:"æ›¹æ“",l:"ä¸æ˜¯è‹±é›„ ä¸è®€ä¸‰åœ‹"},{s:"é‚£äº›å¹´",l:"é»‘æ¿ä¸Šæ’åˆ—çµ„åˆ ä½ æ¨å¾—è§£é–‹å—"},{s:"å¤©å",l:"æˆ‘å«‰å¦’ä½ çš„æ„› æ°£å‹¢å¦‚è™¹"},{s:"æƒ…æ­Œ",l:"æ™‚å…‰æ˜¯ç¥ç€ æ·šä¸€æ»´æ»´è¢«é‘²åµŒ"},{s:"å‹‡æ°£",l:"åªè¦ä½ ä¹Ÿä¸€æ¨£çš„è‚¯å®š"},{s:"å¯§å¤",l:"å¯§éœçš„å¤å¤© å¤©ç©ºä¸­ç¹æ˜Ÿé»é»"},{s:"æš–æš–",l:"éƒ½å¯ä»¥ éš¨ä¾¿çš„"},{s:"ç‡•å°¾è¶",l:"ä½ æ˜¯ç« ä½ æ˜¯å…‰ ä½ æ˜¯å”¯ä¸€çš„"},{s:"ä¸€å ´éŠæˆ²ä¸€å ´å¤¢",l:"ä¸è¦è«‡ä»€éº¼åˆ†é›¢ æˆ‘æ—©ç¿’æ…£å­¤ç¨"},{s:"æŒªå¨çš„æ£®æ—",l:"æˆ–è¨±å¦³å¾ä¾†ä¸æ›¾æ‡‚æˆ‘"},{s:"æµªäººæƒ…æ­Œ",l:"ä¸è¦å†æƒ³å¦³ ä¸è¦å†æ„›å¦³"},{s:"çœŸå¿ƒè‹±é›„",l:"åœ¨æˆ‘å¿ƒä¸­ æ›¾ç¶“æœ‰ä¸€å€‹å¤¢"},{s:"è½æµ·",l:"å¯«å°ä¿¡çµ¦å¦³"},{s:"å‰ªæ„›",l:"äººè‹¥çœŸèƒ½è½‰ä¸–ä¸–é–“"},{s:"æˆ‘é¡˜æ„",l:"æ€å¿µæ˜¯ä¸€ç¨®å¾ˆç„çš„æ±è¥¿"},{s:"ç´…è±†",l:"å¯§é¡˜é¸æ“‡ç•™æˆ€ä¸æ”¾æ‰‹"},{s:"æ£‹å­",l:"æƒ³èµ°å‡ºä½ æ§åˆ¶çš„é ˜åŸŸ"},{s:"ç™½å¤©ä¸æ‡‚å¤œçš„é»‘",l:"ä½ æ°¸é ä¸æ‡‚æˆ‘å‚·æ‚²"},{s:"éç«",l:"æ˜¯å¦å°ä½ æ‰¿è«¾éé ­"},{s:"æ„›å¦‚æ½®æ°´",l:"ä¸å•ä½ ç‚ºä½•æµçœ¼æ·š"},{s:"è‡³å°‘é‚„æœ‰ä½ ",l:"æˆ‘æ€•ä¾†ä¸åŠ æˆ‘è¦æŠ±è‘—ä½ "},{s:"ç‚ºæ„›ç—´ç‹‚",l:"æƒ³è¦å•å•ä½ æ•¢ä¸æ•¢"},{s:"å¾ˆæ„›å¾ˆæ„›ä½ ",l:"æ‰€ä»¥é¡˜æ„ ä¸è®“ä½ å—å§”å±ˆ"},{s:"å‚·å¿ƒå¤ªå¹³æ´‹",l:"é›¢é–‹çœŸçš„æ®˜é…·å—"},{s:"å¿ƒå¤ªè»Ÿ",l:"ä½ ç¸½æ˜¯æŠŠäº‹æƒ…æƒ³å¾—å¤ªè¤‡é›œ"}];

const TASKS = [
    {t:"å”±ä¸€ä½ã€å¥³æ­Œæ‰‹ã€‘çš„æ­Œ", n:1, v:"zy"},
    {t:"å”±ä¸€ä½ã€ç”·æ­Œæ‰‹ã€‘çš„æ­Œ", n:1, v:"zy"},
    {t:"å”±ä¸€å€‹ã€åœ˜é«”ã€‘çš„æ­Œ", n:1, v:"zy"},
    {t:"ã€éš¨æ„å”±ã€‘ä¸€é¦–æ­Œ", n:1, v:""},
    {t:"æ­Œåè¦æœ‰æ•¸å­—ï¼š", n:2, v:"num"},
    {t:"æ­Œæ›²ã€éä¸­æ–‡ã€‘(å¤–èªæ­Œ)", n:2, v:""},
    {t:"æ­Œåã€éä¸­æ–‡ã€‘", n:2, v:""},
    {t:"ä¸Šä¸€é¦–æ­Œå­—å°¾ã€æ³¨éŸ³ã€‘æ¥é¾", n:2, v:""},
    {t:"å”±ã€ä¸Šä¸€å€‹äººå”±çš„æ­Œæ‰‹ã€‘", n:3, v:""},
    {t:"æ­Œåã€5-6å€‹å­—ã€‘", n:3, v:"zy"},
    {t:"æ­Œåã€3-4å€‹å­—ã€‘", n:3, v:"zy"},
    {t:"æ­Œåã€1-2å€‹å­—ã€‘", n:3, v:"zy"},
    {t:"æ­Œåã€7å€‹å­—ä»¥ä¸Šã€‘", n:3, v:"zy"},
    {t:"ã€é»˜èƒŒã€‘æ•´é¦–æ­Œ (ä¸çœ‹æ­Œè©)", n:4, v:""},
    {t:"ã€åˆå”±ã€‘ä¸€é¦–æ­Œ", n:4, v:"zy"},
    {t:"ã€æ­Œè©çŒœè¬ã€‘é€™å¥æ­Œè©æ˜¯å“ªé¦–æ­Œï¼Ÿ", n:3, v:"lyrics"}
];

const CARDS_RAW = [
    null,
    {id:1, r:"UR", n:"å¬å–šé»‘æš—å¤§æ³•å¸«!!!", d:"è’é›†1-50è™Ÿå¡ç‰‡ï¼Œç›´æ¥å‹åˆ©!!"},
    {id:2, r:"UR", n:"é›¶å¹€èµ·æ‰‹æ€éº¼é˜²", d:"éœ€ä½æ–¼0åˆ†æ‰å¯ä½¿ç”¨ï¼Œé›™æ–¹åˆ†æ•¸ç›¸åŠ ä¸¦éš¨æ©Ÿåˆ†é…"},
    {id:3, r:"UR", n:"æ‰‹ç‰ŒæŠ¹æ®º", d:"é›™æ–¹æ¨æ£„èº«ä¸Šæ‰€æœ‰å¡ç‰‡ï¼Œé‡æ–°æŠ½å–ç›¸åŒæ•¸é‡çš„å¡ç‰‡"},
    {id:4, r:"UR", n:"ä½ ä¸éœ€è¦é€™æ¨£å¼å«ï¼Œé»‘å´ä¸€è­·", d:"éš¨æ©Ÿæ‰£é™¤å°æ–¹[10]å¼µå¡ç‰‡"},
    {id:5, r:"UR", n:"å¥½æ™‚ä»£ï¼Œä¾†è‡¨åŠ›", d:"éš¨æ©Ÿç²å¾—[10]å¼µå¡ç‰‡"},
    {id:6, r:"SSR", n:"æœƒè´å–”", d:"åˆ†æ•¸ä½æ–¼å°æ‰‹æ™‚ï¼Œå°æ–¹åˆ†æ•¸è®Š[1/2]å€"},
    {id:7, r:"SSR", n:"å¤§å“¥æ²’æœ‰è¼¸", d:"åˆ†æ•¸ä½æ–¼å°æ‰‹æ™‚ï¼Œè‡ªå·±åˆ†æ•¸è®Š[2]å€"},
    {id:8, r:"SSR", n:"æ‰€ä»¥æˆ‘èªªé‚£å€‹é†¬æ±å‘¢", d:"å°æ–¹æ­¤æ¬¡æŒ‘æˆ°å¤±æ•—"},
    {id:9, r:"SSR", n:"é ˜åŸŸå±•é–‹", d:"ä¸‹ä¸€å¼µä½¿ç”¨çš„å¡ç‰‡æ•ˆæœåŠ å€"},
    {id:10, r:"SSR", n:"ã ãŒæ–­ã‚‹", d:"å°æ–¹ä½¿ç”¨çš„1å¼µå¡ç‰‡æ•ˆæœå¤±æ•ˆ"},
    {id:11, r:"SSR", n:"ä¸æ˜¯å–”ä¸æ˜¯é€™æ¨£å­", d:"å°æ–¹ç™¼å‹•å¢åŠ è‡ªèº«åˆ†æ•¸çš„æŠ€èƒ½æ™‚ï¼Œå¢åŠ åˆ°æˆ‘æ–¹èº«ä¸Š"},
    {id:12, r:"SSR", n:"ç¥è–å½—æ˜Ÿåå°„åŠ›é‡", d:"å°æ–¹ç™¼å‹•æ‰£é™¤æˆ‘æ–¹åˆ†æ•¸çš„æŠ€èƒ½æ™‚ï¼Œæ‰£åˆ°å°æ–¹è‡ªå·±èº«ä¸Š"},
    {id:13, r:"SSR", n:"æˆ‘ç¦¿äº†ï¼Œä¹Ÿè®Šå¼·äº†", d:"æ‰£é™¤æ‰€æœ‰æ­Œæ‰‹ï¼Œæ¯æœ‰ä¸€ä½å¢åŠ [200]åˆ†"},
    {id:14, r:"SSR", n:"ä½ å¾ä»€éº¼æ™‚å€™é–‹å§‹ç”¢ç”Ÿäº†æˆ‘æ²’ä½¿ç”¨é¡èŠ±æ°´æœˆçš„éŒ¯è¦ºï¼Ÿ", d:"è®“å°æ–¹è‡ªå‹•ä½¿ç”¨[1]å¼µéš¨æ©Ÿå¡ç‰‡"},
    {id:15, r:"SSR", n:"å®‰å¦®äºå–œæ­¡é€™å€‹", d:"ç²å¾—[1000]åˆ†"},
    {id:16, r:"SR", n:"16è¹²", d:"æœ‰5ä½ç›¸åŒåœ˜é«”æ­Œæ‰‹æ™‚ï¼Œæ‰£é™¤é€™äº”ä½æ­Œæ‰‹ï¼Œå¢åŠ [1600]åˆ†ï¼Œå°æ–¹æ‰£[800]åˆ†"},
    {id:17, r:"SR", n:"ä¸‹é¢ä¸€ä½", d:"é‡æŠ½ä¸€æ¬¡æŒ‘æˆ° (éœ€åœ¨æŒ‘æˆ°ä¸­)"},
    {id:18, r:"SR", n:"åé˜¿~èŠç´", d:"ç²å¾—[1]å¼µå¡ï¼Œé ˆç«‹å³ä½¿ç”¨ï¼Œå¦å‰‡æ‰£500åˆ†"},
    {id:19, r:"SR", n:"æˆ‘å«ä½ å¹", d:"è®“å°æ‰‹å¹«ä½ å®Œæˆæ­¤æ¬¡æŒ‘æˆ°ï¼Œå®Œæˆå¾Œä½¿ç”¨è€…é™¤äº†åŸæœ‰çå‹µå¤–é¡å¤–ç²å¾—[200]åˆ†ï¼Œå¤±æ•—å‰‡å°æ–¹æ‰£é™¤[500]åˆ† (éœ€åœ¨æŒ‘æˆ°ä¸­)"},
    {id:20, r:"SR", n:"ä½ èªª...ä»€éº¼...?", d:"æ‰£é™¤å°æ–¹[5]ä½éš¨æ©Ÿæ­Œæ‰‹"},
    {id:21, r:"SR", n:"å·¦æ‰‹æ›ç›¾ï¼Œå³æ‰‹æ›åŠ", d:"é›™æ–¹éš¨æ©Ÿäº¤æ›[1]å¼µå¡ç‰‡"},
    {id:22, r:"SR", n:"å¤è¹ŸæŠ½è¸", d:"æ‰£500åˆ†ï¼Œéš¨æ©Ÿç²å¾—[1]å¼µå°æ‰‹å¡ç‰‡"},
    {id:23, r:"SR", n:"æœ¬ä¾†è¦å¤§è·³çš„", d:"æ¥æ›¿å°æ–¹çš„æ­¤æ¬¡æŒ‘æˆ°ï¼ŒæˆåŠŸå¾Œç²å¾—æŒ‘æˆ°çå‹µå¤–ï¼Œå¦å¤–ç²å¾—ç”·æ­Œæ‰‹'ç‹ADEN'"},
    {id:24, r:"SR", n:"ä¸è¡Œé‚„ä¸èƒ½ç¬‘", d:"å°æ–¹æ¯æœ‰ä¸€å¼µå¡ç‰‡ï¼Œæ‰£é™¤å°æ–¹[100]åˆ†"},
    {id:25, r:"SR", n:"Superidolçš„ç¬‘å®¹", d:"å°æ–¹æ¯æœ‰ä¸€å¼µå¡ç‰‡ï¼Œå¢åŠ æˆ‘æ–¹[100]åˆ†"},
    {id:26, r:"SR", n:"å…‰ä¹‹è­·å°åŠ", d:"å°æ–¹æš«åœæŒ‘æˆ°ä¸€æ¬¡"},
    {id:27, r:"SR", n:"å¼·æ¬²ä¹‹å£º", d:"éš¨æ©Ÿç²å¾—[2]å¼µå¡ç‰‡"},
    {id:28, r:"SR", n:"å˜‰æ˜çš„å‘³é“", d:"å¾å°æ‰‹ç²å¾—[150]åˆ†"},
    {id:29, r:"SR", n:"æˆ‘çš„è±†èŠ±~30å¡Š", d:"æ‰£é™¤å°æ‰‹[300]åˆ†"},
    {id:30, r:"SR", n:"æŒ–åº«æŒ–åº«", d:"ç²å¾—[300]åˆ†"},
    {id:31, r:"R", n:"éœ²æ¯”é†¬ï¼Œå—¨!", d:"å°æ–¹æ¯æœ‰ä¸€ä½å¥³æ­Œæ‰‹ï¼Œæ‰£[100]åˆ†"},
    {id:32, r:"R", n:"è‡ªå·±æ°é–‹", d:"å°æ–¹æ¯æœ‰ä¸€ä½ç”·æ­Œæ‰‹ï¼Œæ‰£[100]åˆ†"},
    {id:33, r:"R", n:"é‚£ä¸€å¤©çš„æ†‚é¬±~æ†‚é¬±èµ·ä¾†", d:"å°æ–¹æ¯æœ‰ä¸€ä½åœ˜é«”æ­Œæ‰‹ï¼Œæ‰£[100]åˆ†"},
    {id:34, r:"R", n:"è½ä½ é€™éº¼èªªä½ å¾ˆå‹‡å–”", d:"æŸ¥çœ‹å°æ–¹ç›®å‰çš„å¡ç‰‡æ•¸ä»¥åŠç­‰ç´š"},
    {id:35, r:"R", n:"è®“æˆ‘çœ‹çœ‹ä½ ç™¼è‚²æ­£ä¸æ­£å¸¸", d:"æŸ¥çœ‹å°æ–¹ç›®å‰çš„æ‰€æœ‰æ­Œæ‰‹"},
    {id:36, r:"R", n:"æˆ‘å…¨éƒ½è¦", d:"ä¸‰å€‹ç¨®é¡éƒ½æœ‰æ­Œæ‰‹æ™‚ï¼Œæ¯å€‹ç¨®é¡å„å¢åŠ [1]ä½æ­Œæ‰‹"},
    {id:37, r:"R", n:"ä¾†éƒ½ä¾†äº†", d:"æˆ‘æ–¹æ‰£é™¤1åå¥³æ­Œæ‰‹ï¼Œå°æ–¹æ‰£é™¤[3]åç”·æ­Œæ‰‹"},
    {id:38, r:"R", n:"æˆ‘è€çˆ¸å¾—äº†MVP!", d:"æˆ‘æ–¹æ‰£é™¤1åç”·æ­Œæ‰‹ï¼Œå°æ–¹æ‰£é™¤[3]åå¥³æ­Œæ‰‹"},
    {id:39, r:"R", n:"æˆ‘è¦é©—ç‰Œ", d:"åˆ†æ•¸è½å¾Œæ™‚ï¼Œç²å¾—[1]å¼µå¡"},
    {id:40, r:"R", n:"é«˜è™•", d:"åˆ†æ•¸é ˜å…ˆæ™‚ï¼Œç²å¾—[1]å¼µå¡"},
    {id:41, r:"R", n:"å‹è€…çš„æ—©é¤", d:"éš¨æ©Ÿç²å¾—[2]ä½è¼¸å…¥éçš„å¥³æ­Œæ‰‹"},
    {id:42, r:"R", n:"ç”·ä¸ŠåŠ ç”·", d:"éš¨æ©Ÿç²å¾—[2]ä½è¼¸å…¥éçš„ç”·æ­Œæ‰‹"},
    {id:43, r:"R", n:"å³æ‰‹é€²ç‰Œ", d:"éš¨æ©Ÿç²å¾—[1]å¼µå¡ç‰‡"},
    {id:44, r:"R", n:"å“¥å¸ƒæ—Â·ä¸€èµ·Â·å¼·å¤§", d:"è’é›†5å¼µå¯ç²å¾—[1]å¼µéš¨æ©Ÿæ›´é«˜ç´šå¡ç‰‡"},
    {id:45, r:"R", n:"å› ç‚ºæˆ‘å€‘æ˜¯å¦–ç²¾å°¾å·´", d:"æœ‰5ä½ç›¸åŒæ­Œæ‰‹æ™‚å¢åŠ [500]åˆ†"},
    {id:46, r:"R", n:"ä½ å¾Œé¢æœ‰è»Š", d:"åˆ†æ•¸ä½æ–¼0åˆ†æ™‚æ‰£é™¤å°æ–¹[200]åˆ†"},
    {id:47, r:"R", n:"æœ¬æ–¥ä½†å¤§", d:"åˆ†æ•¸ä½æ–¼0åˆ†æ™‚ç²å¾—[200]åˆ†"},
    {id:48, r:"R", n:"åš´å²æ–¥è²¬", d:"å¾å°æ‰‹ç²å¾—[50]åˆ†"},
    {id:49, r:"R", n:"ç¾åœ¨æ˜¯åŒ†åŒ†å¿™å¿™ï¼Œé€£æ»¾å¸¶çˆ¬", d:"æ‰£é™¤å°æ‰‹[100]åˆ†"},
    {id:50, r:"R", n:"æœ¬ä¾†æ‡‰è©²å¾å¾å®¹å®¹ï¼Œæ¸¸åˆƒæœ‰é¤˜", d:"ç²å¾—[100]åˆ†"}
];

// ==================== æ ¸å¿ƒè®Šæ•¸ ====================
const firebaseConfig = { apiKey: "AIzaSyBjYdhxIQ_LGoNHiAkygjkIqWsb8NgF0s8", authDomain: "ktv-game.firebaseapp.com", databaseURL: "https://ktv-game-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "ktv-game", storageBucket: "ktv-game.firebasestorage.app", messagingSenderId: "903538372328", appId: "1:903538372328:web:2456e55fcd41f0899f635d" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let myName="", myRoom="", inventory={}, scoutInv={}, totalHistory=[], currentTask=null;
let roomPlayers = {};
let doubleNext = false;
let globalHistory = []; 
let isIntercepting = false; // V61 æ””æˆªä»»å‹™æ¨™è¨˜

// ==================== æ ¸å¿ƒåŠŸèƒ½ ====================
function initGame(){
    myName=document.getElementById('inName').value.trim();
    myRoom=document.getElementById('inRoom').value.trim();
    if(!myName||!myRoom) return;
    
    inventory = JSON.parse(localStorage.getItem(`v61_inv_${myName}`)) || {};
    scoutInv = JSON.parse(localStorage.getItem(`v61_scout_${myName}`)) || {};
    totalHistory = JSON.parse(localStorage.getItem(`v61_history_${myName}`)) || [];
    doubleNext = JSON.parse(localStorage.getItem(`v61_double_${myName}`)) || false;
    
    document.getElementById('display-name').innerText=myName;
    document.getElementById('display-room').innerText=myRoom;
    document.getElementById('ui-header').style.display='block';
    
    // è¨»å†Šç©å®¶èˆ‡åŒæ­¥
    db.ref(`rooms/${myRoom}/players/${myName}`).update({ 
        name: myName, score: 0, lastActive: Date.now() 
    });

    // ç›£è½æˆ¿é–“ç©å®¶è³‡æ–™
    db.ref(`rooms/${myRoom}/players`).on('value', s => {
        roomPlayers = s.val() || {};
        updatePlayerUI();
        
        globalHistory = [];
        for(let p in roomPlayers) {
            if(roomPlayers[p].history) globalHistory.push(...roomPlayers[p].history);
        }
    });

    // *** ç›£è½å‹•ä½œäº‹ä»¶ (ååˆ¶ç³»çµ±æ ¸å¿ƒ) ***
    db.ref(`rooms/${myRoom}/actions/${myName}`).on('child_added', s => {
        const action = s.val();
        handleIncomingAction(s.key, action);
    });

    // V61: ç›£è½å…¨å±€äº‹ä»¶ (ç”¨æ–¼ä»»å‹™æ””æˆª)
    db.ref(`rooms/${myRoom}/global_actions`).on('child_added', s => {
        const act = s.val();
        // å¿½ç•¥è‡ªå·±ç™¼çš„ & å¿½ç•¥éèˆŠçš„
        if(act.source !== myName && (Date.now() - act.ts) < 5000) {
            handleGlobalAction(act);
        }
        // æ¸…ç† (åªæ¸…ç†éæœŸçš„ï¼Œé˜²æ­¢åˆªæ‰åˆ¥äººå‰›ç™¼çš„)
        if((Date.now() - act.ts) > 10000) s.ref.remove(); 
    });

    // ç›£è½è‡ªå·±çš„é€šçŸ¥
    db.ref(`rooms/${myRoom}/notifications/${myName}`).on('child_added', s => {
        showPopToast(s.val().msg, s.val().type || 'info');
        s.ref.remove();
    });
    
    syncMyData();
    showPage('page-home'); updateScoutUI();
}

function syncMyData(){
    db.ref(`rooms/${myRoom}/players/${myName}`).update({
        scoutInv: scoutInv,
        history: totalHistory
    });
    localStorage.setItem(`v61_inv_${myName}`, JSON.stringify(inventory));
}

// ==================== ä»»å‹™ç³»çµ± ====================
function prepareAndStartTask() {
    generateTask();
}

function generateTask(){
    currentTask = TASKS[Math.floor(Math.random()*TASKS.length)];
    let taskText = currentTask.t;
    let extra = "";
    
    if(currentTask.v === "num") extra = Math.floor(Math.random()*10);
    else if(currentTask.v === "zy") extra = ZHUYIN[Math.floor(Math.random()*ZHUYIN.length)];
    else if(currentTask.v === "lyrics") {
        const line = LYRICS_DB[Math.floor(Math.random()*LYRICS_DB.length)];
        extra = line.l;
        taskText += ` (${line.l})`;
    }

    // V61: å»£æ’­ã€Œé–‹å§‹ä»»å‹™ã€ï¼Œè®“æŒæœ‰ #23 çš„äººå¯ä»¥æ””æˆª
    db.ref(`rooms/${myRoom}/global_actions`).push({
        type: 'task_start',
        source: myName,
        taskData: currentTask,
        taskDesc: taskText,
        taskExtra: extra,
        ts: Date.now()
    });

    db.ref(`rooms/${myRoom}/players/${myName}/currentTask`).set({
        desc: taskText, extra: extra, rewardN: currentTask.n
    });

    displayTask(taskText, extra, currentTask.n);
    isIntercepting = false; // é€™æ˜¯è‡ªå·±æŠ½çš„
    showPage('page-challenge');
}

function displayTask(text, extra, rewardN) {
    document.getElementById('task-text').innerText = text;
    document.getElementById('extra-box').innerText = extra;
    document.getElementById('task-reward').innerText = `çå‹µï¼š${rewardN} å¼µå¡ç‰‡`;
}

// V61: è™•ç†å…¨åŸŸäº‹ä»¶ (ä¸»è¦ç”¨æ–¼ #23 æ””æˆª)
function handleGlobalAction(act) {
    if (act.type === 'task_start') {
        // å¦‚æœæˆ‘æœ‰ #23ï¼Œè·³å‡ºè©¢å•
        if (inventory[23] > 0) {
            const confirmIntercept = confirm(`å°æ‰‹ ${act.source} æŠ½å–äº†æŒ‘æˆ°ï¼š\n${act.taskDesc}\n\nä½ è¦ç™¼å‹• #23ã€æœ¬ä¾†è¦å¤§è·³çš„ã€‘ä¾†æ¶å¥ªé€™å€‹æŒ‘æˆ°å—ï¼Ÿ`);
            if (confirmIntercept) {
                // ç™¼å‹•æ””æˆª
                consumeCard(23);
                
                // è¨­å®šè‡ªå·±çš„ä»»å‹™
                currentTask = act.taskData;
                isIntercepting = true; // æ¨™è¨˜ç‚ºæ””æˆªä»»å‹™
                displayTask(act.taskDesc, act.taskExtra, currentTask.n);
                
                // é€šçŸ¥å°æ–¹ä»»å‹™è¢«æ¶äº†
                sendAction(act.source, 'intercept_success', { by: myName });
                
                // é€²å…¥æŒ‘æˆ°é é¢
                showPage('page-challenge');
                showPopToast("ğŸƒ å·²æˆåŠŸç™¼å‹• #23 æ¶å¥ªä»»å‹™ï¼å®Œæˆå¾Œå¯ç²å¾—ã€ç‹ADENã€‘ï¼", "warn");
            }
        }
    }
}

// ==================== å¡ç‰‡èˆ‡æˆ°é¬¥é‚è¼¯ ====================

function getVal(text, base) {
    const match = text.match(/\[(\d+)\]/);
    let val = match ? parseInt(match[1]) : base;
    if (doubleNext) {
        val *= 2;
        doubleNext = false;
        localStorage.setItem(`v61_double_${myName}`, false);
        showPopToast("âš¡ é ˜åŸŸå±•é–‹ï¼æ•ˆæœæ•¸å€¼åŠ å€ï¼", "warn");
    }
    return val;
}

function getMultiplier(text, defaultMul) {
    let mul = defaultMul;
    const match = text.match(/\[(\d+\.?\d*|\d+\/\d+)\]/);
    if(match) {
        if(match[1].includes('/')) {
            let parts = match[1].split('/');
            mul = parseInt(parts[0]) / parseInt(parts[1]);
        } else {
            mul = parseFloat(match[1]);
        }
    }
    
    if (doubleNext) {
        mul *= 2; 
        doubleNext = false;
        localStorage.setItem(`v61_double_${myName}`, false);
        showPopToast("âš¡ é ˜åŸŸå±•é–‹ï¼å€ç‡åŠ å€ï¼", "warn");
    }
    return mul;
}

function sendAction(target, type, data) {
    db.ref(`rooms/${myRoom}/actions/${target}`).push({
        source: myName,
        type: type, 
        data: data,
        ts: Date.now()
    });
}

function sendNotification(target, msg, type='info') {
    db.ref(`rooms/${myRoom}/notifications/${target}`).push({msg: msg, type: type});
}

// è™•ç†æ¥æ”¶åˆ°çš„å‹•ä½œ (V61 ä¿®æ­£ç‰ˆ)
function handleIncomingAction(key, action) {
    const { source, type, data } = action;
    const ref = db.ref(`rooms/${myRoom}/actions/${myName}/${key}`);
    
    let counterOptions = [];
    
    // 1. è¬ç”¨ååˆ¶ #10 (å¯ååˆ¶å¹¾ä¹æ‰€æœ‰è² é¢æ•ˆæœ + å°æ–¹Buff)
    // V61: ç¢ºä¿æ‰€æœ‰è² é¢æ•ˆæœéƒ½èƒ½è¢« #10 åµæ¸¬
    if (inventory[10]) {
        if (['dmg', 'steal_score', 'steal_card', 'remove_card_random', 'remove_singer', 'force_use', 'opp_buff', 'counter_buff_stolen', 'singer_debuff'].includes(type)) {
            counterOptions.push({id: 10, name: "ã ãŒæ–­ã‚‹", desc: "ä½¿å°æ–¹å¡ç‰‡å¤±æ•ˆ"});
        }
    }

    // 2. åå°„å‚·å®³ #12 (åƒ…é™ç´” 'dmg')
    // V61: åš´æ ¼å®šç¾©ï¼Œ'counter_buff_stolen' (è¢«ååˆ¶æ¶åˆ†) ä¸ç®—å‚·å®³ï¼Œä¸èƒ½åå°„
    if (type === 'dmg' && inventory[12]) {
        counterOptions.push({id: 12, name: "ç¥è–å½—æ˜Ÿåå°„åŠ›é‡", desc: "å°‡æ‰£åˆ†åå½ˆçµ¦å°æ–¹"});
    }

    // 3. æ¶å¥ªBuff #11 (åƒ…é™ 'opp_buff')
    if (type === 'opp_buff' && inventory[11]) {
        counterOptions.push({id: 11, name: "ä¸æ˜¯å–”ä¸æ˜¯é€™æ¨£å­", desc: `å°‡å°æ–¹å¢åŠ çš„ ${data.val} åˆ†è½‰ç§»çµ¦æˆ‘`});
    }

    // å¦‚æœæœ‰ååˆ¶é¸é …
    if (counterOptions.length > 0) {
        let title = `âš ï¸ è§¸ç™¼ååˆ¶æ©Ÿæœƒï¼`;
        let msg = `ä¾†è‡ª ${source} çš„è¡Œå‹•ï¼š${getDesc(type, data)}`;
        
        let btnHtml = counterOptions.map(c => 
            `<button class="btn-counter" onclick="executeCounter('${key}', ${c.id}, '${source}', '${type}')">ç™¼å‹•ã€${c.name}ã€‘<br><span style="font-size:10px;">${c.desc}</span></button>`
        ).join('');
        
        let cancelText = (type === 'opp_buff') ? "ä¸ååˆ¶ (å°æ–¹æˆåŠŸåŠ åˆ†)" : "ä¸ååˆ¶ï¼Œæ‰¿å—æ•ˆæœ";
        
        btnHtml += `<button class="btn-sec" onclick="acceptAction('${key}')">${cancelText}</button>`;

        showAlert(title, msg, btnHtml);
    } else {
        // ç„¡ååˆ¶ï¼Œç›´æ¥åŸ·è¡Œ
        executeActionEffect(action);
        ref.remove();
    }
}

function getDesc(type, data) {
    if(type==='dmg') return `æ‰£é™¤ä½  ${data.val} åˆ†`;
    if(type==='steal_score') return `å·å–ä½  ${data.val} åˆ†`;
    if(type==='steal_card') return `å·å– ${data.val} å¼µå¡`;
    if(type==='remove_card_random') return `ç§»é™¤ä½  ${data.val} å¼µå¡ç‰‡`;
    if(type==='remove_singer') return `ç§»é™¤æ­Œæ‰‹`;
    if(type==='effect') return `ç‰¹æ®Šæ•ˆæœ`;
    if(type==='opp_buff') return `å°æ–¹å¢åŠ äº† ${data.val} åˆ†`;
    if(type==='counter_buff_stolen') return `å°æ–¹ç™¼å‹•æŠ€èƒ½æ¶å¥ªä½ çš„åŠ åˆ† (${data.val}åˆ†)`; // V61
    if(type==='force_use') return `å¼·åˆ¶ä½ ä½¿ç”¨ä¸€å¼µå¡ç‰‡`;
    if(type==='singer_debuff') return `ä¾æ“š ${data.filterType} æ­Œæ‰‹æ•¸é‡æ‰£åˆ† (æ¯ä½ ${data.val} åˆ†)`;
    if(type==='intercept_success') return `æ¶å¥ªäº†ä½ çš„ä»»å‹™ï¼`;
    return 'æœªçŸ¥æ•ˆæœ';
}

function acceptAction(key) {
    db.ref(`rooms/${myRoom}/actions/${myName}/${key}`).once('value', s => {
        if(s.exists()) {
            executeActionEffect(s.val());
            s.ref.remove();
        }
    });
    document.getElementById('alert-modal').style.display='none';
}

function executeCounter(key, cardId, source, type) {
    consumeCard(cardId);
    
    db.ref(`rooms/${myRoom}/actions/${myName}/${key}`).once('value', s => {
        const act = s.val();
        
        if (cardId === 10) { // ç„¡æ•ˆåŒ–
            sendNotification(source, `âŒ ä½ çš„è¡Œå‹•è¢« ${myName} ä½¿ç”¨ã€ã ãŒæ–­ã‚‹ã€‘ç„¡æ•ˆåŒ–äº†ï¼`, 'error');
            // è‹¥æˆ‘æ˜¯å› ç‚ºè¢«æ¶åˆ†è€Œç™¼å‹• #10ï¼Œä»£è¡¨æˆ‘ä¿ä½äº†åˆ†æ•¸ï¼Œä»€éº¼éƒ½ä¸ç”¨åš (counter_buff_stolen çš„æ•ˆæœè¢«å–æ¶ˆ)
            // è‹¥æˆ‘æ˜¯é‡å°å°æ–¹ opp_buff ç™¼å‹• #10ï¼Œä»£è¡¨å°æ–¹åŠ åˆ†ç„¡æ•ˆ -> æ‰£é™¤å°æ–¹åˆ†æ•¸
            if (type === 'opp_buff') {
                sendAction(source, 'dmg', {val: act.data.val, reason: 'counter_buff_cancel'});
            }
        } 
        else if (cardId === 12) { // åå°„ (åƒ…dmg)
            sendAction(source, 'dmg', {val: act.data.val, reason: 'reflect'});
            sendNotification(source, `â†©ï¸ ä½ çš„æ”»æ“Šè¢« ${myName} åå°„å›ä¾†äº†ï¼`, 'error');
        } 
        else if (cardId === 11) { // å¥ªå–Buff (åƒ…opp_buff)
            // æˆ‘ç²å¾—åŠ åˆ†
            updateScore(myName, act.data.val);
            // å°æ–¹æ”¶åˆ° "è¢«æ¶åˆ†" çš„ç‰¹æ®Šè² é¢æ•ˆæœ (é dmgï¼Œæ‰€ä»¥ä¸èƒ½ç”¨ #12)
            sendAction(source, 'counter_buff_stolen', {val: act.data.val});
            sendNotification(source, `ğŸ˜² ä½ çš„åŠ åˆ†è¢« ${myName} æ¶èµ°äº†ï¼`, 'error');
        }
    });

    db.ref(`rooms/${myRoom}/actions/${myName}/${key}`).remove();
    document.getElementById('alert-modal').style.display='none';
    openCollection();
}

function executeActionEffect(action) {
    const { source, type, data } = action;
    
    // V61: ç¢ºå¯¦æ‰£é™¤è¢«æ¶èµ°çš„åŠ åˆ†
    if (type === 'counter_buff_stolen') {
        updateScore(myName, -data.val);
        showPopToast(`ğŸ“‰ ä½ çš„åŠ åˆ†è¢« ${source} æ¶èµ°äº†ï¼å·²æ‰£é™¤ ${data.val} åˆ†`, 'error');
    }
    else if (type === 'dmg') {
        updateScore(myName, -data.val);
        showPopToast(`ğŸ’” è¢« ${source} æ‰£é™¤ ${data.val} åˆ†`, 'error');
    } 
    else if (type === 'steal_score') {
        updateScore(myName, -data.val);
        db.ref(`rooms/${myRoom}/players/${source}/score`).transaction(s => (s||0) + data.val);
        showPopToast(`ğŸ’¸ è¢« ${source} å·èµ° ${data.val} åˆ†`, 'error');
    }
    else if (type === 'steal_card') {
        const myCards = [];
        for(let id in inventory) { for(let i=0; i<inventory[id]; i++) myCards.push(id); }
        if(myCards.length > 0) {
            let stolenCount = 0;
            let stolenList = [];
            for(let i=0; i<data.val; i++) {
                if(myCards.length === 0) break;
                const idx = Math.floor(Math.random()*myCards.length);
                const cId = myCards.splice(idx, 1)[0];
                consumeCard(cId);
                stolenList.push(CARDS_RAW[cId].n);
                db.ref(`rooms/${myRoom}/actions/${source}`).push({source: 'system', type: 'give_card', data: {id: cId}});
                stolenCount++;
            }
            showPopToast(`ğŸƒ è¢« ${source} å·èµ°äº† ${stolenCount} å¼µå¡ç‰‡: ${stolenList.join(', ')}`, 'error');
        } else {
            sendNotification(source, `å°æ–¹æ²’æœ‰å¡ç‰‡å¯ä»¥å·ï¼`);
        }
    }
    else if (type === 'remove_card_random') { // V61: #4 æ•ˆæœå¯¦è£
        const myCards = [];
        for(let id in inventory) { for(let i=0; i<inventory[id]; i++) myCards.push(id); }
        if(myCards.length > 0) {
            let removedCount = 0;
            for(let i=0; i<data.val; i++) {
                if(myCards.length === 0) break;
                const idx = Math.floor(Math.random()*myCards.length);
                const cId = myCards.splice(idx, 1)[0];
                consumeCard(cId);
                removedCount++;
            }
            showPopToast(`ğŸ—‘ï¸ è¢« ${source} éš¨æ©Ÿç§»é™¤äº† ${removedCount} å¼µå¡ç‰‡ï¼`, 'error');
        }
    }
    else if (type === 'give_card') {
        addCardToInventory(data.id);
    }
    else if (type === 'remove_singer') {
        removeRandomSingersDeep(data.filterType, data.count);
        showPopToast(`ğŸ—‘ï¸ è¢« ${source} ç§»é™¤äº† ${data.count} ä½æ­Œæ‰‹ï¼`, 'error');
    }
    else if (type === 'singer_debuff') {
        let totalCount = 0;
        for(let k in scoutInv) {
            if(scoutInv[k].type === data.filterType) totalCount += scoutInv[k].count;
        }
        if(totalCount > 0) {
            const loss = totalCount * data.val;
            updateScore(myName, -loss);
            showPopToast(`ğŸ“‰ å› æ“æœ‰ ${totalCount} ä½ ${data.filterType} æ­Œæ‰‹ï¼Œè¢«æ‰£é™¤ ${loss} åˆ†`, 'error');
        }
    }
    else if (type === 'spy_card') {
        const info = `å¡ç‰‡æ•¸: ${countTotalCards()}\nUR: ${countRarity('UR')}\nSSR: ${countRarity('SSR')}`;
        sendAction(source, 'show_spy_result', {content: info, title: `åµæŸ¥å ±å‘Š (${myName})`});
        showPopToast(`ğŸ‘€ ${source} æ­£åœ¨è§€å¯Ÿä½ çš„å¡ç‰‡ï¼`);
    }
    else if (type === 'spy_singer') {
        let report = [];
        for(let k in scoutInv) report.push(`${k} x${scoutInv[k].count}`);
        const info = report.length ? report.join('\n') : "ç„¡æ­Œæ‰‹";
        sendAction(source, 'show_spy_result', {content: info, title: `æ­Œæ‰‹åå–® (${myName})`});
        showPopToast(`ğŸ‘€ ${source} æ­£åœ¨æŸ¥çœ‹ä½ çš„æ­Œæ‰‹ï¼`);
    }
    else if (type === 'show_spy_result') {
        document.getElementById('spy-modal').style.display = 'flex';
        document.getElementById('spy-content').innerText = `${data.title}\n\n${data.content}`;
    }
    else if (type === 'force_use') { // V61: #14 æ•ˆæœå¯¦è£
        const myHand = Object.keys(inventory);
        if(myHand.length > 0) {
            const cId = parseInt(myHand[Math.floor(Math.random()*myHand.length)]);
            showPopToast(`ğŸ˜µ è¢« ${source} å¼·åˆ¶ä½¿ç”¨å¡ç‰‡ï¼š#${cId} ${CARDS_RAW[cId].n}`);
            // å¼·åˆ¶ä½¿ç”¨ï¼Œä¸æª¢æŸ¥æ¢ä»¶
            useCard(cId, null, true); 
        } else {
            sendNotification(source, `å°æ–¹æ²’æœ‰å¡ç‰‡å¯ä»¥ä½¿ç”¨ï¼`);
        }
    }
    else if (type === 'intercept_success') { // V61: ä»»å‹™è¢«æ¶
        currentTask = null;
        showPage('page-home');
        alert(`ä½ çš„ä»»å‹™è¢« ${data.by} ä½¿ç”¨ #23 æ¶èµ°äº†ï¼`);
    }
}

// æª¢æŸ¥å¡ç‰‡æ˜¯å¦å¯ç”¨
function checkCardUsability(id, target) {
    const myScore = roomPlayers[myName].score || 0;
    const oppScore = target ? (roomPlayers[target].score || 0) : 0;
    
    // V61: å ´æ™¯é™åˆ¶
    const inChallenge = document.getElementById('page-challenge').classList.contains('active');
    
    // éœ€è¦ç›®æ¨™çš„å¡ç‰‡
    const card = CARDS_RAW[id];
    const needsTarget = card.d.includes("å°æ–¹") || card.d.includes("å°æ‰‹") || card.d.includes("é›™æ–¹");
    if(needsTarget && !target && id !== 3) return { ok: false, msg: "éœ€é¸æ“‡ç›®æ¨™" }; 

    switch(id) {
        case 2: if(myScore >= 0) return { ok: false, msg: "éœ€ä½æ–¼0åˆ†" }; break;
        case 6: if(myScore >= oppScore) return { ok: false, msg: "éœ€åˆ†æ•¸ < å°æ‰‹" }; break;
        case 7: if(myScore >= oppScore) return { ok: false, msg: "éœ€åˆ†æ•¸ < å°æ‰‹" }; break;
        case 16: if(!findSingerByCountAndType('group', 5)) return { ok: false, msg: "éœ€ 5 ä½ç›¸åŒåœ˜é«”" }; break;
        case 17: if(!inChallenge) return { ok: false, msg: "éœ€åœ¨æŒ‘æˆ°ä¸­ä½¿ç”¨" }; break; // V61
        case 19: if(!inChallenge) return { ok: false, msg: "éœ€åœ¨æŒ‘æˆ°ä¸­ä½¿ç”¨" }; break; // V61
        case 23: return { ok: false, msg: "è¢«å‹•ï¼šå°æ–¹æŠ½ä»»å‹™æ™‚è§¸ç™¼" }; // V61
        case 39: if(myScore >= oppScore) return { ok: false, msg: "éœ€åˆ†æ•¸è½å¾Œ" }; break;
        case 40: if(myScore <= oppScore) return { ok: false, msg: "éœ€åˆ†æ•¸é ˜å…ˆ" }; break;
        case 44: if((inventory[44]||0) < 5) return { ok: false, msg: "éœ€ 5 å¼µå“¥å¸ƒæ—" }; break;
        case 45: if(!findSingerByCountAndType(null, 5)) return { ok: false, msg: "éœ€ 5 ä½ç›¸åŒæ­Œæ‰‹" }; break;
        case 46: if(myScore >= 0) return { ok: false, msg: "éœ€åˆ†æ•¸ < 0" }; break;
        case 47: if(myScore >= 0) return { ok: false, msg: "éœ€åˆ†æ•¸ < 0" }; break;
    }
    return { ok: true };
}

// å¡ç‰‡ä½¿ç”¨
async function useCard(id, forcedTarget = null, isForced = false) {
    if(!inventory[id] && !isForced) return;
    
    let target = forcedTarget || document.getElementById('target-dropdown').value;
    if (!isForced) {
        const check = checkCardUsability(id, target);
        if (!check.ok) {
            alert(`ç„¡æ³•ä½¿ç”¨ï¼š${check.msg}`);
            return;
        }
    }

    const card = CARDS_RAW[id];
    const baseVal = getVal(card.d, 0);
    let selfGainScore = 0;

    switch(id) {
        case 1: 
            let hasAll = true; for(let i=1; i<=50; i++) if(!inventory[i]) hasAll = false;
            if(hasAll) { alert("WINNER!"); db.ref(`rooms/${myRoom}/winner`).set(myName); } break;
        case 2: 
            const total = (roomPlayers[myName].score||0) + (roomPlayers[target].score||0);
            const myNew = Math.floor(Math.random()*total);
            updateScore(myName, myNew, true);
            const targetNew = total - myNew;
            const diff = (roomPlayers[target].score || 0) - targetNew; 
            if(diff > 0) sendAction(target, 'dmg', {val: diff});
            else sendAction(target, 'steal_score', {val: -diff});
            break;
        case 3: 
            const myCount = countTotalCards();
            inventory = {}; executeBatchDraw(myCount);
            if(target) sendAction(target, 'effect', {subType: 'hand_wipe'}); break;
        case 4: if(target) sendAction(target, 'remove_card_random', {val: baseVal}); break; // V61: ä¿®æ­£é¡å‹
        case 5: executeBatchDraw(baseVal); break;
        case 6: 
             const oppScore6 = roomPlayers[target].score || 0;
             const mul6 = getMultiplier(card.d, 0.5);
             const lost6 = Math.floor(oppScore6 * (1-mul6));
             sendAction(target, 'dmg', {val: lost6}); break;
        case 7: 
             const mul7 = getMultiplier(card.d, 2);
             const current7 = roomPlayers[myName].score||0;
             const gain7 = current7*(mul7-1);
             updateScore(myName, gain7);
             selfGainScore = gain7; break;
        case 8: if(target) sendNotification(target, "âŒ ä½ çš„æ­¤æ¬¡æŒ‘æˆ°è¢«åˆ¤å®šå¤±æ•—ï¼", 'error'); break;
        case 9: doubleNext = true; localStorage.setItem(`v61_double_${myName}`, true); showPopToast("âš¡ ä¸‹ä¸€å¼µå¡ç‰‡æ•ˆæœåŠ å€ï¼"); break;
        case 10: alert("æ­¤å¡ç‚ºè¢«å‹•ååˆ¶å¡"); return; 
        case 11: alert("æ­¤å¡ç‚ºè¢«å‹•ååˆ¶å¡"); return;
        case 12: alert("æ­¤å¡ç‚ºè¢«å‹•ååˆ¶å¡"); return;
        case 13: 
            let sCount = 0; for(let k in scoutInv) sCount += scoutInv[k].count;
            scoutInv={}; syncMyData(); updateScoutUI();
            const gain13 = sCount * baseVal;
            updateScore(myName, gain13);
            selfGainScore = gain13; break;
        case 14: if(target) sendAction(target, 'force_use', {}); break; // V61: ä¿®æ­£é¡å‹
        case 15: updateScore(myName, baseVal); selfGainScore = baseVal; break;
        case 16: 
             let groupC = findSingerByCountAndType('group', 5);
             if(groupC) {
                 delete scoutInv[groupC]; syncMyData(); updateScoutUI();
                 updateScore(myName, 1600); selfGainScore = 1600;
                 if(target) sendAction(target, 'dmg', {val: 800});
             } break;
        case 17: generateTask(); break; // V61: éœ€åœ¨æŒ‘æˆ°é ä½¿ç”¨
        case 18: 
             const rid = Math.floor(Math.random()*50)+1;
             alert(`æŠ½åˆ° #${rid}ï¼Œå¼·åˆ¶ä½¿ç”¨ï¼`); useCard(rid, target, true); break;
        case 19: if(target) sendNotification(target, `ğŸ’¨ è«‹å¹« ${myName} å®Œæˆä»»å‹™ï¼š${currentTask.t}`); break;
        case 20: if(target) sendAction(target, 'remove_singer', {count: baseVal}); break;
        case 21: if(inventory[id]>0) { inventory[id]--; executeBatchDraw(1); } if(target) sendAction(target, 'effect', {text: "äº¤æ›å¡ç‰‡"}); break; 
        case 22: updateScore(myName, -500); if(target) sendAction(target, 'steal_card', {val: 1}); break;
        case 23: alert("æ­¤å¡ç‚ºè¢«å‹•è§¸ç™¼ï¼Œç•¶å°æ–¹æŠ½ä»»å‹™æ™‚æœƒè©¢å•"); return; // V61: è¢«å‹•é‚è¼¯åœ¨ handleGlobalAction
        case 24: if(target) sendNotification(target, `å°æ–¹ç™¼å‹• #24ï¼Œè«‹æ ¹æ“šå¡ç‰‡æ•¸æ¯å¼µæ‰£ 100 åˆ†ï¼`); break;
        case 25: updateScore(myName, 500); selfGainScore = 500; break;
        case 26: if(target) sendNotification(target, "â¸ï¸ æš«åœæŒ‘æˆ°ä¸€æ¬¡ï¼"); break;
        case 27: executeBatchDraw(baseVal); break;
        case 28: if(target) { updateScore(myName, baseVal); sendAction(target, 'dmg', {val: baseVal}); selfGainScore = baseVal; } break;
        case 29: if(target) sendAction(target, 'dmg', {val: baseVal}); break;
        case 30: updateScore(myName, baseVal); selfGainScore = baseVal; break;
        case 31: if(target) sendAction(target, 'singer_debuff', {val: baseVal, filterType: 'female'}); break;
        case 32: if(target) sendAction(target, 'singer_debuff', {val: baseVal, filterType: 'male'}); break;
        case 33: if(target) sendAction(target, 'singer_debuff', {val: baseVal, filterType: 'group'}); break;
        case 34: if(target) sendAction(target, 'spy_card', {}); break;
        case 35: if(target) sendAction(target, 'spy_singer', {}); break;
        case 36: 
             addScout(getSingersFromHistoryUniqueFirst('male', 1)[0], 'male', 1);
             addScout(getSingersFromHistoryUniqueFirst('female', 1)[0], 'female', 1);
             addScout(getSingersFromHistoryUniqueFirst('group', 1)[0], 'group', 1); break;
        case 37: removeRandomMySinger('female', 1); if(target) sendAction(target, 'remove_singer', {count: 3, filterType: 'male'}); break;
        case 38: removeRandomMySinger('male', 1); if(target) sendAction(target, 'remove_singer', {count: 3, filterType: 'female'}); break;
        case 39: executeBatchDraw(1); break;
        case 40: executeBatchDraw(1); break;
        case 41: 
             const fList = getSingersFromHistoryUniqueFirst('female', 2);
             fList.forEach(n => addScout(n, 'female', 1)); break;
        case 42: 
             const mList = getSingersFromHistoryUniqueFirst('male', 2);
             mList.forEach(n => addScout(n, 'male', 1)); break;
        case 43: executeBatchDraw(baseVal); break;
        case 44: alert("è«‹æŒ‰ä¸Šæ–¹ç¶ è‰²æŒ‰éˆ•åˆæˆ"); return;
        case 45: if(findSingerByCountAndType(null, 5)) { updateScore(myName, baseVal); selfGainScore = baseVal; } break;
        case 46: if(target) sendAction(target, 'dmg', {val: baseVal}); break;
        case 47: updateScore(myName, baseVal); selfGainScore = baseVal; break;
        case 48: if(target) { updateScore(myName, baseVal); sendAction(target, 'dmg', {val: baseVal}); selfGainScore = baseVal; } break;
        case 49: if(target) sendAction(target, 'dmg', {val: baseVal}); break;
        case 50: updateScore(myName, baseVal); selfGainScore = baseVal; break;
    }

    // å»£æ’­åŠ åˆ†ï¼Œè§¸ç™¼å°æ‰‹ #11
    if (selfGainScore > 0) {
        for(let p in roomPlayers) {
            if(p !== myName) {
                sendAction(p, 'opp_buff', {val: selfGainScore});
            }
        }
    }

    consumeCard(id);
    closeModal();
    openCollection();
}

// ==================== è¼”åŠ©åŠŸèƒ½ ====================

function updateScore(who, delta, isSet=false) {
    db.ref(`rooms/${myRoom}/players/${who}/score`).transaction(current => {
        const final = isSet ? delta : (current || 0) + delta;
        return final;
    }, (err, committed, s) => {
        if(committed && !isSet && delta !== 0 && who === myName) {
            const msg = delta > 0 ? `åˆ†æ•¸å¢åŠ  ${delta}` : `åˆ†æ•¸æ¸›å°‘ ${Math.abs(delta)}`;
            const type = delta > 0 ? 'success' : 'error';
            showPopToast(msg, type);
        }
    });
}

function getSingersFromHistoryUniqueFirst(type, count) {
    const candidates = globalHistory.filter(h => h.split('|')[1] === type).map(h => h.split('|')[0]);
    if(candidates.length === 0) return Array(count).fill(type === 'male' ? "å‘¨æ°å€«" : (type === 'female' ? "è”¡ä¾æ—" : "äº”æœˆå¤©"));

    const myOwned = Object.keys(scoutInv);
    const unowned = candidates.filter(n => !myOwned.includes(n));
    const result = [];

    for(let i=0; i<count; i++) {
        if(unowned.length > 0) {
            const idx = Math.floor(Math.random()*unowned.length);
            result.push(unowned.splice(idx, 1)[0]);
        } else {
            result.push(candidates[Math.floor(Math.random()*candidates.length)]);
        }
    }
    return result;
}

function findSingerByCountAndType(type, count) {
    for(let k in scoutInv) {
        if((!type || scoutInv[k].type === type) && scoutInv[k].count >= count) return k;
    }
    return null;
}

function removeRandomSingersDeep(type, countToRemove) {
    let pool = [];
    for(let k in scoutInv) {
        if(!type || scoutInv[k].type === type) {
            for(let i=0; i<scoutInv[k].count; i++) pool.push(k);
        }
    }

    if(pool.length === 0) return;

    let removedNames = [];
    for(let i=0; i<countToRemove; i++) {
        if(pool.length === 0) break;
        const idx = Math.floor(Math.random()*pool.length);
        const removedName = pool.splice(idx, 1)[0];
        removedNames.push(removedName);
        
        if(scoutInv[removedName]) {
            scoutInv[removedName].count--;
            if(scoutInv[removedName].count <= 0) delete scoutInv[removedName];
        }
    }
    
    syncMyData();
    updateScoutUI();
}

function removeRandomMySinger(type, count) {
    removeRandomSingersDeep(type, count);
}

function executeBatchDraw(count) {
    const list = document.getElementById('draw-result-list'); 
    list.innerHTML = '';
    
    if(doubleNext && count > 0) {
        count *= 2; 
        doubleNext = false; 
        localStorage.setItem(`v61_double_${myName}`, false);
        showPopToast("æ•ˆæœåŠ å€ç”Ÿæ•ˆï¼æŠ½å¡æ•¸ X2", "warn");
    }

    let gainedNames = [];
    for(let i=0; i<count; i++){
        const id = Math.floor(Math.random()*50)+1;
        addCardToInventory(id);
        gainedNames.push(`#${id} ${CARDS_RAW[id].n}`);
        
        const card = CARDS_RAW[id];
        list.innerHTML += `<div class="res-card ${card.r}">
            <span style="font-size:10px;">#${id}</span>
            <span>${card.n}</span>
            <span style="font-size:10px;">${card.r}</span>
        </div>`;
    }
    
    showPopToast(`ğŸ´ ç²å¾— ${count} å¼µå¡ç‰‡:\n${gainedNames.join('\n')}`);
    showPage('page-machine');
    
    if(inventory[44] && inventory[44] >= 5) {
        setTimeout(() => showAlert("åˆæˆæé†’", "ä½ æ“æœ‰5éš»å“¥å¸ƒæ—ï¼Œå¯ä»¥åˆæˆäº†ï¼"), 1000);
    }
}

function addCardToInventory(id) {
    inventory[id] = (inventory[id]||0) + 1;
    localStorage.setItem(`v61_inv_${myName}`, JSON.stringify(inventory));
}

function consumeCard(id) {
    if(inventory[id] > 0) {
        inventory[id]--;
        if(inventory[id] === 0) delete inventory[id];
        localStorage.setItem(`v61_inv_${myName}`, JSON.stringify(inventory));
    }
}

function mergeGoblin() {
    if((inventory[44]||0) >= 5) {
        inventory[44] -= 5;
        if(inventory[44]===0) delete inventory[44];
        const highIds = []; for(let i=1; i<=30; i++) highIds.push(i);
        const newId = highIds[Math.floor(Math.random()*highIds.length)];
        addCardToInventory(newId);
        alert(`åˆæˆæˆåŠŸï¼ç²å¾— #${newId} ${CARDS_RAW[newId].n}`);
        openCollection();
    }
}

function saveSingersAndDraw(){
    let added = [];
    document.querySelectorAll('.entry-row').forEach(row => {
        const name = row.querySelector('.singer-in').value.trim();
        const type = row.querySelector('.type-in').value;
        if(name) {
            addScout(name, type, 1);
            added.push(`${name}(${type})`);
        }
    });

    // V61: å¦‚æœæ˜¯æ””æˆªä»»å‹™ï¼Œé¡å¤–ç²å¾— ç‹ADEN
    if(isIntercepting) {
        addScout("ç‹ADEN", "male", 1);
        added.push("ç‹ADEN(male) [æ””æˆªçå‹µ]");
        isIntercepting = false; // é‡ç½®ç‹€æ…‹
    }

    if(added.length>0) showPopToast(`ğŸ¤ å·²ç²å¾—æ­Œæ‰‹:\n${added.join('\n')}`);
    executeBatchDraw(currentTask ? currentTask.n : 1);
}

function addScout(name, type, count) {
    if(!name) return;
    if(scoutInv[name]) scoutInv[name].count += count;
    else scoutInv[name] = { count: count, type: type };
    
    totalHistory.push(`${name}|${type}`);
    localStorage.setItem(`v61_history_${myName}`, JSON.stringify(totalHistory));
    
    syncMyData();
    updateScoutUI();
    if(count > 0 && !document.getElementById('page-singer-entry').classList.contains('active')) {
         showPopToast(`ğŸ¤ ç²å¾—æ­Œæ‰‹: ${name} (${type})`);
    }
}

function scoutDrawReward(){
    const keys = Object.keys(scoutInv);
    if(keys.length < 10) return;
    for(let i=0; i<10; i++) {
        let n = keys[i];
        scoutInv[n].count--;
        if(scoutInv[n].count <= 0) delete scoutInv[n];
    }
    syncMyData(); updateScoutUI();
    executeBatchDraw(2);
}

// ==================== UI ====================

function updateScoutUI(){
    const distinct = Object.keys(scoutInv).length;
    document.getElementById('scout-count-text').innerText = `${distinct} / 10`;
    
    const btn = document.getElementById('scout-draw-btn');
    btn.disabled = distinct < 10;
    
    // V61: æ˜äº®çš„ç™¼å…‰æŒ‰éˆ•
    if(distinct >= 10) {
        btn.classList.add('btn-glow');
        btn.style.color = 'black'; 
    } else {
        btn.classList.remove('btn-glow');
        btn.style.color = '#555';
    }
    
    renderSingerList('list-male', 'male');
    renderSingerList('list-female', 'female');
    renderSingerList('list-group', 'group');
}

function renderSingerList(elementId, type) {
    const div = document.getElementById(elementId);
    div.innerHTML = "";
    for(let n in scoutInv) {
        if(scoutInv[n].type === type) {
            div.innerHTML += `<span class="singer-tag" style="color:var(--${type}-clr); border:1px solid var(--${type}-clr);">${n} x${scoutInv[n].count}</span>`;
        }
    }
    if(div.innerHTML === "") div.innerHTML = "<span style='color:#555; font-size:12px;'>ç„¡æ­Œæ‰‹</span>";
}

function openCollection(isSelectMode = false){
    showPage('page-collection'); 
    const list = document.getElementById('coll-list'); 
    list.innerHTML='';
    let totalCards = 0;
    document.getElementById('goblin-merge-area').style.display = (inventory[44]||0)>=5 ? 'block' : 'none';

    for(let i=1; i<=50; i++){
        const count = inventory[i]||0;
        totalCards += count;
        if(count > 0) {
            const c = CARDS_RAW[i];
            list.innerHTML += `<div class="res-card ${c.r}" onclick="openCardModal(${i}, ${isSelectMode})">
                <span>#${i}</span>
                <span style="font-size:10px;">${c.n}</span>
                <span style="position:absolute; bottom:2px; right:5px;">x${count}</span>
            </div>`;
        } else {
            list.innerHTML += `<div class="res-card" style="opacity:0.15; border-style:dashed;">#${i}</div>`;
        }
    }
    document.getElementById('card-count').innerText = `ç¸½å¼µæ•¸: ${totalCards}`;
}

function openCardModal(id, isSelectMode){
    const c = CARDS_RAW[id];
    document.getElementById('modal').style.display = 'flex';
    document.getElementById('m-rarity').innerText = c.r;
    document.getElementById('m-rarity').className = c.r; 
    document.getElementById('m-id').innerText = `#${id}`;
    document.getElementById('m-name').innerText = c.n;
    document.getElementById('m-desc').innerText = c.d;

    const needsTarget = c.d.includes("å°æ–¹") || c.d.includes("å°æ‰‹") || c.d.includes("é›™æ–¹");
    const targetArea = document.getElementById('target-select-area');
    const targetDrop = document.getElementById('target-dropdown');
    
    targetDrop.innerHTML = "";
    let hasOpp = false;
    for(let p in roomPlayers) {
        if(p !== myName) {
            targetDrop.innerHTML += `<option value="${p}">${p}</option>`;
            hasOpp = true;
        }
    }
    
    if(needsTarget) {
        targetArea.style.display = 'block';
        if(!hasOpp) targetDrop.innerHTML = "<option value=''>ç„¡å…¶ä»–ç©å®¶</option>";
    } else {
        targetArea.style.display = 'none';
    }

    const btn = document.getElementById('use-btn');
    
    // V61: æª¢æŸ¥é‚è¼¯
    const currentTarget = targetDrop.value || null;
    const usability = checkCardUsability(id, currentTarget);
    
    if(usability.ok) {
        btn.innerText = isSelectMode ? "ä½¿ç”¨ä¸¦è¿”å›" : "ä½¿ç”¨";
        btn.className = "btn-main";
        btn.onclick = () => {
            useCard(id);
            if(isSelectMode) showPage('page-challenge');
        };
    } else {
        btn.innerText = usability.msg;
        btn.className = "btn-sec btn-disabled";
        btn.onclick = null;
    }
    
    targetDrop.onchange = () => {
        const newCheck = checkCardUsability(id, targetDrop.value);
        if(newCheck.ok) {
             btn.innerText = isSelectMode ? "ä½¿ç”¨ä¸¦è¿”å›" : "ä½¿ç”¨";
             btn.className = "btn-main";
             btn.onclick = () => { useCard(id); if(isSelectMode) showPage('page-challenge'); };
        } else {
             btn.innerText = newCheck.msg;
             btn.className = "btn-sec btn-disabled";
             btn.onclick = null;
        }
    }
}

function showAlert(title, msg, actionsHtml = "") {
    const m = document.getElementById('alert-modal');
    document.getElementById('alert-title').innerText = title;
    document.getElementById('alert-msg').innerHTML = msg;
    const actionBox = document.getElementById('alert-actions');
    actionBox.innerHTML = actionsHtml;
    
    if(!actionsHtml) {
        actionBox.innerHTML = `<button class="btn-main" onclick="document.getElementById('alert-modal').style.display='none'">ç¢ºå®š</button>`;
    }
    m.style.display = 'flex';
}

function showPopToast(msg, type='info') {
    const t = document.getElementById('toast');
    const box = document.getElementById('toast-msg');
    box.innerText = msg;
    t.style.display = 'block';
    t.style.borderColor = type==='error'?'red' : (type==='warn'?'gold':'#e91e63');
    setTimeout(() => t.style.display = 'none', 4000);
}

function closeModal(){ document.getElementById('modal').style.display='none'; }
function backFromCollection() { showPage('page-home'); }

function addInput(){
    const div=document.createElement('div'); div.className='entry-row';
    div.innerHTML = `
        <input type="text" class="singer-in" placeholder="æ­Œæ‰‹å">
        <select class="type-in">
            <option value="male">ç”·</option>
            <option value="female">å¥³</option>
            <option value="group">åœ˜é«”</option>
        </select>`;
    document.getElementById('singer-inputs-container').appendChild(div);
}

function updatePlayerUI(){
    const list = document.getElementById('opp-list-box');
    list.innerHTML = "";
    for(let p in roomPlayers){
        if(p === myName) document.getElementById('display-score').innerText = roomPlayers[p].score || 0;
        else list.innerHTML += `<div class="opp-item">ğŸ‘¤ ${p}: ${roomPlayers[p].score||0}</div>`;
    }
}

function showPage(id){ 
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); 
    document.getElementById(id).classList.add('active'); 
    window.scrollTo(0,0); 
    
    if(id === 'page-singer-entry') {
        document.getElementById('singer-inputs-container').innerHTML = '';
        addInput(); 

        const con = document.getElementById('history-tags-container');
        con.innerHTML = "";
        let uniqueHistory = [...new Set(totalHistory)];
        uniqueHistory.slice(-20).forEach(h => {
            const [n,t] = h.split('|');
            con.innerHTML += `<span class="singer-tag" style="color:var(--${t}-clr); border:1px solid var(--${t}-clr); cursor:pointer;" onclick="fillInput('${n}','${t}')">${n}</span>`;
        });
    }
}

function fillInput(n, t) {
    const inputs = document.querySelectorAll('.singer-in');
    let filled = false;
    inputs.forEach(input => {
        if(!input.value && !filled) {
            input.value = n;
            input.nextElementSibling.value = t;
            filled = true;
        }
    });
    if(!filled) {
        addInput();
        const newInputs = document.querySelectorAll('.singer-in');
        const last = newInputs[newInputs.length-1];
        last.value = n;
        last.nextElementSibling.value = t;
    }
}

function countTotalCards(){ let c=0; for(let k in inventory) c+=inventory[k]; return c; }
function countRarity(r){ let c=0; for(let k in inventory) if(CARDS_RAW[k].r===r) c+=inventory[k]; return c; }
function testGetAllCards() { for(let i=1; i<=50; i++) inventory[i] = (inventory[i]||0)+1; localStorage.setItem(`v61_inv_${myName}`, JSON.stringify(inventory)); openCollection(); showPopToast("å·²ç²å¾—æ‰€æœ‰å¡ç‰‡ï¼"); }

</script>
</body>
</html>

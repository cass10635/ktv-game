<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KTV æ­Œæˆ° V52</title>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-database-compat.js"></script>
    <style>
        :root { 
            --ur-clr: #ffff00; --ssr-clr: #ff00ff; --sr-clr: #00d2ff; --r-clr: #ffffff;
            --accent: #e91e63; --bg-dark: #0a0a0c; --glass: rgba(255, 255, 255, 0.05);
            --male-clr: #2196f3; --female-clr: #f44336; --group-clr: #4caf50;
        }
        body { 
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; 
            background: radial-gradient(circle at top, #1a1a2e, var(--bg-dark)); 
            color: white; margin: 0; text-align: center; min-height: 100vh; overflow-x: hidden;
        }
        .header { 
            background: rgba(10, 10, 12, 0.9); backdrop-filter: blur(10px);
            padding: 15px 20px; border-bottom: 1px solid rgba(233, 30, 99, 0.3);
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100;
        }
        .score { font-size: 32px; font-weight: 900; color: gold; text-shadow: 0 0 10px rgba(255,215,0,0.4); }
        .page { display: none; padding: 25px 15px; animation: fadeIn 0.3s ease-in; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* æ–°æ˜Ÿæ¢å€å¡Šæ¨£å¼ */
        .scout-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 20px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .progress-container { width: 100%; height: 8px; background: #222; border-radius: 4px; margin: 15px 0; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #e91e63, #ffeb3b); transition: 0.5s; }
        .scout-row { display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 15px; width: 100%; }
        .scout-title { font-size: 13px; font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .tag-pool { display: flex; flex-wrap: wrap; gap: 6px; width: 100%; }
        
        button { padding: 14px 24px; border-radius: 12px; border: none; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.2s; color: white; }
        .btn-main { background: linear-gradient(45deg, #e91e63, #ff4081); width: 90%; margin: 10px 0; box-shadow: 0 4px 15px rgba(233,30,99,0.3); }
        .btn-challenge { background: linear-gradient(45deg, #f44336, #ff9800); width: 90%; height: 85px; font-size: 22px; margin: 10px 0; border: 1px solid rgba(255,255,255,0.2); }
        
        /* æ­Œæ‰‹è¼¸å…¥æ ¼æ¨£å¼ */
        .entry-row { display: flex; gap: 8px; margin-bottom: 10px; width: 100%; justify-content: center; }
        .singer-in { width: 55%; background: rgba(255,255,255,0.05); border: 1.5px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 10px; color: white; transition: 0.3s; }
        .singer-in:focus { border-color: var(--accent); background: rgba(233,30,99,0.1); outline: none; }
        .type-in { width: 30%; background: #222; border: 1px solid #444; border-radius: 10px; color: white; }

        .singer-tag { padding: 5px 12px; border-radius: 50px; font-size: 12px; font-weight: bold; border: 1px solid rgba(255,255,255,0.1); }
        .history-tag { display: inline-block; padding: 10px 15px; border-radius: 12px; margin: 4px; font-size: 13px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.03); cursor: pointer; }
        .history-tag:active { transform: scale(0.9); background: var(--accent); }

        .res-card { padding: 20px 10px; border-radius: 15px; border: 2px solid #444; background: #111; font-weight: bold; text-align: center; }
        .UR { border-color: var(--ur-clr); color: var(--ur-clr); box-shadow: 0 0 10px rgba(255,255,0,0.2); }
        .SSR { border-color: var(--ssr-clr); color: var(--ssr-clr); }
        .SR { border-color: var(--sr-clr); color: var(--sr-clr); }
    </style>
</head>
<body>

    <div class="header" id="ui-header" style="display:none;">
        <div style="text-align: left;"><div id="display-name" style="font-size: 14px; color:var(--accent); font-weight:bold;"></div><div class="score" id="display-score">0</div></div>
        <div id="opp-info" style="font-size: 11px; color: #666; text-align:right;"></div>
    </div>

    <div id="page-login" class="page active">
        <h1 style="font-size: 46px; margin-bottom: 5px; background: linear-gradient(to bottom, #fff, #888); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">KTV æ­Œæˆ°</h1>
        <p style="color: #666; margin-bottom: 30px;">V52 â€¢ ç²¾ç·»æ˜Ÿæ¢ç‰ˆ</p>
        <input type="text" id="inName" placeholder="ä½ çš„æ­Œæ‰‹è—å" style="width:80%; padding:15px; background:rgba(255,255,255,0.05); border:1px solid #333; border-radius:15px; color:white; margin-bottom:15px;">
        <input type="text" id="inRoom" placeholder="åŒ…å»‚æˆ¿è™Ÿ" style="width:80%; padding:15px; background:rgba(255,255,255,0.05); border:1px solid #333; border-radius:15px; color:white; margin-bottom:20px;">
        <button class="btn-main" onclick="initGame()" style="height: 65px; font-size: 18px;">é–‹å§‹æ­Œå”±</button>
    </div>

    <div id="page-home" class="page">
        <div class="scout-card">
            <div style="display:flex; justify-content:space-between; font-size:14px; font-weight:bold;">
                <span>ğŸŒŸ æ˜Ÿæ¢æˆå°±</span>
                <span id="scout-count-text" style="color:gold;">0 / 10</span>
            </div>
            <div class="progress-container"><div id="scout-progress" class="progress-bar"></div></div>
            
            <div class="scout-row">
                <div class="scout-title"><span class="dot" style="background:var(--male-clr);"></span> ç”·æ­Œæ‰‹</div>
                <div class="tag-pool" id="pool-male"></div>
            </div>
            <div class="scout-row">
                <div class="scout-title"><span class="dot" style="background:var(--female-clr);"></span> å¥³æ­Œæ‰‹</div>
                <div class="tag-pool" id="pool-female"></div>
            </div>
            <div class="scout-row">
                <div class="scout-title"><span class="dot" style="background:var(--group-clr);"></span> åœ˜é«”çµ„åˆ</div>
                <div class="tag-pool" id="pool-group"></div>
            </div>
            
            <button id="scout-draw-btn" class="btn-main" style="background:#222; color:#555; margin-top:10px;" onclick="scoutDrawReward()" disabled>é ˜å–æ˜Ÿæ¢å¡åŒ… (2å¼µ)</button>
        </div>

        <button class="btn-challenge" onclick="prepareAndStartTask()">ğŸ¤ æŠ½å–æŒ‘æˆ°ä»»å‹™</button>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="btn-main" style="background: rgba(255,255,255,0.05); width: 45%;" onclick="openCollection()">æˆ‘çš„å¡å†Š</button>
            <button class="btn-main" style="background: #222; width: 45%;" onclick="location.reload()">åˆ‡æ›åŒ…å»‚</button>
        </div>
    </div>

    <div id="page-challenge" class="page">
        <div style="background:rgba(255,255,255,0.03); border:1px solid #ff9800; border-radius:20px; padding:30px;">
            <div id="task-text" style="font-size:20px; color:#aaa;"></div>
            <div id="extra-box" style="font-size:24px; color:gold; font-weight:bold; margin:20px 0; min-height:60px;"></div>
            <div id="task-reward" style="font-size:13px; color:#666;"></div>
        </div>
        <button class="btn-main" style="background: #4caf50; margin-top:30px;" onclick="showPage('page-singer-entry')">æˆ‘å”±å®Œäº†ï¼</button>
        <button id="btn-redraw-task" class="btn-main" style="background: #333; font-size:14px;" onclick="redrawTask()">ğŸ”„ æ¶ˆè€—é‡è¤‡æ¨™ç±¤é‡æŠ½</button>
    </div>

    <div id="page-singer-entry" class="page">
        <h2 style="font-size:20px;">é€™é¦–æ­Œæ˜¯èª°å”±çš„ï¼Ÿ</h2>
        <div id="singer-inputs-container">
            </div>
        <button onclick="addInput()" style="margin: 10px 0 25px 0; background:rgba(255,255,255,0.1); font-size:13px; padding:8px 15px;">ï¼‹ æ–°å¢åˆå”±æ­Œæ‰‹</button>
        
        <div style="text-align:left; color:#888; font-size:12px; margin-bottom:10px;">å¿«é€Ÿå¡«å…¥æ­·å²æ­Œæ‰‹ï¼š</div>
        <div id="history-tags-container" style="text-align: left; background:rgba(0,0,0,0.2); padding:10px; border-radius:15px; max-height:180px; overflow-y:auto;"></div>
        
        <button class="btn-main" style="margin-top:30px;" onclick="saveSingersAndDraw()">ç¢ºèªä¸¦é ˜å–å¡ç‰‡</button>
    </div>

    <div id="page-machine" class="page">
        <h2 style="color:gold;">ç²å¾—çå‹µï¼</h2>
        <div id="draw-result-list" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding:20px;"></div>
        <button class="btn-main" onclick="showPage('page-home')">è¿”å›é¦–é </button>
    </div>

    <div id="page-collection" class="page">
        <h2 style="font-size:20px;">å¡ç‰‡æ”¶è—</h2>
        <div id="coll-list" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;"></div>
        <button class="btn-main" style="background: #222; margin-top: 30px;" onclick="showPage('page-home')">è¿”å›</button>
    </div>

    <div id="modal" onclick="closeModal()" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); justify-content: center; align-items: center; z-index: 200; backdrop-filter:blur(10px);">
        <div class="modal-content" onclick="event.stopPropagation()" style="background: #111; padding: 40px 30px; border-radius: 30px; width: 80%; border:1px solid #333;">
            <h2 id="m-rarity" style="font-size:40px; margin:0;"></h2>
            <div id="m-desc" style="margin:25px 0; color:#aaa; line-height:1.6;"></div>
            <button id="use-btn" class="btn-main">ç™¼å‹•æŠ€èƒ½</button>
            <p style="font-size:12px; color:#444; margin-top:15px;" onclick="closeModal()">é—œé–‰è¦–çª—</p>
        </div>
    </div>

<script>
    // åŸºç¤æ•¸æ“šèˆ‡ Firebase ç•¥ (åŒ V51)
    const VALID_COMBO = ["ã„…ã„š","ã„…ã„›","ã„…ã„","ã„…ã„Ÿ","ã„…ã„ ","ã„…ã„¢","ã„…ã„£","ã„…ã„¤","ã„…ã„¥","ã„‰ã„š","ã„‰ã„œ","ã„‰ã„","ã„‰ã„Ÿ","ã„‰ã„ ","ã„‰ã„¡","ã„‰ã„¢","ã„‰ã„£","ã„‰ã„¤","ã„‰ã„¥","ã„ã„š","ã„ã„œ","ã„ã„","ã„ã„Ÿ","ã„ã„ ","ã„ã„¡","ã„ã„¢","ã„ã„£","ã„ã„¤","ã„ã„¥","ã„“ã„š","ã„“ã„œ","ã„“ã„","ã„“ã„ ","ã„“ã„¡","ã„“ã„¢","ã„“ã„£","ã„“ã„¤","ã„“ã„¥","ã„“","ã„—ã„š","ã„—ã„œ","ã„—ã„","ã„—ã„Ÿ","ã„—ã„ ","ã„—ã„¡","ã„—ã„¢","ã„—ã„£","ã„—ã„¤","ã„—ã„¥","ã„—","ã„š","ã„›","ã„œ","ã„","ã„","ã„Ÿ","ã„ ","ã„¡","ã„¢","ã„£","ã„¤","ã„¥","ã„¦","ã„…ã„§","ã„…ã„§ã„","ã„…ã„§ã„ ","ã„…ã„§ã„¢","ã„…ã„§ã„£","ã„…ã„§ã„¥","ã„‰ã„§","ã„‰ã„§ã„","ã„‰ã„§ã„ ","ã„‰ã„§ã„¡","ã„‰ã„§ã„¢","ã„‰ã„§ã„¥","ã„ã„§","ã„ã„§ã„š","ã„ã„§ã„","ã„ã„§ã„ ","ã„ã„§ã„¡","ã„ã„§ã„¢","ã„ã„§ã„£","ã„ã„§ã„¤","ã„ã„§ã„¥","ã„§","ã„§ã„š","ã„§ã„›","ã„§ã„","ã„§ã„","ã„§ã„ ","ã„§ã„¡","ã„§ã„¢","ã„§ã„£","ã„§ã„¤","ã„§ã„¥","ã„…ã„¨","ã„†ã„¨","ã„‡ã„¨","ã„ˆã„¨","ã„‰ã„¨","ã„‰ã„¨ã„›","ã„‰ã„¨ã„Ÿ","ã„‰ã„¨ã„¢","ã„‰ã„¨ã„£","ã„‰ã„¨ã„¥","ã„ã„¨","ã„ã„¨ã„š","ã„ã„¨ã„›","ã„ã„¨ã„","ã„ã„¨ã„Ÿ","ã„ã„¨ã„¢","ã„ã„¨ã„£","ã„ã„¨ã„¤","ã„“ã„¨","ã„“ã„¨ã„š","ã„“ã„¨ã„›","ã„“ã„¨ã„","ã„“ã„¨ã„Ÿ","ã„“ã„¨ã„¢","ã„“ã„¨ã„£","ã„“ã„¨ã„¤","ã„—ã„¨","ã„—ã„¨ã„›","ã„—ã„¨ã„Ÿ","ã„—ã„¨ã„¢","ã„—ã„¨ã„£","ã„¨","ã„¨ã„š","ã„¨ã„›","ã„¨ã„","ã„¨ã„Ÿ","ã„¨ã„¢","ã„¨ã„£","ã„¨ã„¤","ã„¨ã„¥","ã„‹ã„©","ã„‹ã„©ã„","ã„Œã„©","ã„Œã„©ã„","ã„ã„©","ã„ã„©ã„","ã„ã„©ã„¢","ã„ã„©ã„£","ã„ã„©ã„¥","ã„©","ã„©ã„","ã„©ã„¢","ã„©ã„£","ã„©ã„¥"];
    const LYRICS_DB = [
        {s:"ä¸ƒé‡Œé¦™", l:["çª—å¤–çš„éº»é›€ åœ¨é›»ç·šæ¡¿ä¸Šå¤šå˜´", "ç§‹åˆ€é­šçš„æ»‹å‘³ è²“è·Ÿä½ éƒ½æƒ³äº†è§£", "å¦³èªªé€™ä¸€å¥ å¾ˆæœ‰å¤å¤©çš„æ„Ÿè¦º", "æ•´å¤œ æˆ‘çš„æ„›æº¢å‡ºå°±åƒé›¨æ°´", "é™¢å­è½è‘‰ è·Ÿæˆ‘çš„æ€å¿µåšåšä¸€ç–Š"]},
        {s:"è½åª½åª½çš„è©±", l:["å°æœ‹å‹ä½ æ˜¯å¦æœ‰å¾ˆå¤šå•è™Ÿ", "ç‚ºä»€éº¼åˆ¥äººåœ¨é‚£çœ‹æ¼«ç•« æˆ‘å»åœ¨å­¸ç•«ç•«", "åˆ¥è®“å¥¹å—å‚· æƒ³å¿«å¿«é•·å¤§ æ‰èƒ½ä¿è­·å¥¹", "æ¼‚äº®çš„é ­é«® é•·å¾—åƒå¥¹ä¸€æ¨£çš„æ¼‚äº®", "é•·å¤§å¾Œæˆ‘é–‹å§‹æ˜ç™½ ç‚ºä»€éº¼æˆ‘è·‘å¾—æ¯”åˆ¥äººå¿«"]},
        {s:"åå¹´", l:["å¦‚æœé‚£å…©å€‹å­—æ²’æœ‰é¡«æŠ– æˆ‘ä¸æœƒç™¼ç¾æˆ‘é›£å—", "åå¹´ä¹‹å‰ æˆ‘ä¸èªè­˜ä½  ä½ ä¸å±¬æ–¼æˆ‘", "ç›´åˆ°å’Œä½  åšäº†å¤šå¹´æœ‹å‹ æ‰æ˜ç™½æˆ‘çš„çœ¼æ·š", "ä¸æ˜¯ç‚ºä½ è€Œæµ ä¹Ÿç‚ºåˆ¥äººè€Œæµ", "æ‡·æŠ±æ—¢ç„¶ä¸èƒ½é€—ç•™ ä½•ä¸å°±æ‰é ­å°±èµ°"]},
        {s:"å°å¹¸é‹", l:["é‡è¦‹å¦³æ˜¯æœ€ç¾éº—çš„æ„å¤–", "åŸä¾†ä½ æ˜¯æˆ‘æœ€æƒ³ç•™ä½çš„å¹¸é‹", "å¯æˆ‘å·²å¤±å» ç‚ºä½ æ·šæµæ»¿é¢çš„æ¬Šåˆ©", "ä½†é¡˜åœ¨æˆ‘çœ‹ä¸åˆ°çš„å¤©éš› ä½ å¼µé–‹äº†é›™ç¿¼", "æ„›ä¸Šä½ çš„æ™‚å€™ é‚„ä¸æ‡‚æ„Ÿæƒ…"]},
        {s:"æ³¡æ²«", l:["é™½å…‰ä¸‹çš„å½©è™¹ æ˜¯è‰²å½©ç¹½ç´›çš„", "å…¨éƒ½æ˜¯ æ³¡æ²« åªä¸€å‰çš„èŠ±ç«", "å†ç¾éº—çš„æ³¡æ²« è§¸ç¢°å°±ç ´", "æ—©è©²çŸ¥é“ æ³¡æ²« ä¸€è§¸å°±ç ´", "ç‚ºä»€éº¼é“åˆ¥é›¢ åˆèªªä»€éº¼æ„›ä½ "]}
    ];
    const TASKS = [{t:"å”±ä¸€ä½ã€å¥³æ­Œæ‰‹ã€‘çš„æ­Œ", n:1, v:"zy"}, {t:"å”±ä¸€ä½ã€ç”·æ­Œæ‰‹ã€‘çš„æ­Œ", n:1, v:"zy"}, {t:"å”±ä¸€å€‹ã€åœ˜é«”ã€‘çš„æ­Œ", n:1, v:"zy"}, {t:"æ­Œåè¦æœ‰æ•¸å­—ï¼š", n:2, v:"num"}, {t:"ã€æ­Œè©çŒœè¬ã€‘é€™å¥æ˜¯å“ªé¦–æ­Œï¼Ÿ", n:3, v:"lyrics"}];
    const NUMS = ["0","1","2","3","4","5","6","7","8","9","10","ç™¾","åƒ","è¬"];
    const CARD_DATA = {};
    for(let i=1;i<=50;i++){
        let r=i<=5?"UR":(i<=15?"SSR":(i<=30?"SR":"R"));
        let s=r==="UR"?3000:(r==="SSR"?1500:(r==="SR"?800:300));
        CARD_DATA[i]={rarity:r,score:s,desc:`[${r}] ç«‹å³ç²å¾— ${s} åˆ†ç¶“é©—å€¼ï¼`};
    }

    const firebaseConfig = { apiKey: "AIzaSyBjYdhxIQ_LGoNHiAkygjkIqWsb8NgF0s8", authDomain: "ktv-game.firebaseapp.com", databaseURL: "https://ktv-game-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "ktv-game", storageBucket: "ktv-game.firebasestorage.app", messagingSenderId: "903538372328", appId: "1:903538372328:web:2456e55fcd41f0899f635d" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myName="", myRoom="", inventory={}, scoutInv={}, totalHistory=[], currentTask=null;
    let lastFocusedInput = null; // ç´€éŒ„æœ€å¾Œè§¸ç¢°çš„è¼¸å…¥æ¡†

    function initGame(){
        myName=document.getElementById('inName').value.trim();
        myRoom=document.getElementById('inRoom').value.trim();
        if(!myName||!myRoom) return;
        inventory=JSON.parse(localStorage.getItem('v52_inv_'+myName))||{};
        scoutInv=JSON.parse(localStorage.getItem('v52_scout_'+myName))||{};
        totalHistory=JSON.parse(localStorage.getItem('v52_history_'+myName))||[];
        document.getElementById('display-name').innerText=myName;
        document.getElementById('ui-header').style.display='flex';
        showPage('page-home'); updateScoutUI(); updateHistoryTags();
        db.ref(`rooms/${myRoom}/players/${myName}/score`).on('value',s=>{ document.getElementById('display-score').innerText=s.val()||0; });
    }

    // é‡æ–°è¨­è¨ˆçš„æ˜Ÿæ¢ UI
    function updateScoutUI(){
        const total = Object.keys(scoutInv).length;
        document.getElementById('scout-count-text').innerText = `${total} / 10`;
        document.getElementById('scout-progress').style.width = `${Math.min(total*10, 100)}%`;
        
        ['male','female','group'].forEach(t => document.getElementById(`pool-${t}`).innerHTML='');
        for(let n in scoutInv){
            const d = scoutInv[n];
            const tag = `<span class="singer-tag" style="color:var(--${d.type}-clr); border-color:var(--${d.type}-clr); background:rgba(255,255,255,0.03)">${n} ${d.count > 1 ? 'x'+d.count : ''}</span>`;
            document.getElementById(`pool-${d.type}`).innerHTML += tag;
        }
        
        const btn = document.getElementById('scout-draw-btn');
        if(total >= 10){
            btn.disabled = false; btn.style.background = "linear-gradient(45deg, #ffd700, #ff9800)"; btn.style.color = "black";
            btn.classList.add('glow-anime');
        } else {
            btn.disabled = true; btn.style.background = "#222"; btn.style.color = "#555";
        }
    }

    function prepareAndStartTask() { resetSingerInputs(); generateTask(); }

    function generateTask(){
        currentTask=TASKS[Math.floor(Math.random()*TASKS.length)];
        document.getElementById('task-text').innerText=currentTask.t;
        const eb=document.getElementById('extra-box');
        if(currentTask.v === "lyrics"){
            const song = LYRICS_DB[Math.floor(Math.random()*LYRICS_DB.length)];
            eb.innerText = `ã€Œ${song.l[Math.floor(Math.random()*song.l.length)]}ã€`;
        } else {
            eb.innerText = currentTask.v==="num"?NUMS[Math.floor(Math.random()*NUMS.length)]: (currentTask.v==="zy"?VALID_COMBO[Math.floor(Math.random()*VALID_COMBO.length)]:"");
        }
        document.getElementById('task-reward').innerText=`çå‹µï¼š${currentTask.n} å¼µå¡ç‰‡`;
        showPage('page-challenge');
    }

    // æ­Œæ‰‹è¼¸å…¥èˆ‡ç„¦é»ç´€éŒ„
    function resetSingerInputs() {
        const container = document.getElementById('singer-inputs-container');
        container.innerHTML = "";
        addInput(); // åˆå§‹åŒ–ç¬¬ä¸€å€‹
    }

    function addInput(){
        const div=document.createElement('div'); div.className='entry-row';
        const input = document.createElement('input');
        input.type="text"; input.className="singer-in"; input.placeholder="æ­Œæ‰‹åç¨±";
        // æ ¸å¿ƒé‚è¼¯ï¼šç´€éŒ„ç„¦é»
        input.onfocus = () => { lastFocusedInput = input; };
        
        const select = document.createElement('select');
        select.className="type-in";
        select.innerHTML = `<option value="male">ç”·</option><option value="female">å¥³</option><option value="group">åœ˜é«”</option>`;
        
        div.appendChild(input); div.appendChild(select);
        document.getElementById('singer-inputs-container').appendChild(div);
        lastFocusedInput = input; // æ–°å¢å¾Œé è¨­é¸ä¸­æœ€æ–°çš„ä¸€æ ¼
    }

    function updateHistoryTags(){
        const con=document.getElementById('history-tags-container'); con.innerHTML='';
        totalHistory.forEach(item => {
            const [n, t] = item.split('|');
            let s=document.createElement('span'); s.className=`history-tag`;
            s.style.color = `var(--${t}-clr)`;
            s.innerText=n;
            s.onclick=()=>{ 
                if(lastFocusedInput) {
                    lastFocusedInput.value = n;
                    // åŒæ™‚æ›´æ–°è©²æ ¼å°æ‡‰çš„ Select
                    lastFocusedInput.nextElementSibling.value = t;
                }
            };
            con.appendChild(s);
        });
    }

    function saveSingersAndDraw(){
        const rows = document.querySelectorAll('.entry-row');
        rows.forEach(row => {
            const name = row.querySelector('.singer-in').value.trim();
            const type = row.querySelector('.type-in').value;
            if(name){
                if(scoutInv[name]) { scoutInv[name].count++; } 
                else { scoutInv[name] = { count: 1, type: type }; }
                if(!totalHistory.includes(`${name}|${type}`)) totalHistory.push(`${name}|${type}`);
            }
        });
        localStorage.setItem('v52_scout_'+myName, JSON.stringify(scoutInv));
        localStorage.setItem('v52_history_'+myName, JSON.stringify(totalHistory));
        updateScoutUI(); updateHistoryTags();
        executeBatchDraw(currentTask ? currentTask.n : 1);
    }

    function executeBatchDraw(count){
        const list=document.getElementById('draw-result-list'); list.innerHTML='';
        for(let i=0;i<count;i++){
            const id= Math.floor(Math.random()*50)+1;
            inventory[id]=(inventory[id]||0)+1;
            list.innerHTML+=`<div class="res-card ${CARD_DATA[id].rarity}">#${id}<br>${CARD_DATA[id].rarity}</div>`;
        }
        localStorage.setItem('v52_inv_'+myName, JSON.stringify(inventory));
        showPage('page-machine');
    }

    function openCollection(){
        showPage('page-collection'); const list=document.getElementById('coll-list'); list.innerHTML='';
        for(let i=1;i<=50;i++){
            const count=inventory[i]||0;
            list.innerHTML+=`<div class="res-card ${count>0?CARD_DATA[i].rarity:''}" onclick="useCard(${i})">#${i}<br>${count}å¼µ</div>`;
        }
    }

    function useCard(id){
        if(!inventory[id]) return;
        document.getElementById('modal').style.display='flex';
        document.getElementById('m-rarity').innerText=CARD_DATA[id].rarity;
        document.getElementById('m-desc').innerText=CARD_DATA[id].desc;
        document.getElementById('use-btn').onclick = function(){
            inventory[id]--; localStorage.setItem('v52_inv_'+myName, JSON.stringify(inventory));
            db.ref(`rooms/${myRoom}/players/${myName}/score`).transaction(v=>(v||0)+CARD_DATA[id].score);
            closeModal(); openCollection();
        };
    }

    function scoutDrawReward(){
        let c=0;
        for(let n in scoutInv){ if(scoutInv[n].count > 0 && c < 10){ scoutInv[n].count--; c++; } }
        localStorage.setItem('v52_scout_'+myName, JSON.stringify(scoutInv));
        updateScoutUI(); executeBatchDraw(2);
    }

    function redrawTask() {
        const all = Object.keys(scoutInv);
        if(all.length===0) return;
        const dups = all.filter(k => scoutInv[k].count > 1);
        const target = dups.length > 0 ? dups[0] : all[0];
        scoutInv[target].count--; if(scoutInv[target].count <= 0) delete scoutInv[target];
        localStorage.setItem('v52_scout_'+myName, JSON.stringify(scoutInv));
        updateScoutUI(); generateTask();
    }

    function closeModal(){ document.getElementById('modal').style.display='none'; }
    function showPage(id){ 
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
        window.scrollTo(0,0); 
    }
</script>
</body>
</html>

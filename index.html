<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KTV æ­Œæˆ° V45 - åˆ†é¡ç®¡ç†ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-database-compat.js"></script>
    <style>
        :root { 
            --ur-clr: #ffff00; --ssr-clr: #ff00ff; --sr-clr: #00d2ff; --r-clr: #ffffff;
            --accent: #e91e63; --bg-dark: #0a0a0c; --glass: rgba(255, 255, 255, 0.05);
            --male-clr: #2196f3; --female-clr: #f44336; --group-clr: #4caf50;
        }
        body { 
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; 
            background: radial-gradient(circle at top, #1a1a2e, var(--bg-dark)); 
            color: white; margin: 0; text-align: center; min-height: 100vh; overflow-x: hidden;
        }
        
        /* UI Components */
        .header { 
            background: rgba(10, 10, 12, 0.85); backdrop-filter: blur(10px);
            padding: 15px 20px; border-bottom: 1px solid rgba(233, 30, 99, 0.3);
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .score { font-size: 32px; font-weight: 900; color: gold; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        .page { display: none; padding: 25px 15px; animation: slideUp 0.4s ease-out; }
        .active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .glass-panel { background: var(--glass); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 20px; backdrop-filter: blur(5px); margin-bottom: 20px; }

        button { padding: 14px 24px; border-radius: 12px; border: none; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s; color: white; }
        button:disabled { background: #333 !important; color: #777 !important; cursor: not-allowed; opacity: 0.6; }
        
        .btn-main { background: linear-gradient(45deg, #e91e63, #ff4081); width: 90%; margin: 10px 0; }
        .btn-challenge { background: linear-gradient(45deg, #f44336, #ff9800); width: 90%; height: 80px; font-size: 22px; border: 1px solid rgba(255,215,0,0.5); margin: 20px 0; animation: glow 2s infinite alternate; }
        .btn-redraw { background: #444; border: 1px solid #666; width: 90%; margin-top: 5px; font-size: 14px; }
        @keyframes glow { from { box-shadow: 0 0 5px #ff9800; } to { box-shadow: 0 0 20px #ff4081; } }
        
        /* Cards */
        .draw-result-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 10px; }
        .res-card { padding: 20px 10px; border-radius: 15px; border: 2px solid #444; background: #111; font-weight: bold; position: relative; }
        .UR { border-color: var(--ur-clr) !important; color: var(--ur-clr) !important; box-shadow: 0 0 10px rgba(255,255,0,0.3); }
        .SSR { border-color: var(--ssr-clr) !important; color: var(--ssr-clr) !important; box-shadow: 0 0 10px rgba(255,0,255,0.2); }
        .SR { border-color: var(--sr-clr) !important; color: var(--sr-clr) !important; box-shadow: 0 0 10px rgba(0,210,255,0.2); }
        .R { border-color: var(--r-clr) !important; color: var(--r-clr) !important; }

        /* Tags and Scout */
        .scout-zone { text-align: left; margin-bottom: 15px; padding: 10px; border-radius: 10px; background: rgba(0,0,0,0.2); }
        .scout-title { font-size: 12px; margin-bottom: 5px; font-weight: bold; display: flex; align-items: center; }
        .scout-title::before { content: ""; display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
        .title-male::before { background: var(--male-clr); }
        .title-female::before { background: var(--female-clr); }
        .title-group::before { background: var(--group-clr); }

        .singer-tag { display: inline-block; padding: 6px 14px; border-radius: 50px; margin: 5px; font-size: 13px; color: white; font-weight: bold; }
        .type-male { background: linear-gradient(135deg, var(--male-clr), #0d47a1); }
        .type-female { background: linear-gradient(135deg, var(--female-clr), #880e4f); }
        .type-group { background: linear-gradient(135deg, var(--group-clr), #1b5e20); }

        .history-tag { display: inline-block; padding: 6px 12px; border-radius: 10px; margin: 4px; font-size: 12px; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); }

        /* Inputs */
        input, select { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; color: white; font-size: 16px; outline: none; }
        .entry-row { display: flex; gap: 5px; margin-bottom: 10px; width: 100%; justify-content: center; }
        .entry-row input { width: 60%; }
        .entry-row select { width: 30%; font-size: 14px; }

        /* Modal & Toast */
        #modal { display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); justify-content: center; align-items: center; z-index: 200; }
        .modal-content { background: #16161a; padding: 30px; border-radius: 25px; width: 80%; border: 1px solid rgba(255,255,255,0.1); }
        .toast-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.95); border: 2px solid gold; padding: 30px; border-radius: 20px; z-index: 999; text-align: center; display: none; box-shadow: 0 0 30px rgba(255,215,0,0.4); }
        
        .collection-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .item-box { background: rgba(0,0,0,0.5); padding: 15px 5px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); font-size: 12px; color: #444; transition: 0.3s; }
        .item-box.owned.UR { border: 2px solid var(--ur-clr); color: var(--ur-clr); }
        .item-box.owned.SSR { border: 2px solid var(--ssr-clr); color: var(--ssr-clr); }
        .item-box.owned.SR { border: 2px solid var(--sr-clr); color: var(--sr-clr); }
        .item-box.owned.R { border: 1px solid var(--r-clr); color: var(--r-clr); }
    </style>
</head>
<body>

    <div id="skill-toast" class="toast-popup">
        <h2 style="color:gold; margin-top:0;">ç²å¾—æ–°å¡ç‰‡ï¼</h2>
        <div id="toast-card-info" style="font-size: 24px; font-weight: bold; margin: 20px 0;"></div>
        <button class="btn-main" onclick="closeToast()">æ”¶ä¸‹</button>
    </div>

    <div class="header" id="ui-header" style="display:none;">
        <div style="text-align: left;"><div id="display-name" style="font-size: 14px; color:var(--accent); font-weight:bold;"></div><div class="score" id="display-score">0</div></div>
        <div id="opp-info" style="font-size: 12px; color: #888; text-align:right;">è¼‰å…¥ä¸­...</div>
    </div>

    <div id="page-login" class="page active">
        <h1 style="font-size: 42px; margin-bottom: 5px; background: linear-gradient(to bottom, #fff, #888); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">KTV æ­Œæˆ°</h1>
        <p style="color: #666; margin-bottom: 30px;">V45 â€¢ åˆ†é¡ç®¡ç†èˆ‡ä¿è­·é‚è¼¯</p>
        <input type="text" id="inName" placeholder="è¼¸å…¥ä½ çš„æš±ç¨±" style="width: 85%; margin-bottom: 12px;">
        <input type="text" id="inRoom" placeholder="è¼¸å…¥æˆ¿è™Ÿ" style="width: 85%; margin-bottom: 12px;">
        <button class="btn-main" onclick="initGame()" style="margin-top: 20px; height: 60px;">é€²å…¥éŸ³æ¨‚æˆ°å ´</button>
    </div>

    <div id="page-home" class="page">
        <div class="glass-panel">
            <div style="font-size:14px; color:#aaa; margin-bottom:12px;">ğŸŒŸ æ˜Ÿæ¢é€²åº¦ï¼š<span id="scout-count" style="color:gold; font-weight:bold;">0</span> / 10</div>
            
            <div class="scout-zone">
                <div class="scout-title title-male">ç”·æ­Œæ‰‹</div>
                <div id="scout-male-list"></div>
            </div>
            <div class="scout-zone">
                <div class="scout-title title-female">å¥³æ­Œæ‰‹</div>
                <div id="scout-female-list"></div>
            </div>
            <div class="scout-zone">
                <div class="scout-title title-group">åœ˜é«”/çµ„åˆ</div>
                <div id="scout-group-list"></div>
            </div>

            <button id="scout-draw-btn" class="btn-scout" style="width: 100%; background: #333; color: #888; pointer-events:none;" onclick="scoutDrawReward()">é ˜å–æ˜Ÿæ¢çå‹µ</button>
        </div>
        <button class="btn-challenge" onclick="generateTask()">ğŸ¤ æŠ½å–æŒ‘æˆ°ä»»å‹™</button>
        <div style="display: flex; gap: 10px;">
            <button class="btn-main" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);" onclick="openCollection()">ğŸ“¦ æˆ‘çš„å¡å†Š</button>
            <button class="btn-main" style="background: #222;" onclick="location.reload()">é€€å‡ºæˆ¿é–“</button>
        </div>
    </div>

    <div id="page-challenge" class="page">
        <div class="glass-panel" style="border: 1px solid #ff9800;">
            <p style="color: #ff9800; font-size: 14px; margin: 0;">CHALLENGE</p>
            <div id="task-text" style="font-size:26px; font-weight:bold; margin: 15px 0;"></div>
            <div id="extra-box" style="font-size:40px; color:gold; font-weight:900; word-break: break-all; min-height: 100px; display: flex; align-items: center; justify-content: center; padding: 10px;"></div>
            <p id="task-reward" style="color:#888; font-size:14px; margin-top: 10px;"></p>
        </div>
        <button class="btn-main" style="background: #4caf50;" onclick="showPage('page-singer-entry')">æŒ‘æˆ°æˆåŠŸ</button>
        <button id="btn-redraw-task" class="btn-redraw" onclick="redrawTask()">ğŸ”„ é‡æ–°æŠ½é¡Œ (å„ªå…ˆæ¶ˆè€—é‡è¤‡æ­Œæ‰‹)</button>
        <button class="btn-main" style="background: #222;" onclick="showPage('page-home')">è¿”å›é¦–é </button>
    </div>

    <div id="page-singer-entry" class="page">
        <h2 style="color:var(--accent);">èª°æ­£åœ¨æ¼”å”±ï¼Ÿ</h2>
        <div id="singer-inputs-container">
            <div class="entry-row">
                <input type="text" class="singer-in" placeholder="æ­Œæ‰‹åç¨±">
                <select class="type-in">
                    <option value="male">ç”·</option>
                    <option value="female">å¥³</option>
                    <option value="group">åœ˜é«”</option>
                </select>
            </div>
        </div>
        <button onclick="addInput()" style="background:rgba(255,255,255,0.1); padding: 8px 15px; font-size: 12px; margin: 10px 0;">ï¼‹ æ–°å¢åˆå”±æ­Œæ‰‹</button>
        <div class="glass-panel"><div id="history-tags-container" style="max-height:150px; overflow-y:auto; text-align: left;"></div></div>
        <button class="btn-main" onclick="saveSingersAndDraw()">ç¢ºèªä¸¦æŠ½å¡</button>
    </div>

    <div id="page-machine" class="page">
        <h2 style="color:gold;">MISSION COMPLETE</h2>
        <div id="draw-result-list" class="draw-result-grid"></div>
        <button class="btn-main" onclick="showPage('page-home')">è¿”å›é¦–é </button>
    </div>

    <div id="page-collection" class="page">
        <h2>æˆ‘çš„å¡å†Š</h2>
        <div class="collection-grid" id="coll-list"></div>
        <button class="btn-main" style="background: #222; margin-top: 20px;" onclick="showPage('page-home')">è¿”å›</button>
    </div>

    <div id="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h1 id="m-id" style="color:#555; font-size: 18px;">#</h1>
            <h2 id="m-rarity" style="font-size: 32px; font-weight: 900;"></h2>
            <div id="m-desc" style="background:rgba(255,255,255,0.03); padding:20px; border-radius:15px; text-align:left; border: 1px solid rgba(255,255,255,0.1); line-height: 1.6;"></div>
            <div id="opp-action-area" style="display:none; margin-top: 20px;"><div id="opp-list"></div></div>
            <button id="use-btn" class="btn-main" style="margin-top: 20px;">ç«‹å³ç™¼å‹•æŠ€èƒ½</button>
        </div>
    </div>

<script>
    const CARD_DATA = {};
    const SKILLS = [{name:"çˆ†ç™¼",type:"score"},{name:"å¹²æ“¾",type:"attack"},{name:"ç«Šå–",type:"steal"},{name:"å¹¸é‹",type:"draw"},{name:"ç©©å®š",type:"score"}];
    for(let i=1;i<=50;i++){
        let r=i<=5?"UR":(i<=15?"SSR":(i<=30?"SR":"R"));
        let s=r==="UR"?3000:(r==="SSR"?1500:(r==="SR"?800:300));
        let sk=SKILLS[i%SKILLS.length];
        CARD_DATA[i]={rarity:r,score:s,skill:sk.name,type:sk.type,desc:`ã€${sk.name}ã€‘å¢åŠ  ${s} åˆ†ã€‚${sk.type==="attack"?"ä¸¦é‡æ“Šå°æ‰‹æ‰£é™¤ 1000 åˆ†ã€‚":sk.type==="steal"?"ä¸¦ç«Šå–å°æ–¹ä¸€å¼µå¡ç‰‡ã€‚":sk.type==="draw"?"ä¸¦é¡å¤–ç²å¾—ä¸€å¼µ R ç´šå¡ç‰‡ã€‚":""}`};
    }

    const VALID_COMBO = ["ã„…ã„š","ã„…ã„›","ã„…ã„","ã„…ã„Ÿ","ã„…ã„ ","ã„…ã„¢","ã„…ã„£","ã„…ã„¤","ã„…ã„¥","ã„‰ã„š","ã„‰ã„œ","ã„‰ã„","ã„‰ã„Ÿ","ã„‰ã„ ","ã„‰ã„¡","ã„‰ã„¢","ã„‰ã„£","ã„‰ã„¤","ã„‰ã„¥","ã„ã„š","ã„ã„œ","ã„ã„","ã„ã„Ÿ","ã„ã„ ","ã„ã„¡","ã„ã„¢","ã„ã„£","ã„ã„¤","ã„ã„¥","ã„“ã„š","ã„“ã„œ","ã„“ã„","ã„“ã„ ","ã„“ã„¡","ã„“ã„¢","ã„“ã„£","ã„“ã„¤","ã„“ã„¥","ã„“","ã„—ã„š","ã„—ã„œ","ã„—ã„","ã„—ã„Ÿ","ã„—ã„ ","ã„—ã„¡","ã„—ã„¢","ã„—ã„£","ã„—ã„¤","ã„—ã„¥","ã„—","ã„š","ã„›","ã„œ","ã„","ã„","ã„Ÿ","ã„ ","ã„¡","ã„¢","ã„£","ã„¤","ã„¥","ã„¦","ã„…ã„§","ã„…ã„§ã„","ã„…ã„§ã„ ","ã„…ã„§ã„¢","ã„…ã„§ã„£","ã„…ã„§ã„¥","ã„‰ã„§","ã„‰ã„§ã„","ã„‰ã„§ã„ ","ã„‰ã„§ã„¡","ã„‰ã„§ã„¢","ã„‰ã„§ã„¥","ã„ã„§","ã„ã„§ã„š","ã„ã„§ã„","ã„ã„§ã„ ","ã„ã„§ã„¡","ã„ã„§ã„¢","ã„ã„§ã„£","ã„ã„§ã„¤","ã„ã„§ã„¥","ã„§","ã„§ã„š","ã„§ã„›","ã„§ã„","ã„§ã„","ã„§ã„ ","ã„§ã„¡","ã„§ã„¢","ã„§ã„£","ã„§ã„¤","ã„§ã„¥","ã„…ã„¨","ã„†ã„¨","ã„‡ã„¨","ã„ˆã„¨","ã„‰ã„¨","ã„‰ã„¨ã„›","ã„‰ã„¨ã„Ÿ","ã„‰ã„¨ã„¢","ã„‰ã„¨ã„£","ã„‰ã„¨ã„¥","ã„ã„¨","ã„ã„¨ã„š","ã„ã„¨ã„›","ã„ã„¨ã„","ã„ã„¨ã„Ÿ","ã„ã„¨ã„¢","ã„ã„¨ã„£","ã„ã„¨ã„¤","ã„“ã„¨","ã„“ã„¨ã„š","ã„“ã„¨ã„›","ã„“ã„¨ã„","ã„“ã„¨ã„Ÿ","ã„“ã„¨ã„¢","ã„“ã„¨ã„£","ã„“ã„¨ã„¤","ã„—ã„¨","ã„—ã„¨ã„›","ã„—ã„¨ã„Ÿ","ã„—ã„¨ã„¢","ã„—ã„¨ã„£","ã„¨","ã„¨ã„š","ã„¨ã„›","ã„¨ã„","ã„¨ã„Ÿ","ã„¨ã„¢","ã„¨ã„£","ã„¨ã„¤","ã„¨ã„¥","ã„‹ã„©","ã„‹ã„©ã„","ã„Œã„©","ã„Œã„©ã„","ã„ã„©","ã„ã„©ã„","ã„ã„©ã„¢","ã„ã„©ã„£","ã„ã„©ã„¥","ã„©","ã„©ã„","ã„©ã„¢","ã„©ã„£","ã„©ã„¥"];
    const NUMS = ["0","1","2","3","4","5","6","7","8","9","10","ç™¾","åƒ","è¬","å„„"];
    
    const LYRICS_DB = [{s:"ä¸ƒé‡Œé¦™", l:"çª—å¤–çš„éº»é›€ åœ¨é›»ç·šæ¡¿ä¸Šå¤šå˜´"}, {s:"è½åª½åª½çš„è©±", l:"å°æœ‹å‹ä½ æ˜¯å¦æœ‰å¾ˆå¤šå•è™Ÿ"}, {s:"å‘Šç™½æ°£çƒ", l:"è¦ªæ„›çš„ æ„›ä¸Šä½  å¾é‚£å¤©èµ· ç”œèœœå¾—å¾ˆè¼•æ˜“"}, {s:"å°å¹¸é‹", l:"é‡è¦‹å¦³æ˜¯æœ€ç¾éº—çš„æ„å¤–"}, {s:"åå¹´", l:"å¦‚æœé‚£å…©å€‹å­—æ²’æœ‰é¡«æŠ– æˆ‘ä¸æœƒç™¼ç¾æˆ‘é›£å—"}, {s:"æƒ…éå¾—å·²", l:"é›£ä»¥å¿˜è¨˜åˆæ¬¡è¦‹ä½  ä¸€é›™è¿·äººçš„çœ¼ç›"}, {s:"æ³¡æ²«", l:"é™½å…‰ä¸‹çš„å½©è™¹ æ˜¯è‰²å½©ç¹½ç´›çš„"}, {s:"é«”é¢", l:"åˆ†æ‰‹æ‡‰è©²ä¿æŒé¢¨åº¦ èª°éƒ½ä¸è¦èªªæŠ±æ­‰"}, {s:"èªªè¬Š", l:"æˆ‘æ²’æœ‰é¨™äºº æˆ‘ä½•å¿…é¨™äºº"}]; // ç°¡åŒ–å±•ç¤ºåº«

    const TASKS = [{t:"å”±ä¸€ä½ã€å¥³æ­Œæ‰‹ã€‘çš„æ­Œ", n:1, v:"zy"}, {t:"å”±ä¸€ä½ã€ç”·æ­Œæ‰‹ã€‘çš„æ­Œ", n:1, v:"zy"}, {t:"å”±ä¸€å€‹ã€åœ˜é«”ã€‘çš„æ­Œ", n:1, v:"zy"}, {t:"ã€éš¨æ„å”±ã€‘ä¸€é¦–æ­Œ", n:1, v:""}, {t:"æ­Œåè¦æœ‰æ•¸å­—ï¼š", n:2, v:"num"}, {t:"æ­Œæ›²ã€éä¸­æ–‡ã€‘(å¤–èªæ­Œ)", n:2, v:""}, {t:"æ­Œåã€éä¸­æ–‡ã€‘", n:2, v:""}, {t:"ä¸Šä¸€é¦–æ­Œå­—å°¾ã€æ³¨éŸ³ã€‘æ¥é¾", n:2, v:""}, {t:"å”±ã€ä¸Šä¸€å€‹äººå”±çš„æ­Œæ‰‹ã€‘", n:3, v:""}, {t:"æ­Œåã€5-6å€‹å­—ã€‘", n:3, v:"zy"}, {t:"æ­Œåã€3-4å€‹å­—ã€‘", n:3, v:"zy"}, {t:"æ­Œåã€1-2å€‹å­—ã€‘", n:3, v:"zy"}, {t:"æ­Œåã€7å€‹å­—ä»¥ä¸Šã€‘", n:3, v:"zy"}, {t:"ã€é»˜èƒŒã€‘æ•´é¦–æ­Œ (ä¸çœ‹æ­Œè©)", n:4, v:""}, {t:"ã€åˆå”±ã€‘ä¸€é¦–æ­Œ", n:4, v:"zy"}, {t:"ã€æ­Œè©çŒœè¬ã€‘é€™å¥æ­Œè©æ˜¯å“ªé¦–æ­Œï¼Ÿ", n:3, v:"lyrics"}];

    const firebaseConfig = { apiKey: "AIzaSyBjYdhxIQ_LGoNHiAkygjkIqWsb8NgF0s8", authDomain: "ktv-game.firebaseapp.com", databaseURL: "https://ktv-game-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "ktv-game", storageBucket: "ktv-game.firebasestorage.app", messagingSenderId: "903538372328", appId: "1:903538372328:web:2456e55fcd41f0899f635d" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // Data structures
    let myName="", myRoom="", inventory={}, scoutInv={}, totalHistory=[], currentTask=null, selectedCid=0;

    function initGame(){
        myName=document.getElementById('inName').value.trim();
        myRoom=document.getElementById('inRoom').value.trim();
        if(!myName||!myRoom)return;
        inventory=JSON.parse(localStorage.getItem('v45_inv_'+myName))||{};
        scoutInv=JSON.parse(localStorage.getItem('v45_scout_'+myName))||{};
        totalHistory=JSON.parse(localStorage.getItem('v45_history_'+myName))||[];
        document.getElementById('page-login').classList.remove('active');
        document.getElementById('ui-header').style.display='flex';
        document.getElementById('display-name').innerText=myName;
        showPage('page-home');
        updateScoutUI(); updateHistoryTags();
        db.ref(`rooms/${myRoom}/players/${myName}/score`).on('value',s=>{document.getElementById('display-score').innerText=s.val()||0;});
        db.ref(`rooms/${myRoom}/players`).on('value',s=>{
            const all=s.val()||{},opp=Object.keys(all).find(n=>n!==myName);
            document.getElementById('opp-info').innerText=opp?`${opp}: ${all[opp].score}`:"ç­‰å¾…å°æ‰‹...";
        });
    }

    function getRandomCardId() {
        const rand = Math.random() * 100;
        let pool = [];
        if (rand < 5) pool = [1, 2, 3, 4, 5]; // UR 5%
        else if (rand < 20) pool = [6, 7, 8, 9, 10, 11, 12, 13, 14, 15]; // SSR 15%
        else if (rand < 50) pool = Array.from({length: 15}, (_, i) => i + 16); // SR 30%
        else pool = Array.from({length: 20}, (_, i) => i + 31); // R 50%
        return pool[Math.floor(Math.random() * pool.length)];
    }

    function generateTask(){
        currentTask=TASKS[Math.floor(Math.random()*TASKS.length)];
        document.getElementById('task-text').innerText=currentTask.t;
        document.getElementById('task-reward').innerText=`ğŸ† ä»»å‹™çå‹µï¼šæŠ½å– ${currentTask.n} å¼µæŠ€èƒ½å¡`;
        const eb=document.getElementById('extra-box');
        eb.style.fontSize = "40px";
        if(currentTask.v === "lyrics"){
            const q = LYRICS_DB[Math.floor(Math.random()*LYRICS_DB.length)];
            eb.innerText = `ã€Œ${q.l}ã€`; eb.style.fontSize = "22px";
        } else {
            eb.innerText = currentTask.v==="num"?NUMS[Math.floor(Math.random()*NUMS.length)]: (currentTask.v==="zy"?VALID_COMBO[Math.floor(Math.random()*VALID_COMBO.length)]:"");
        }
        const hasSingers = Object.keys(scoutInv).length > 0;
        document.getElementById('btn-redraw-task').disabled = !hasSingers;
        showPage('page-challenge');
    }

    // é‡æŠ½é‚è¼¯ï¼šå„ªå…ˆæ¶ˆè€—æœ‰é‡è¤‡çš„æ­Œæ‰‹
    function redrawTask() {
        const allSingers = Object.keys(scoutInv).filter(k => scoutInv[k].count > 0);
        if(allSingers.length === 0) return;

        // å„ªå…ˆæ‰¾ count > 1 çš„æ­Œæ‰‹
        const duplicates = allSingers.filter(k => scoutInv[k].count > 1);
        const targetList = duplicates.length > 0 ? duplicates : allSingers;
        const targetName = targetList[Math.floor(Math.random() * targetList.length)];

        scoutInv[targetName].count--;
        if(scoutInv[targetName].count <= 0) delete scoutInv[targetName];
        
        localStorage.setItem('v45_scout_'+myName, JSON.stringify(scoutInv));
        updateScoutUI();
        generateTask();
        alert(`å·²æ¶ˆè€—æ­Œæ‰‹ã€${targetName}ã€‘ï¼ˆå„ªå…ˆæ‰£é™¤é‡è¤‡è€…ï¼‰ï¼Œé‡æ–°æŠ½é¡Œï¼`);
    }

    function saveSingersAndDraw(){
        const rows = document.querySelectorAll('.entry-row');
        rows.forEach(row => {
            const name = row.querySelector('.singer-in').value.trim();
            const type = row.querySelector('.type-in').value;
            if(name){
                // å¦‚æœå·²ç¶“å­˜åœ¨ï¼Œå¢åŠ æ¬¡æ•¸ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œå»ºç«‹ä¸¦è¨˜éŒ„é¡å‹
                if(scoutInv[name]) {
                    scoutInv[name].count++;
                } else {
                    scoutInv[name] = { count: 1, type: type };
                }
                // æ­·å²è¨˜éŒ„å­˜æª” (æ ¼å¼ï¼šåç¨±|é¡å‹)
                const histItem = `${name}|${type}`;
                if(!totalHistory.includes(histItem)) totalHistory.push(histItem);
            }
        });
        localStorage.setItem('v45_scout_'+myName, JSON.stringify(scoutInv));
        localStorage.setItem('v45_history_'+myName, JSON.stringify(totalHistory));
        updateScoutUI(); updateHistoryTags();
        executeBatchDraw(currentTask ? currentTask.n : 1);
        document.getElementById('singer-inputs-container').innerHTML = `
            <div class="entry-row">
                <input type="text" class="singer-in" placeholder="æ­Œæ‰‹åç¨±">
                <select class="type-in"><option value="male">ç”·</option><option value="female">å¥³</option><option value="group">åœ˜é«”</option></select>
            </div>`;
    }

    function executeBatchDraw(count){
        const list=document.getElementById('draw-result-list'); list.innerHTML='';
        for(let i=0;i<count;i++){
            const id=getRandomCardId();
            inventory[id]=(inventory[id]||0)+1;
            const c=CARD_DATA[id];
            list.innerHTML+=`<div class="res-card ${c.rarity}">#${id}<br><span style="font-size:12px">${c.rarity}</span></div>`;
        }
        localStorage.setItem('v45_inv_'+myName, JSON.stringify(inventory));
        showPage('page-machine');
    }

    function updateScoutUI(){
        const maleList=document.getElementById('scout-male-list');
        const femaleList=document.getElementById('scout-female-list');
        const groupList=document.getElementById('scout-group-list');
        maleList.innerHTML=femaleList.innerHTML=groupList.innerHTML='';
        
        let totalCount = 0;
        for(let name in scoutInv){
            const data = scoutInv[name];
            if(data.count > 0){
                totalCount++;
                const tag = `<span class="singer-tag type-${data.type}">${name} x${data.count}</span>`;
                if(data.type === 'male') maleList.innerHTML += tag;
                else if(data.type === 'female') femaleList.innerHTML += tag;
                else groupList.innerHTML += tag;
            }
        }
        document.getElementById('scout-count').innerText = totalCount;
        const btn=document.getElementById('scout-draw-btn');
        if(totalCount>=10){
            btn.style.background="linear-gradient(45deg, #673ab7, #9c27b0)"; btn.style.color="#fff"; btn.style.pointerEvents="auto";
            btn.innerText="âœ¨ é ˜å–æ˜Ÿæ¢çå‹µ (å¯æŠ½2å¼µ)";
        } else {
            btn.style.background="#333"; btn.style.color="#888"; btn.style.pointerEvents="none"; btn.innerText="é ˜å–æ˜Ÿæ¢çå‹µ";
        }
    }

    function updateHistoryTags(){
        const con=document.getElementById('history-tags-container'); con.innerHTML='';
        totalHistory.forEach(item => {
            const [name, type] = item.split('|');
            let t=document.createElement('span');
            t.className=`history-tag type-${type}`;
            t.innerText=name;
            t.onclick=()=>{
                const rows = document.querySelectorAll('.entry-row');
                const lastRow = rows[rows.length-1];
                lastRow.querySelector('.singer-in').value = name;
                lastRow.querySelector('.type-in').value = type;
            };
            con.appendChild(t);
        });
    }

    function addInput(){
        const div=document.createElement('div'); div.className='entry-row';
        div.innerHTML = `<input type="text" class="singer-in" placeholder="æ­Œæ‰‹åç¨±">
                         <select class="type-in"><option value="male">ç”·</option><option value="female">å¥³</option><option value="group">åœ˜é«”</option></select>`;
        document.getElementById('singer-inputs-container').appendChild(div);
    }

    function scoutDrawReward(){
        let c=0;
        for(let n in scoutInv){ if(scoutInv[n].count > 0 && c < 10){ scoutInv[n].count--; c++; } }
        // æ¸…ç† count 0 çš„
        for(let n in scoutInv){ if(scoutInv[n].count <= 0) delete scoutInv[n]; }
        localStorage.setItem('v45_scout_'+myName, JSON.stringify(scoutInv));
        updateScoutUI(); executeBatchDraw(2);
    }

    // Collection & Modal Logic
    function openCollection(){
        showPage('page-collection'); const list=document.getElementById('coll-list'); list.innerHTML='';
        for(let i=1;i<=50;i++){
            const count=inventory[i]||0; const card=CARD_DATA[i];
            const cls = count > 0 ? `owned ${card.rarity}` : '';
            list.innerHTML+=`<div class="item-box ${cls}" onclick="useCard(${i})">#${i}<br>${count > 0 ? count+'å¼µ' : 'æœªæŒæœ‰'}</div>`;
        }
    }
    function useCard(id){
        if(!inventory[id]||inventory[id]<=0)return;
        selectedCid=id; const card=CARD_DATA[id];
        document.getElementById('modal').style.display='flex';
        document.getElementById('m-id').innerText='CARD ID #'+id;
        document.getElementById('m-rarity').innerText=card.rarity;
        document.getElementById('m-rarity').style.color=`var(--${card.rarity.toLowerCase()}-clr)`;
        document.getElementById('m-desc').innerText=card.desc;
        const isA=(card.type==="attack"||card.type==="steal");
        db.ref(`rooms/${myRoom}/players`).once('value',s=>{
            const opp=Object.keys(s.val()||{}).find(n=>n!==myName);
            document.getElementById('opp-action-area').style.display=(isA&&opp)?'block':'none';
            if(opp)document.getElementById('opp-list').innerHTML=`<button class="btn-main" onclick="finalCommit('${opp}')">ç„æº– ${opp} ç™¼å‹•</button>`;
            document.getElementById('use-btn').onclick=()=>finalCommit(null);
            document.getElementById('use-btn').style.display=isA?'none':'block';
        });
    }
    function finalCommit(target){
        const c=CARD_DATA[selectedCid]; inventory[selectedCid]--;
        localStorage.setItem('v45_inv_'+myName, JSON.stringify(inventory));
        db.ref(`rooms/${myRoom}/players/${myName}/score`).transaction(v=>(v||0)+c.score);
        if(c.type==="attack" && target) db.ref(`rooms/${myRoom}/players/${target}/score`).transaction(v=>(v||0)-1000);
        else if(c.type==="draw") {
            const rid = Math.floor(Math.random()*20)+31; inventory[rid]=(inventory[rid]||0)+1;
            localStorage.setItem('v45_inv_'+myName, JSON.stringify(inventory)); showSkillToast(`#${rid} [Rç´š]`);
        } else if(c.type==="steal" && target) {
            const rid = getRandomCardId(); inventory[rid]=(inventory[rid]||0)+1;
            localStorage.setItem('v45_inv_'+myName, JSON.stringify(inventory)); showSkillToast(`#${rid} [${CARD_DATA[rid].rarity}]`);
        }
        closeModal(); openCollection();
    }
    function showSkillToast(content){ document.getElementById('toast-card-info').innerText = content; document.getElementById('skill-toast').style.display = 'block'; }
    function closeToast(){ document.getElementById('skill-toast').style.display = 'none'; }
    function closeModal(){ document.getElementById('modal').style.display='none'; }
    function showPage(id){ document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active'); window.scrollTo(0,0); }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-Pop è’é›†æˆ° V67</title>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-database-compat.js"></script>
    <style>
        :root { 
            --bg-dark: #121212; 
            --card-bg: #1e1e1e;
            --accent: #ff4081;
            --highlight: #00e5ff;
            --gold: #ffd700;
            --male: #2196f3;
            --female: #ff4081;
            --group: #4caf50;
        }
        body { 
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; 
            background: var(--bg-dark); 
            color: white; margin: 0; text-align: center; min-height: 100vh; padding-bottom: 80px;
        }
        
        /* é ‚éƒ¨è³‡è¨Šåˆ— */
        .header { 
            background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(5px);
            padding: 10px 20px; border-bottom: 1px solid #333;
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
        }
        .player-info { text-align: left; }
        .score-display { font-size: 20px; font-weight: bold; color: var(--gold); }

        /* æŒ‰éˆ•ç³»çµ± */
        button { padding: 12px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; color: white; margin: 5px 0; }
        .btn-main { background: linear-gradient(45deg, #ff4081, #f50057); width: 100%; font-size: 18px; box-shadow: 0 4px 10px rgba(245,0,87,0.3); }
        .btn-task { background: linear-gradient(45deg, #2196f3, #00e5ff); width: 100%; height: 60px; font-size: 20px; box-shadow: 0 4px 10px rgba(33,150,243,0.3); }
        .btn-sec { background: #333; border: 1px solid #555; width: 100%; }
        .btn-book { background: linear-gradient(45deg, #673ab7, #9c27b0); width: 100%; font-size: 18px; margin-top: 10px; }
        .btn-add { background: #444; color: #aaa; width: auto; padding: 5px 15px; font-size: 12px; }
        
        /* æ­Œæ‰‹å…Œæ›æŒ‰éˆ• */
        .btn-singer-ex { 
            background: linear-gradient(45deg, #ffb300, #ff6f00); color: black; 
            width: 100%; margin-top: 15px; animation: pulse 1.5s infinite; 
            display: none; 
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* é é¢åˆ‡æ› */
        .page { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ä¸»é æ­Œæ‰‹åå†Šå±•ç¤º */
        .home-singer-section {
            background: #1a1a1a; border-radius: 12px; padding: 15px; 
            margin-bottom: 20px; border: 1px solid #333; text-align: left;
        }
        .singer-tags-container {
            display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; max-height: 200px; overflow-y: auto;
        }
        .tag-display {
            font-size: 12px; padding: 4px 8px; border-radius: 4px; 
            display: inline-flex; align-items: center; gap: 5px;
        }
        .tag-display.m { background: rgba(33, 150, 243, 0.2); color: var(--male); border: 1px solid var(--male); }
        .tag-display.f { background: rgba(255, 64, 129, 0.2); color: var(--female); border: 1px solid var(--female); }
        .tag-display.g { background: rgba(76, 175, 80, 0.2); color: var(--group); border: 1px solid var(--group); }

        /* æ­Œæ‰‹è¼¸å…¥åˆ— */
        .singer-input-row { 
            background: #1e1e1e; padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #333; 
            text-align: left;
        }
        .type-select { display: flex; gap: 5px; margin-bottom: 10px; }
        .type-opt { 
            flex: 1; padding: 10px; text-align: center; border-radius: 6px; font-size: 14px; cursor: pointer; border: 1px solid #444; color: #888; transition: 0.2s;
        }
        .type-opt.active.m { background: var(--male); color: white; border-color: var(--male); box-shadow: 0 0 8px var(--male); }
        .type-opt.active.f { background: var(--female); color: white; border-color: var(--female); box-shadow: 0 0 8px var(--female); }
        .type-opt.active.g { background: var(--group); color: white; border-color: var(--group); box-shadow: 0 0 8px var(--group); }

        .input-field { 
            width: 100%; padding: 12px; background: #111; border: 1px solid #444; color: white; border-radius: 5px; box-sizing: border-box; font-size: 16px;
        }

        /* çµ±ä¸€æ­·å²æ¨™ç±¤å€ */
        .history-tags-area {
            margin-top: 10px; display: flex; flex-wrap: wrap; gap: 6px; 
            background: #111; padding: 8px; border-radius: 8px;
        }
        .quick-tag { 
            font-size: 11px; padding: 4px 10px; border-radius: 15px; cursor: pointer; transition: 0.2s; 
            border: 1px solid #333; opacity: 0.8;
        }
        .quick-tag:hover { transform: scale(1.05); opacity: 1; }
        .quick-tag.t-m { color: var(--male); border-color: var(--male); background: rgba(33, 150, 243, 0.1); }
        .quick-tag.t-f { color: var(--female); border-color: var(--female); background: rgba(255, 64, 129, 0.1); }
        .quick-tag.t-g { color: var(--group); border-color: var(--group); background: rgba(76, 175, 80, 0.1); }

        /* è’é›†å†Š */
        .group-section { background: #1e1e1e; border-radius: 12px; margin-bottom: 20px; padding: 15px; border: 1px solid #333; text-align: left; }
        .group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 8px; }
        .group-name { font-size: 18px; font-weight: bold; }
        .group-complete { border: 2px solid var(--gold); box-shadow: 0 0 10px rgba(255, 215, 0, 0.2); }
        
        .member-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .member-card { 
            background: #111; border-radius: 8px; padding: 5px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 90px; border: 1px solid #333; opacity: 0.4; cursor: default;
        }
        .member-card.owned { opacity: 1; border-color: var(--accent); cursor: pointer; transition: transform 0.1s; }
        .member-card.owned:active { transform: scale(0.95); }
        
        .card-thumb {
            width: 50px; height: 50px; border-radius: 5px; background: #333; margin-bottom: 5px; object-fit: cover;
        }

        /* Modal */
        #draw-modal, #card-view-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; justify-content: center; align-items: center; z-index: 500; }
        
        /* å¡ç‰‡å¤§åœ–æª¢è¦– */
        .card-view-content {
            background: #222; border: 2px solid var(--accent); border-radius: 15px; padding: 20px; 
            width: 90%; max-width: 320px; text-align: center; position: relative;
            box-shadow: 0 0 30px rgba(255, 64, 129, 0.3);
        }
        .card-big-img {
            width: 100%; aspect-ratio: 3/4; object-fit: cover; border-radius: 10px; margin-bottom: 15px; background: #000;
        }
        .card-big-name { font-size: 24px; font-weight: bold; color: white; margin-bottom: 5px; }
        .card-big-group { font-size: 14px; color: var(--highlight); margin-bottom: 15px; }

        .task-box { border: 1px solid var(--highlight); border-radius: 12px; padding: 20px; margin-bottom: 20px; background: rgba(0, 229, 255, 0.05); }
        .toast { position: fixed; top: 20%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; z-index: 1000; display: none; }
    </style>
</head>
<body>

<div id="toast" class="toast"></div>

<div class="header" id="ui-header" style="display:none;">
    <div class="player-info">
        <div id="display-name" style="color:var(--highlight); font-weight:bold;"></div>
        <div style="font-size:10px; color:#888;">ROOM: <span id="display-room"></span></div>
    </div>
    <div style="text-align: right;">
        <div class="score-display" id="total-groups-completed">0 ğŸ‘‘</div>
    </div>
</div>

<div id="page-login" class="page active">
    <h1 style="color:var(--accent);">K-Pop è’é›†æˆ° V67</h1>
    <p style="color:#888; font-size:12px;">ç¶“å…¸äºŒä»£åœ˜ â€¢ åœ–ç‰‡è·¯å¾‘å„ªåŒ–</p>
    <input type="text" id="inName" placeholder="ä½ çš„æš±ç¨±" style="width:80%; padding:15px; background:#222; border:1px solid #444; color:white; border-radius:8px; margin-bottom:10px;">
    <input type="text" id="inRoom" placeholder="æˆ¿é–“è™Ÿç¢¼" style="width:80%; padding:15px; background:#222; border:1px solid #444; color:white; border-radius:8px; margin-bottom:20px;">
    <button class="btn-main" onclick="initGame()">é–‹å§‹æŒ‘æˆ°</button>
</div>

<div id="page-home" class="page">
    <div class="home-singer-section">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <strong>ğŸ¤ å·²è’é›†æ­Œæ‰‹åå†Š</strong>
            <span style="font-size:12px; color:#aaa;" id="unique-singer-count">0 ä½ä¸é‡è¤‡</span>
        </div>
        <div id="home-singer-list" class="singer-tags-container"></div>
        <button id="btn-singer-exchange" class="btn-singer-ex" onclick="redeemSingers()">
            ğŸ æ¶ˆè€— 10 ä½ä¸é‡è¤‡æ­Œæ‰‹<br>å…Œæ› 2 å¼µå¥³åœ˜å¡ç‰‡
        </button>
    </div>

    <button class="btn-task" onclick="startTask()">ğŸ¤ æŠ½å–æŒ‘æˆ°ä»»å‹™</button>
    <button class="btn-book" onclick="showPage('page-book')">ğŸ“• é–‹å•Ÿæˆå“¡è’é›†å†Š</button>
    
    <div style="margin: 20px 0;">
        <button class="btn-sec" onclick="toggleExchangeMode()" id="btn-exchange-toggle">â™»ï¸ 5æ›1 ä¿åº•å…Œæ›æ¨¡å¼</button>
        <button class="btn-sec" onclick="location.reload()" style="margin-top:10px;">ç™»å‡ºç³»çµ±</button>
    </div>

    <div id="ranking-box" style="padding:15px; background:#111; border-radius:12px; font-size:13px; text-align:left;">
        <strong style="color:var(--highlight);">ğŸ“Š æˆ¿é–“ç©å®¶é€²åº¦ï¼š</strong>
        <div id="ranking-list" style="margin-top:10px;"></div>
    </div>
</div>

<div id="page-challenge" class="page">
    <h2 style="color:var(--highlight);">æŒ‘æˆ°ä»»å‹™</h2>
    <div class="task-box">
        <div id="task-desc" style="font-size:24px; font-weight:bold; margin-bottom:10px;"></div>
        <div id="task-extra" style="font-size:28px; color:var(--gold); font-weight:900;"></div>
        <p id="task-reward" style="color:#aaa;"></p>
    </div>
    <button class="btn-main" onclick="goToSettlement()">âœ… æŒ‘æˆ°æˆåŠŸ (å‰å¾€ç™»éŒ„)</button>
    <button class="btn-sec" onclick="rerollTask()">ğŸ² æ¶ˆè€—1ä½éš¨æ©Ÿæ­Œæ‰‹é‡æŠ½</button>
    <button class="btn-sec" onclick="showPage('page-home')">æ”¾æ£„è¿”å›</button>
</div>

<div id="page-settle" class="page">
    <h2 style="color:var(--group);">æ­Œæ‰‹ç™»éŒ„çµç®—</h2>
    <p style="color:#888; font-size:14px;">é»æ“Šä¸‹æ–¹æ¨™ç±¤å¯å¿«é€Ÿè¼¸å…¥</p>
    
    <div id="singer-input-container"></div>

    <button class="btn-add" onclick="addSingerInputRow()">ï¼‹ æ–°å¢æ¼”å”±æ­Œæ‰‹ (åˆå”±)</button>
    
    <div style="margin-top:30px;">
        <button class="btn-main" style="background:var(--group);" onclick="finalizeSettlement()">ç¢ºèªç™»éŒ„ä¸¦æŠ½å¡</button>
    </div>
</div>

<div id="page-book" class="page">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0;">æˆå“¡è’é›†å†Š</h2>
        <button class="btn-sec" style="width:auto;" onclick="showPage('page-home')">è¿”å›</button>
    </div>
    <div id="collection-container">
        </div>
</div>

<div id="draw-modal">
    <div style="text-align:center;">
        <h2 style="color:var(--gold);">âœ¨ ç²å¾—æˆå“¡å¡ç‰‡ï¼</h2>
        <div id="draw-results" style="display:flex; flex-wrap:wrap; justify-content:center;"></div>
        <button class="btn-main" style="margin-top:20px; width:200px;" onclick="closeDrawModal()">æ”¶é€²å£è¢‹</button>
    </div>
</div>

<div id="card-view-modal" onclick="closeCardView()">
    <div class="card-view-content" onclick="event.stopPropagation()">
        <img id="view-img" class="card-big-img" src="" alt="Card Image">
        <div id="view-name" class="card-big-name"></div>
        <div id="view-group" class="card-big-group"></div>
        <button class="btn-sec" onclick="closeCardView()">é—œé–‰</button>
    </div>
</div>

<script>
// ==================== è³‡æ–™åº« ====================
// V67 æ–°å¢: 4minute, After School, f(x), KARA, Miss A, SISTAR, T-ara
const GIRL_GROUPS = {
    "BLACKPINK": ["Jisoo", "Jennie", "RosÃ©", "Lisa"],
    "aespa": ["Karina", "Giselle", "Winter", "Ningning"],
    "IVE": ["Yujin", "Gaeul", "Rei", "Wonyoung", "Liz", "Leeseo"],
    "NewJeans": ["Minji", "Hanni", "Danielle", "Haerin", "Hyein"],
    "ITZY": ["Yeji", "Lia", "Ryujin", "Chaeryeong", "Yuna"],
    "LE SSERAFIM": ["Chaewon", "Sakura", "Yunjin", "Kazuha", "Eunchae"],
    "(G)I-DLE": ["Miyeon", "Minnie", "Soyeon", "Yuqi", "Shuhua"],
    "NMIXX": ["Haewon", "Lily", "Sullyoon", "Bae", "Jiwoo", "Kyujin"],
    "BabyMonster": ["Ruka", "Pharita", "Asa", "Ahyeon", "Rami", "Rora", "Chiquita"],
    "TWICE": ["Nayeon", "Jeongyeon", "Momo", "Sana", "Jihyo", "Mina", "Dahyun", "Chaeyoung", "Tzuyu"],
    "ILLIT": ["Yunah", "Minju", "Moka", "Wonhee", "Iroha"],
    "Red Velvet": ["Irene", "Seulgi", "Wendy", "Joy", "Yeri"],
    "MEOVV": ["Sooin", "Gawon", "Anna", "Narin", "Ella"],
    "QWER": ["Chodan", "Magenta", "Hina", "Siyeon"],
    "IZ*ONE": ["Eunbi", "Sakura", "Hyewon", "Yena", "Chaeyeon", "Chaewon", "Minju", "Nako", "Hitomi", "Yuri", "Yujin", "Wonyoung"],
    "Gfriend": ["Sowon", "Yerin", "Eunha", "Yuju", "SinB", "Umji"],
    "EXID": ["Solji", "LE", "Hani", "Hyelin", "Jeonghwa"],
    "Girls' Generation": ["Taeyeon", "Sunny", "Tiffany", "Hyoyeon", "Yuri", "Sooyoung", "Yoona", "Seohyun"],
    "tripleS": ["SeoYeon", "HyeRin", "JiWoo", "ChaeYeon", "YooYeon", "SooMin", "NaKyoung", "YuBin", "Kaede", "DaHyun", "Kotone", "YeonJi", "Nien", "SoHyun", "Xinyu", "Mayu", "Lynn", "JooBin", "Hayeon", "Shion", "ChaeWon", "Sullin", "SeoAh", "JiYeon"],
    "fromis_9": ["Saerom", "Hayoung", "Gyuri", "Jiwon", "Jisun", "Seoyeon", "Chaeyoung", "Nagyung", "Jiheon"],
    "FIFTY FIFTY": ["Keena", "Chanelle", "Yewon", "Hana", "Athena"],
    "KISS OF LIFE": ["Julie", "Natty", "Belle", "Haneul"],
    "STAYC": ["Sumin", "Sieun", "Isa", "Seeun", "Yoon", "J"],
    "APINK": ["Chorong", "Bomi", "Eunji", "Naeun", "Namjoo", "Hayoung"],
    "MAMAMOO": ["Solar", "Moonbyul", "Wheein", "Hwasa"],
    "CLC": ["Seunghee", "Yujin", "Seungyeon", "Sorn", "Yeeun", "Elkie", "Eunbin"],
    "AOA": ["Choa", "Jimin", "Yuna", "Hyejeong", "Mina", "Seolhyun", "Chanmi"],
    "2NE1": ["Bom", "Dara", "CL", "Minzy"],
    // === æ–°å¢ V67 ===
    "4minute": ["Jihyun", "Gayoon", "Jiyoon", "Hyuna", "Sohyun"],
    "After School": ["Kahi", "Jungah", "Soyoung", "Juyeon", "Uee", "Bekah", "Raina", "Nana", "Lizzy", "E-Young", "Kaeun"],
    "f(x)": ["Victoria", "Amber", "Luna", "Krystal", "Sulli"],
    "KARA": ["Gyuri", "Seungyeon", "Hara", "Nicole", "Jiyoung", "Youngji"],
    "Miss A": ["Fei", "Jia", "Min", "Suzy"],
    "SISTAR": ["Hyolyn", "Bora", "Soyou", "Dasom"],
    "T-ara": ["Boram", "Qri", "Soyeon", "Eunjung", "Hyomin", "Jiyeon"],
    // ================
    "hearts2hearts": ["Member A", "Member B", "Member C", "Member D"], 
    "KiiiKii": ["Member 1", "Member 2", "Member 3", "Member 4"]
};

const TASKS = [
    {t:"å”±ä¸€ä½ã€å¥³æ­Œæ‰‹ã€‘çš„æ­Œ", n:1}, {t:"å”±ä¸€ä½ã€ç”·æ­Œæ‰‹ã€‘çš„æ­Œ", n:1}, {t:"å”±ä¸€å€‹ã€åœ˜é«”ã€‘çš„æ­Œ", n:1},
    {t:"æ­Œåè¦æœ‰æ•¸å­—ï¼š", n:2, v:"num"}, {t:"æ­Œæ›²ã€éä¸­æ–‡ã€‘", n:2}, {t:"æ­Œåã€éä¸­æ–‡ã€‘", n:2},
    {t:"ä¸Šä¸€é¦–æ­Œå­—å°¾ã€æ³¨éŸ³ã€‘æ¥é¾", n:2, v:"zy"}, {t:"å”±ã€ä¸Šä¸€å€‹äººå”±çš„æ­Œæ‰‹ã€‘", n:3},
    {t:"æ­Œåã€5-6å€‹å­—ã€‘", n:3}, {t:"æ­Œåã€1-2å€‹å­—ã€‘", n:3}, {t:"ã€é»˜èƒŒã€‘æ•´é¦–æ­Œ (ä¸çœ‹æ­Œè©)", n:4},
    {t:"ã€åˆå”±ã€‘ä¸€é¦–æ­Œ", n:4}, {t:"ğŸµ çŒœæ­ŒæŒ‘æˆ°", n:3, v:"lyric"}
];

const LYRICS = [
    {q:"å¤©ç°ç° æœƒä¸æœƒ è®“æˆ‘å¿˜äº†ä½ æ˜¯èª°", a:"ä¸–ç•Œæœ«æ—¥"}, {q:"æ„›ä½ å­¤èº«èµ°æš—å·· æ„›ä½ ä¸è·ªçš„æ¨¡æ¨£", a:"å­¤å‹‡è€…"},
    {q:"Super Lady! (I got a superpower)", a:"Super Lady"}, {q:"Queencard I'm hot, My boob and booty is hot", a:"Queencard"}
];

// ==================== ç‹€æ…‹èˆ‡åˆå§‹åŒ– ====================
let myName = "", myRoom = "", collection = {}, singers = { m: [], f: [], g: [] }, currentTask = null, isExchangeMode = false;

const firebaseConfig = { apiKey: "AIzaSyBjYdhxIQ_LGoNHiAkygjkIqWsb8NgF0s8", authDomain: "ktv-game.firebaseapp.com", databaseURL: "https://ktv-game-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "ktv-game", storageBucket: "ktv-game.firebasestorage.app", messagingSenderId: "903538372328", appId: "1:903538372328:web:2456e55fcd41f0899f635d" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function initGame() {
    myName = document.getElementById('inName').value.trim();
    myRoom = document.getElementById('inRoom').value.trim();
    if (!myName || !myRoom) return alert("è«‹å¡«å¯«è³‡è¨Š");

    collection = JSON.parse(localStorage.getItem(`v67_col_${myName}`)) || {};
    singers = JSON.parse(localStorage.getItem(`v67_sin_${myName}`)) || { m: [], f: [], g: [] };

    document.getElementById('display-name').innerText = myName;
    document.getElementById('display-room').innerText = myRoom;
    document.getElementById('ui-header').style.display = 'flex';

    db.ref(`rooms/${myRoom}/players/${myName}`).update({ name: myName, lastActive: Date.now() });
    db.ref(`rooms/${myRoom}/players`).on('value', snap => updateRanking(snap.val()));

    renderCollection(); 
    showPage('page-home');
    syncData();
}

function syncData() {
    let comp = 0;
    for(let g in GIRL_GROUPS) if(GIRL_GROUPS[g].every(m => collection[`${g}_${m}`])) comp++;
    
    const uniqueCount = getUniqueSingerCount();
    document.getElementById('total-groups-completed').innerText = `${comp} ğŸ‘‘`;
    document.getElementById('unique-singer-count').innerText = `${uniqueCount} ä½ä¸é‡è¤‡`;

    const exBtn = document.getElementById('btn-singer-exchange');
    exBtn.style.display = uniqueCount >= 10 ? 'block' : 'none';

    renderHomeSingers();

    db.ref(`rooms/${myRoom}/players/${myName}`).update({ completedGroups: comp, cardCount: Object.values(collection).reduce((a,b)=>a+b, 0) });
    localStorage.setItem(`v67_col_${myName}`, JSON.stringify(collection));
    localStorage.setItem(`v67_sin_${myName}`, JSON.stringify(singers));
    
    // åŒæ­¥åˆ·æ–°è’é›†å†Š
    renderCollection();
}

function renderHomeSingers() {
    const list = document.getElementById('home-singer-list');
    list.innerHTML = "";
    const counts = {};
    ['m', 'f', 'g'].forEach(type => {
        singers[type].forEach(name => {
            if(!counts[name]) counts[name] = { type: type, count: 0 };
            counts[name].count++;
        });
    });
    for(let name in counts) {
        const item = counts[name];
        list.innerHTML += `<div class="tag-display ${item.type}">${name} x${item.count}</div>`;
    }
}

function getUniqueSingerCount() {
    const s = new Set([...singers.m, ...singers.f, ...singers.g]);
    return s.size;
}

// ==================== ä»»å‹™æµç¨‹ ====================
function startTask() {
    const t = TASKS[Math.floor(Math.random() * TASKS.length)];
    let extra = "";
    if(t.v === "num") extra = Math.floor(Math.random() * 10);
    else if(t.v === "zy") extra = "ã„…ã„†ã„‡ã„ˆã„‰ã„Šã„‹ã„Œã„ã„ã„ã„ã„‘ã„’ã„“ã„”ã„•ã„–ã„—ã„˜ã„™ã„§ã„¨ã„©ã„šã„›ã„œã„ã„ã„Ÿã„ ã„¡ã„¢ã„£ã„¤ã„¥ã„¦"[Math.floor(Math.random()*37)];
    else if(t.v === "lyric") { const l = LYRICS[Math.floor(Math.random()*LYRICS.length)]; extra = `"${l.q}"`; t.ans = l.a; }

    currentTask = { ...t, extra };
    document.getElementById('task-desc').innerText = t.t;
    document.getElementById('task-extra').innerText = extra;
    document.getElementById('task-reward').innerText = `çå‹µï¼š${t.n} å¼µå¡ç‰‡`;
    showPage('page-challenge');
}

function rerollTask() {
    const all = [...singers.m, ...singers.f, ...singers.g];
    if(all.length < 1) return alert("æ²’æœ‰æ­Œæ‰‹å¯ä»¥æ¶ˆè€—");
    const rand = Math.floor(Math.random() * all.length);
    const target = all[rand];
    
    if(singers.m.includes(target)) { singers.m.splice(singers.m.indexOf(target), 1); }
    else if(singers.f.includes(target)) { singers.f.splice(singers.f.indexOf(target), 1); }
    else if(singers.g.includes(target)) { singers.g.splice(singers.g.indexOf(target), 1); }
    
    syncData();
    showToast(`æ¶ˆè€—äº† 1 æ¬¡ ${target}`);
    startTask();
}

function redeemSingers() {
    const uniqueNames = [...new Set([...singers.m, ...singers.f, ...singers.g])];
    if(uniqueNames.length < 10) return;
    if(!confirm("ç¢ºå®šè¦æ¶ˆè€— 10 ä½ä¸åŒæ­Œæ‰‹çš„è¨ˆæ•¸ï¼Œæ›å– 2 å¼µå¡ç‰‡å—ï¼Ÿ")) return;
    
    uniqueNames.slice(0, 10).forEach(name => {
        if(singers.m.includes(name)) singers.m.splice(singers.m.indexOf(name), 1);
        else if(singers.f.includes(name)) singers.f.splice(singers.f.indexOf(name), 1);
        else if(singers.g.includes(name)) singers.g.splice(singers.g.indexOf(name), 1);
    });

    syncData();
    drawCards(2);
    showToast("å…Œæ›æˆåŠŸï¼");
}

function goToSettlement() {
    if(currentTask.v === "lyric") {
        const a = prompt("è«‹è¼¸å…¥æ­Œåï¼š");
        if(!a || !a.includes(currentTask.ans)) return alert("ç­”æ¡ˆéŒ¯èª¤");
    }
    document.getElementById('singer-input-container').innerHTML = "";
    addSingerInputRow();
    showPage('page-settle');
}

// ==================== æ­Œæ‰‹ç™»éŒ„çµç®— (æ™ºæ…§æ¨™ç±¤) ====================
function addSingerInputRow() {
    const container = document.getElementById('singer-input-container');
    const rowId = Date.now() + Math.random().toString(36).substr(2, 5);
    const div = document.createElement('div');
    div.className = "singer-input-row";
    div.id = `row-${rowId}`;
    div.dataset.type = "m"; 

    div.innerHTML = `
        <div class="type-select">
            <div id="btn-m-${rowId}" class="type-opt m active" onclick="setRowType('${rowId}', 'm')">ç”·</div>
            <div id="btn-f-${rowId}" class="type-opt f" onclick="setRowType('${rowId}', 'f')">å¥³</div>
            <div id="btn-g-${rowId}" class="type-opt g" onclick="setRowType('${rowId}', 'g')">åœ˜é«”</div>
        </div>
        <input type="text" class="input-field" placeholder="è¼¸å…¥æ­Œæ‰‹åç¨±..." id="input-${rowId}">
        <div class="history-tags-area" id="tags-${rowId}"></div>
    `;
    container.appendChild(div);
    renderAllHistoryTags(rowId);
}

function renderAllHistoryTags(rowId) {
    const container = document.getElementById(`tags-${rowId}`);
    container.innerHTML = "";

    const allTags = [];
    singers.m.forEach(n => allTags.push({name:n, type:'m'}));
    singers.f.forEach(n => allTags.push({name:n, type:'f'}));
    singers.g.forEach(n => allTags.push({name:n, type:'g'}));
    
    const uniqueTags = [];
    const seen = new Set();
    allTags.forEach(t => {
        if(!seen.has(t.name)) {
            uniqueTags.push(t);
            seen.add(t.name);
        }
    });

    uniqueTags.slice(0, 20).forEach(tag => {
        const span = document.createElement('span');
        span.className = `quick-tag t-${tag.type}`;
        span.innerText = tag.name;
        span.onclick = () => {
            document.getElementById(`input-${rowId}`).value = tag.name;
            setRowType(rowId, tag.type);
        };
        container.appendChild(span);
    });
}

window.setRowType = function(rowId, type) {
    const row = document.getElementById(`row-${rowId}`);
    if(!row) return;
    row.dataset.type = type;
    row.querySelector('.type-opt.m').classList.remove('active');
    row.querySelector('.type-opt.f').classList.remove('active');
    row.querySelector('.type-opt.g').classList.remove('active');
    row.querySelector(`.type-opt.${type}`).classList.add('active');
};

function finalizeSettlement() {
    const rows = document.querySelectorAll('.singer-input-row');
    let addedAny = false;
    rows.forEach(row => {
        const name = row.querySelector('input').value.trim();
        const type = row.dataset.type;
        if(name) {
            singers[type].push(name);
            addedAny = true;
        }
    });
    if(!addedAny) return alert("è«‹è‡³å°‘è¼¸å…¥ä¸€ä½æ­Œæ‰‹");
    drawCards(currentTask.n);
    syncData();
}

// ==================== åœ–ç‰‡è™•ç† (V67 å„ªåŒ–ç‰ˆ) ====================
function getCardImage(group, member) {
    // æª”åè¦å‰‡ï¼š
    // 1. ç§»é™¤ç‰¹æ®Šå­—å…ƒ (æ‹¬è™Ÿã€æ˜Ÿæ˜Ÿç­‰) => replace(/[\*\(\)]/g, '')
    // 2. ç©ºæ ¼è½‰åº•ç·š => replace(/ /g, '_')
    // ç¯„ä¾‹: "f(x)" -> "fx", "IZ*ONE" -> "IZONE"
    const safeGroup = group.replace(/ /g, '_').replace(/[\*\(\)]/g, '');
    const safeMember = member.replace(/ /g, '_');
    
    return `./images/${safeGroup}_${safeMember}.jpg`;
}

// åœ–ç‰‡é˜²å‘†
function handleImgError(img, g, m) {
    img.onerror = null;
    img.src = `https://placehold.co/400x600/1e1e1e/FFF?text=${g}%0A${m}&font=roboto`;
}

function drawCards(count, isEx = false) {
    const pool = [];
    for(let g in GIRL_GROUPS) {
        if(!GIRL_GROUPS[g].every(m => collection[`${g}_${m}`])) {
            GIRL_GROUPS[g].forEach(m => pool.push({g, m, k:`${g}_${m}`}));
        }
    }
    if(pool.length === 0) return alert("å·²é›†æ»¿å…¨é«”ï¼");

    const resDiv = document.getElementById('draw-results');
    resDiv.innerHTML = "";

    for(let i=0; i<count; i++) {
        let p;
        if(isEx) {
            const unowned = pool.filter(x => !collection[x.k]);
            p = unowned.length > 0 ? unowned[Math.floor(Math.random()*unowned.length)] : pool[0];
        } else {
            p = pool[Math.floor(Math.random()*pool.length)];
        }
        collection[p.k] = (collection[p.k] || 0) + 1;
        
        const imgUrl = getCardImage(p.g, p.m);
        resDiv.innerHTML += `
            <div style="margin:5px; animation: popIn 0.5s;">
                <img src="${imgUrl}" onerror="handleImgError(this, '${p.g}', '${p.m}')" style="width:100px; height:140px; border-radius:8px; object-fit:cover; border:2px solid white;">
                <div style="font-size:12px; margin-top:5px;">${p.m}</div>
            </div>
        `;
    }
    document.getElementById('draw-modal').style.display = 'flex';
}

function renderCollection() {
    const container = document.getElementById('collection-container');
    if(!container) return;
    container.innerHTML = "";
    
    // æŒ‰ç…§åŠ å…¥é †åºæˆ–åç¨±æ’åºé¡¯ç¤º
    for(let g in GIRL_GROUPS) {
        const isComp = GIRL_GROUPS[g].every(m => collection[`${g}_${m}`]);
        const sec = document.createElement('div');
        sec.className = `group-section ${isComp?'group-complete':''}`;
        sec.innerHTML = `<div class="group-header"><div class="group-name">${g} ${isComp?'ğŸ‘‘':''}</div></div>`;
        
        const grid = document.createElement('div');
        grid.className = "member-grid";
        
        GIRL_GROUPS[g].forEach(m => {
            const num = collection[`${g}_${m}`] || 0;
            const imgUrl = getCardImage(g, m);
            
            const card = document.createElement('div');
            card.className = `member-card ${num?'owned':''}`;
            if(isExchangeMode && num>=5) card.style.borderColor = "var(--gold)";
            
            card.innerHTML = `
                <img src="${imgUrl}" class="card-thumb" onerror="handleImgError(this, '${g}', '${m}')" style="opacity:${num?1:0.3}">
                <div class="member-name">${num ? m : '?'}</div>
                ${num ? `<div class="member-count">x${num}</div>` : ''}
            `;
            
            card.onclick = () => { 
                if(isExchangeMode && num>=5) exchangeCard(g, m); 
                else if(num > 0) openCardView(g, m);
            };
            grid.appendChild(card);
        });
        sec.appendChild(grid);
        container.appendChild(sec);
    }
}

function openCardView(group, member) {
    const img = document.getElementById('view-img');
    img.src = getCardImage(group, member);
    img.onerror = () => handleImgError(img, group, member);
    
    document.getElementById('view-name').innerText = member;
    document.getElementById('view-group').innerText = group;
    document.getElementById('card-view-modal').style.display = 'flex';
}

function closeCardView() { document.getElementById('card-view-modal').style.display = 'none'; }

function exchangeCard(g, m) {
    if(!confirm(`æ¶ˆè€— 5 å¼µ ${m} æ›å– 1 å¼µæœªæ“æœ‰å¡ç‰‡ï¼Ÿ`)) return;
    collection[`${g}_${m}`] -= 5;
    drawCards(1, true);
    syncData();
}

function toggleExchangeMode() {
    isExchangeMode = !isExchangeMode;
    document.getElementById('btn-exchange-toggle').innerText = isExchangeMode ? "é€€å‡ºå…Œæ›æ¨¡å¼" : "â™»ï¸ 5æ›1 ä¿åº•å…Œæ›æ¨¡å¼";
    renderCollection();
}

function updateRanking(data) {
    const list = document.getElementById('ranking-list');
    list.innerHTML = "";
    Object.values(data || {}).sort((a,b)=>b.completedGroups - a.completedGroups).forEach((p, i) => {
        list.innerHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>${i+1}. ${p.name}</span><span>${p.completedGroups} ğŸ‘‘ / ${p.cardCount}å¼µ</span></div>`;
    });
}

function showToast(msg) {
    const t = document.getElementById('toast');
    t.innerText = msg;
    t.style.display = 'block';
    setTimeout(() => t.style.display = 'none', 2000);
}

function showPage(id) { 
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); 
    document.getElementById(id).classList.add('active'); 
    window.scrollTo(0,0);
    if(id === 'page-book') renderCollection(); 
}
function closeDrawModal() { document.getElementById('draw-modal').style.display = 'none'; showPage('page-home'); }
</script>
</body>
</html>
